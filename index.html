<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مسابقة أعضاء جروب المشتركين للتدريب</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      body {
        font-family: Tahoma, sans-serif;
        margin: 0;
        background: #f9f9f9;
        text-align: center;
      }
      header {
        background: #007bff;
        color: white;
        padding: 20px;
        font-size: 22px;
      }
      .container {
        padding: 20px;
        max-width: 600px;
        margin: auto;
      }
      input,
      button,
      select {
        padding: 10px;
        margin: 5px;
        font-size: 16px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      #adminPanel {
        display: none;
        padding: 10px;
        background: #eee;
        border-radius: 10px;
        margin: 20px 0;
      }
      #questions,
      #waitingScreen,
      #winnerScreen {
        display: none;
      }
      #leaderboard {
        margin-top: 20px;
        background: #fff;
        padding: 10px;
        border-radius: 8px;
      }
      .lock {
        position: fixed;
        bottom: 20px;
        right: 20px;
        font-size: 28px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>مسابقة أعضاء جروب المشتركين للتدريب</header>

    <div class="container">
      <div id="welcomeScreen">
        <h2>أهلاً بكم في المسابقة!</h2>
        <h3 id="topicLabel"></h3>
        <input type="text" id="playerName" placeholder="اكتب اسمك" />
        <button onclick="joinGame()">المشاركة</button>
      </div>

      <div id="waitingScreen">
        <h2>لقد أنهيت أسئلتك ✅</h2>
        <p>من فضلك انتظر باقي زملائك...</p>
      </div>

      <div id="questions"></div>

      <div id="leaderboard">
        <h3>الترتيب المباشر</h3>
        <ul id="ranking"></ul>
      </div>

      <div id="winnerScreen">
        <h2 id="winnerMsg"></h2>
      </div>

      <div id="adminPanel">
        <h3>لوحة التحكم</h3>
        <label>حدد المحور:</label>
        <select id="topicSelect">
          <option value="حاسب">حاسب</option>
          <option value="إنجليزي">إنجليزي</option>
          <option value="عام">عام</option></select
        ><br />
        <button onclick="startCompetition()">بدء المسابقة</button>
        <button onclick="closeAdmin()">إغلاق</button>
        <p>
          الحالة الحالية: <span id="gameStatus">في انتظار بدء المسابقة</span>
        </p>
      </div>
    </div>

    <div class="lock" onclick="openAdminLogin()">🔒</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        update,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

      // إعداد Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.appspot.com",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let playerName = "";
      let playerScore = 0;
      let currentQuestion = 0;
      const questions = [
        { q: "2 + 2 = ?", options: ["3", "4", "5"], correct: 1 },
        {
          q: "عاصمة مصر؟",
          options: ["القاهرة", "الرياض", "الخرطوم"],
          correct: 0,
        },
        {
          q: "HTML تستخدم في؟",
          options: ["الطبخ", "البرمجة", "الرسم"],
          correct: 1,
        },
      ];

      // دخول مشارك
      window.joinGame = async function () {
        playerName = document.getElementById("playerName").value.trim();
        if (!playerName) return alert("من فضلك اكتب اسمك");
        await set(ref(db, "players/" + playerName), {
          score: 0,
          finished: false,
        });
        document.getElementById("welcomeScreen").style.display = "none";
        showQuestion();
      };

      // عرض الأسئلة
      function showQuestion() {
        if (currentQuestion >= questions.length) {
          update(ref(db, "players/" + playerName), {
            score: playerScore,
            finished: true,
          });
          document.getElementById("questions").style.display = "none";
          document.getElementById("waitingScreen").style.display = "block";
          checkAllFinished();
          return;
        }
        let q = questions[currentQuestion];
        let html = `<h3>${q.q}</h3>`;
        q.options.forEach((opt, i) => {
          html += `<button onclick="answer(${i})">${opt}</button><br>`;
        });
        document.getElementById("questions").innerHTML = html;
        document.getElementById("questions").style.display = "block";
      }

      // الإجابة
      window.answer = function (i) {
        if (i === questions[currentQuestion].correct) playerScore++;
        currentQuestion++;
        showQuestion();
      };

      // متابعة الترتيب
      const rankingRef = ref(db, "players");
      onValue(rankingRef, (snap) => {
        const data = snap.val() || {};
        let arr = Object.entries(data).map(([name, v]) => ({
          name,
          score: v.score,
        }));
        arr.sort((a, b) => b.score - a.score);
        document.getElementById("ranking").innerHTML = arr
          .map((p) => `<li>${p.name}: ${p.score}</li>`)
          .join("");
      });

      // لو كلهم خلصوا
      function checkAllFinished() {
        get(rankingRef).then((snap) => {
          const data = snap.val() || {};
          if (
            Object.values(data).length &&
            Object.values(data).every((p) => p.finished)
          ) {
            update(ref(db, "game"), { status: "ended" });
            showWinner(data);
          }
        });
      }

      // إعلان الفائز
      function showWinner(data) {
        let arr = Object.entries(data).map(([n, v]) => ({
          name: n,
          score: v.score,
        }));
        arr.sort((a, b) => b.score - a.score);
        let top = arr[0];
        document.getElementById(
          "winnerMsg"
        ).innerText = `🎉 الفائز هو ${top.name} بدرجة ${top.score}!`;
        document.getElementById("winnerScreen").style.display = "block";
        confetti();
        setTimeout(() => location.reload(), 10000); // بعد 10 ثواني يرجع للصفحة الأولى
      }

      // لوحة الأدمن
      window.openAdminLogin = function () {
        let pass = prompt("ادخل كلمة السر:");
        if (pass === "admin123") {
          document.getElementById("adminPanel").style.display = "block";
        }
      };
      window.closeAdmin = function () {
        document.getElementById("adminPanel").style.display = "none";
      };
      window.startCompetition = function () {
        let topic = document.getElementById("topicSelect").value;
        set(ref(db, "game"), { status: "running", topic });
        document.getElementById("gameStatus").innerText = "المسابقة جارية";
        document.getElementById("topicLabel").innerText = "المسابقة: " + topic;
      };

      // متابعة حالة اللعبة
      const gameRef = ref(db, "game");
      onValue(gameRef, (snap) => {
        let g = snap.val();
        if (!g) return;
        let status = g.status;
        if (status === "waiting")
          document.getElementById("gameStatus").innerText =
            "في انتظار بدء المسابقة";
        if (status === "running")
          document.getElementById("gameStatus").innerText = "المسابقة جارية";
        if (status === "ended")
          document.getElementById("gameStatus").innerText = "انتهت المسابقة";
        if (g.topic)
          document.getElementById("topicLabel").innerText =
            "المسابقة: " + g.topic;
      });
    </script>
  </body>
</html>
