<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background: #f8f9fa;
        margin: 0;
        text-align: center;
      }
      #container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      #quizScreen,
      #waitingScreen,
      #resultScreen,
      #adminPanel {
        display: none;
      }
      .leaderboard {
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      @media (max-width: 600px) {
        body {
          font-size: 14px;
        }
        button {
          width: 100%;
        }
      }
      #winnerAnimation {
        font-size: 24px;
        font-weight: bold;
        color: #28a745;
        animation: pop 1s infinite alternate;
      }
      @keyframes pop {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.2);
        }
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</h1>
      <div id="joinScreen">
        <p>Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</p>
        <input type="text" id="playerName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯" />
        <button id="joinBtn">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
        <br /><br />
        <button id="adminBtn">ğŸ”‘ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
      </div>

      <div id="waitingScreen">
        <h2>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</h2>
        <p>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <span id="requiredPlayersDisplay">5</span></p>
        <p>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†: <span id="currentPlayersCount">0</span></p>
      </div>

      <div id="quizScreen">
        <h2 id="questionText"></h2>
        <div id="answers"></div>
        <p>Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="timer">--</span> Ø«Ø§Ù†ÙŠØ©</p>
      </div>

      <div id="resultScreen">
        <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸ‰</h2>
        <div id="winnerAnimation"></div>
        <div class="leaderboard" id="leaderboard"></div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
      <div id="adminPanel">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
        <input type="number" id="requiredPlayersInput" min="2" value="5" />
        <button id="saveRequiredPlayers">Ø­ÙØ¸</button>
        <button onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        onValue,
        update,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // âœ… Config Ø¨ØªØ§Ø¹Ùƒ
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let playerName = "";
      let currentQuestion = 0;
      let score = 0;
      let REQUIRED_PLAYERS = 5;
      let timerInterval;

      const questions = [
        {
          q: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ",
          a: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø£Ø³ÙˆØ§Ù†"],
          correct: 0,
        },
        { q: "2 + 2 = ?", a: ["3", "4", "5"], correct: 1 },
        { q: "Ù…Ø§ Ù‡Ùˆ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø­Ø±ØŸ", a: ["Ø£Ø­Ù…Ø±", "Ø£Ø²Ø±Ù‚", "Ø£ØµÙØ±"], correct: 1 },
      ];

      // âœ… Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø§Ø¹Ø¨
      document.getElementById("joinBtn").onclick = () => {
        playerName = document.getElementById("playerName").value.trim();
        if (!playerName) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„");

        set(ref(db, "players/" + playerName), { score: 0, finished: false });
        document.getElementById("joinScreen").style.display = "none";
        document.getElementById("waitingScreen").style.display = "block";
      };

      // âœ… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
      const settingsRef = ref(db, "settings/requiredPlayers");
      onValue(settingsRef, (snap) => {
        if (snap.exists()) {
          REQUIRED_PLAYERS = snap.val();
          document.getElementById("requiredPlayersDisplay").innerText =
            REQUIRED_PLAYERS;
        }
      });

      // âœ… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ¹Ø¯Ø¯Ù‡Ù…
      const playersRef = ref(db, "players");
      onValue(playersRef, (snap) => {
        const players = snap.val() || {};
        const count = Object.keys(players).length;
        document.getElementById("currentPlayersCount").innerText = count;

        if (count >= REQUIRED_PLAYERS) {
          startCompetition();
        }

        // âœ… Ù„Ùˆ ÙƒÙ„Ù‡Ù… Ø®Ù„ØµÙˆØ§ â†’ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        const allFinished =
          Object.values(players).length > 0 &&
          Object.values(players).every((p) => p.finished);
        if (allFinished) {
          endCompetition(players);
        }
      });

      function startCompetition() {
        document.getElementById("waitingScreen").style.display = "none";
        document.getElementById("quizScreen").style.display = "block";
        loadQuestion();
      }

      function loadQuestion() {
        if (currentQuestion >= questions.length) {
          // Ø®Ù„ØµØª
          update(ref(db, "players/" + playerName), { score, finished: true });
          document.getElementById("quizScreen").style.display = "none";
          document.getElementById("waitingScreen").style.display = "block";
          document.getElementById("waitingScreen").innerHTML =
            "<h2>Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡ÙŠØª âœ… Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ù‚ÙŠ Ø²Ù…Ù„Ø§Ø¦Ùƒ...</h2>";
          return;
        }
        const q = questions[currentQuestion];
        document.getElementById("questionText").innerText = q.q;
        const ansDiv = document.getElementById("answers");
        ansDiv.innerHTML = "";
        q.a.forEach((ans, i) => {
          const btn = document.createElement("button");
          btn.innerText = ans;
          btn.onclick = () => {
            if (i === q.correct) score++;
            currentQuestion++;
            loadQuestion();
          };
          ansDiv.appendChild(btn);
        });

        // Ù…Ø¤Ù‚Øª 20 Ø«Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
        let time = 20;
        document.getElementById("timer").innerText = time;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          time--;
          document.getElementById("timer").innerText = time;
          if (time <= 0) {
            clearInterval(timerInterval);
            currentQuestion++;
            loadQuestion();
          }
        }, 1000);
      }

      function endCompetition(players) {
        document.getElementById("waitingScreen").style.display = "none";
        document.getElementById("quizScreen").style.display = "none";
        document.getElementById("resultScreen").style.display = "block";

        // ØªØ±ØªÙŠØ¨
        const sorted = Object.entries(players).sort(
          (a, b) => b[1].score - a[1].score
        );
        const winner = sorted[0];
        document.getElementById(
          "winnerAnimation"
        ).innerText = `ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²: ${winner[0]} Ø¨Ø¯Ø±Ø¬Ø© ${winner[1].score}`;

        let html = "<h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</h3>";
        sorted.forEach(([name, data], i) => {
          html += `<p>${i + 1}- ${name} : ${data.score}</p>`;
        });
        document.getElementById("leaderboard").innerHTML = html;

        // Ù…Ø¤Ø«Ø± ØµÙˆØªÙŠ ØªØ´Ø¬ÙŠØ¹ÙŠ
        const audio = new Audio(
          "https://www.myinstants.com/media/sounds/applause.mp3"
        );
        audio.play();
      }

      // âœ… Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
      document.getElementById("adminBtn").onclick = () => {
        const pass = prompt("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù†:");
        if (pass === "admin123") {
          document.getElementById("adminPanel").style.display = "block";
        } else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©!");
      };

      document.getElementById("saveRequiredPlayers").onclick = () => {
        const val = parseInt(
          document.getElementById("requiredPlayersInput").value,
          10
        );
        if (val > 1) set(settingsRef, val);
      };

      window.closeAdmin = () => {
        document.getElementById("adminPanel").style.display = "none";
      };
    </script>
  </body>
</html>
