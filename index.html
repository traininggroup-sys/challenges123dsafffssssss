<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨ â€” Ù…Ø¨Ø§Ø´Ø±</title>

    <!-- Google font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --brand: #ff5722;
        --bg1: #0f2027;
        --bg2: #2c5364;
        --card: #ffffff;
        --muted: #707070;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Cairo", sans-serif;
        background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);
        color: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px;
      }

      .app {
        width: 100%;
        max-width: 1100px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), #fff);
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        display: flex;
        gap: 0;
        flex-direction: column;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 22px;
        background: linear-gradient(90deg, var(--brand), #ff8a50);
        color: #fff;
      }
      header h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.4px;
      }
      header .small {
        font-size: 13px;
        opacity: 0.95;
      }

      main {
        padding: 18px;
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 18px;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }

      /* left column (quiz) */
      .card {
        background: var(--card);
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .welcome {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        padding: 28px 12px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.ghost {
        background: transparent;
        color: var(--brand);
        border: 2px solid rgba(255, 255, 255, 0.12);
      }
      .input {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #eee;
        width: 260px;
      }

      /* quiz layout */
      .quiz-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .timer {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .circleTimer {
        width: 74px;
        height: 74px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: conic-gradient(var(--brand) 0deg, #eee 0deg);
        font-weight: 800;
        color: var(--brand);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      }
      .progress {
        height: 10px;
        background: #eee;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 8px;
      }
      .progress > i {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--brand), #ff8a50);
        width: 0%;
      }

      .question {
        font-size: 18px;
        margin: 12px 0 6px;
      }
      .options {
        display: grid;
        gap: 10px;
      }
      .option {
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        background: #fafafa;
        border: 2px solid transparent;
        transition: all 0.16s;
        text-align: center;
        font-weight: 600;
      }
      .option:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      }
      .option.correct {
        background: #e8f8ef;
        border-color: #1db954;
        color: #0b6b3d;
      }
      .option.wrong {
        background: #ffecec;
        border-color: #e53935;
        color: #8b2b2b;
      }
      .meta {
        color: var(--muted);
        font-size: 13px;
      }

      /* right column (leaderboard) */
      .leaderboard h3 {
        margin: 0 0 8px;
      }
      ol.leaders {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      ol.leaders li {
        background: linear-gradient(180deg, #fff, #fafafa);
        padding: 10px 12px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.04);
        font-weight: 700;
      }
      ol.leaders li .name {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .rank1 {
        background: linear-gradient(90deg, #ffd700, #ffbe2e);
        color: #111;
      }
      .rank2 {
        background: linear-gradient(90deg, #c0c0c0, #e6e6e6);
      }
      .rank3 {
        background: linear-gradient(90deg, #cd7f32, #e0a67a);
      }
      .badge {
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.06);
      }

      footer {
        padding: 12px 18px;
        background: #fff6;
        text-align: center;
        font-size: 13px;
        color: #333;
      }

      /* admin modal hidden trigger (small) */
      .admin-trigger {
        position: fixed;
        bottom: 12px;
        left: 12px;
        opacity: 0.7;
        cursor: pointer;
        z-index: 999;
      }
      .admin-modal {
        position: fixed;
        right: 12px;
        top: 12px;
        width: 360px;
        max-width: calc(100% - 24px);
        background: #fff;
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        display: none;
        z-index: 1000;
      }
      .admin-modal.open {
        display: block;
      }
      .form-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin: 8px 0;
      }
      .small-btn {
        padding: 8px 10px;
        background: var(--brand);
        color: #fff;
        border-radius: 8px;
        border: none;
        cursor: pointer;
      }
      .muted-small {
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="app" role="application">
      <header>
        <div>
          <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</h1>
          <div class="small">
            Ø§Ø¨Ø¯Ø£ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠ â€” Ø®Ù„ÙŠÙ‡ Ù…Ù…ØªØ¹ ÙˆØ¹Ø§ÙŠØ²Ø© Ø£Ø¯Ù…Ù† ÙŠØ³Ø¨Ù‚ ÙˆÙŠØ´ÙˆÙ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          </div>
        </div>
        <div class="small muted-small">
          âš¡ Ù†Ø³Ø®Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© â€¢ Responsive â€¢ Live Leaderboard
        </div>
      </header>

      <main>
        <!-- LEFT: QUIZ & LOBBY -->
        <section>
          <!-- Welcome screen (single unified) -->
          <div id="welcomeCard" class="card welcome">
            <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</h2>
            <p class="muted">
              Ø§Ø¶ØºØ·ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ø´Ø§Ù† ØªØ¯Ø®Ù„Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©. Ø§Ù„Ø£Ø¯Ù…Ù† Ø®ØµÙŠØµÙ‹Ø§ ÙŠØ¶ØºØ· Ø±Ù…Ø² Ø§Ù„Ù‚ÙÙ„
              Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„.
            </p>
            <input
              id="joinName"
              class="input"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯)"
            />
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 12px;
              "
            >
              <button class="btn" id="joinBtn">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
              <button class="btn ghost" id="spectateBtn">Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø±Ø§Ù‚Ø¨</button>
            </div>
            <div style="margin-top: 12px" class="meta">
              Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†: <span id="playersCount">0</span>
            </div>
          </div>

          <!-- Quiz area -->
          <div id="quizCard" class="card" style="display: none">
            <div class="quiz-top">
              <div>
                <div id="progressText" class="meta">Ø³Ø¤Ø§Ù„ 0 / 0</div>
                <div class="question" id="questionText">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
                <div id="hint" class="meta"></div>
                <div class="progress" aria-hidden><i id="progressBar"></i></div>
              </div>

              <div class="timer">
                <div class="circleTimer" id="circleTimer">--</div>
                <div style="text-align: right">
                  <div class="meta">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
                  <div
                    id="timeText"
                    class="meta"
                    style="font-weight: 800; color: var(--brand)"
                  >
                    --
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top: 12px" id="options" class="options"></div>
            <div style="margin-top: 10px" id="feedback" class="meta"></div>
          </div>
        </section>

        <!-- RIGHT: Leaderboard -->
        <aside>
          <div class="card leaderboard">
            <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
            <ol class="leaders" id="leaderboardList">
              <!-- items -->
            </ol>
            <div style="margin-top: 12px" class="meta">
              Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙˆÙ† ÙŠØ¸Ù‡Ø±ÙˆÙ† Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹
            </div>
          </div>

          <div class="card" style="margin-top: 14px">
            <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
            <div class="meta">
              Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b id="statusLabel">waiting</b>
            </div>
            <div class="meta">
              Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚Øª: <b id="totalTimeLabel">5 Ø¯Ù‚Ø§Ø¦Ù‚</b>
            </div>
            <div style="margin-top: 8px" class="meta">
              Ø£Ø¹Ù„Ù‰: <span id="topBadge">â€”</span>
            </div>
          </div>
        </aside>
      </main>

      <footer>
        ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ â€¢ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£ÙØ¶Ù„ (Firebase Auth)
        Ù„Ø§Ø­Ù‚Ù‹Ø§
      </footer>
    </div>

    <!-- admin hidden small lock -->
    <div class="admin-trigger" id="adminTrigger" title="ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Ù…Ø®ÙÙŠ)">
      <svg
        width="36"
        height="36"
        viewBox="0 0 24 24"
        fill="none"
        style="filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2))"
      >
        <path
          d="M12 17a2 2 0 100-4 2 2 0 000 4z"
          stroke="#fff"
          stroke-width="1.4"
        />
        <rect
          x="3"
          y="7"
          width="18"
          height="13"
          rx="2"
          stroke="#fff"
          stroke-width="1.4"
        />
      </svg>
    </div>

    <!-- admin modal -->
    <div class="admin-modal" id="adminModal" aria-hidden="true">
      <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
      <div id="adminLoginBox">
        <div class="form-row">
          <input
            id="adminUser"
            placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†"
            style="
              flex: 1;
              padding: 8px;
              border: 1px solid #eee;
              border-radius: 8px;
            "
          />
        </div>
        <div class="form-row">
          <input
            id="adminPass"
            placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"
            type="password"
            style="
              flex: 1;
              padding: 8px;
              border: 1px solid #eee;
              border-radius: 8px;
            "
          />
        </div>
        <div class="form-row">
          <button class="small-btn" id="adminLoginBtn">Ø¯Ø®ÙˆÙ„</button
          ><button
            class="small-btn"
            id="closeAdminBtn"
            style="background: #ccc; color: #111"
          >
            Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>
        <div id="adminError" style="color: #c00; margin-top: 8px"></div>
      </div>

      <div id="adminPanelBox" style="display: none">
        <div class="form-row">
          <label style="flex: 1"
            >Ù…Ø¯Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (Ø¯Ù‚Ø§ÙŠÙ‚)<input
              id="adminDuration"
              type="number"
              min="1"
              value="5"
              style="width: 80px; margin-left: 8px; padding: 6px"
          /></label>
        </div>
        <div class="form-row">
          <label style="flex: 1"
            >Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¨Ø¯Ø¡<input
              id="adminMinPlayers"
              type="number"
              min="1"
              value="2"
              style="width: 80px; margin-left: 8px; padding: 6px"
          /></label>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px">
          <button class="small-btn" id="adminSaveBtn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <button class="small-btn" id="adminStartBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
          <button class="small-btn" id="adminEndBtn" style="background: #c00">
            Ø¥Ù†Ù‡Ø§Ø¡
          </button>
          <button class="small-btn" id="adminClearBtn" style="background: #666">
            Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
          </button>
        </div>
        <div style="margin-top: 10px">
          <div class="muted-small">
            ØªØ¨Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ù„Ù„ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Firebase
            Auth Ù„Ø§Ø­Ù‚Ù‹Ø§)
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK (compat for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      /* ------------------ CONFIG ------------------ */
      /* Ø¶Ø¹ÙŠ Ù‡Ù†Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ (Ø§Ù„ÙŠ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ù‹Ø§) */
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      /* ------------------ ADMIN CREDENTIALS (simple) ------------------ */
      /* ØºÙŠÙ‘Ø±ÙŠÙ‡Ù… Ù„Ùˆ Ø­Ø¨ÙŠØªÙŠØ› Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙÙ†ØµØ­ Firebase Auth */
      const ADMIN_USER = "Eman";
      const ADMIN_PASS = "123456";

      /* ------------------ QUESTIONS (Ù…ÙƒØªÙˆØ¨Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù‡Ù†Ø§) ------------------ */
      /* Ø¶ÙŠÙÙŠ/Ø¹Ø¯Ù‘Ù„ÙŠ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ */
      const QUESTIONS = [
        {
          q: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ",
          opts: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„Ø¬ÙŠØ²Ø©"],
          a: 0,
        },
        {
          q: "Ù…Ù† Ù‡Ùˆ Ù…Ø¤Ø³Ø³ Ø´Ø±ÙƒØ© Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØªØŸ",
          opts: ["Ø¨ÙŠÙ„ Ø¬ÙŠØªØ³", "Ø³ØªÙŠÙ Ø¬ÙˆØ¨Ø²", "Ø¥ÙŠÙ„ÙˆÙ† Ù…Ø§Ø³Ùƒ", "Ù…Ø§Ø±Ùƒ Ø²ÙˆÙƒØ±Ø¨ÙŠØ±Ø¬"],
          a: 0,
        },
        { q: "ÙƒÙ… Ø¹Ø¯Ø¯ Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", opts: ["5", "6", "7", "8"], a: 2 },
        {
          q: "Ø£Ø³Ø±Ø¹ Ø­ÙŠÙˆØ§Ù† Ø¨Ø±ÙŠ Ù‡ÙˆØŸ",
          opts: ["Ø§Ù„ÙÙ‡Ø¯", "Ø§Ù„Ø£Ø³Ø¯", "Ø§Ù„Ø¸Ø¨ÙŠ", "Ø§Ù„Ù†Ù…Ø±"],
          a: 0,
        },
        { q: "Ù†ØªÙŠØ¬Ø© 9 Ã— 6ØŸ", opts: ["54", "45", "63", "56"], a: 0 },
        {
          q: "Ø£ÙŠÙ‘ Ù‡Ø°Ù‡ Ø§Ù„Ù„ØºØ§Øª Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨ØŸ",
          opts: ["JavaScript", "Python", "C++", "Java"],
          a: 0,
        },
        {
          q: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ",
          opts: ["Ø§Ù„Ù…Ø±ÙŠØ®", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø²Ø­Ù„", "Ù†ÙŠØ¨ØªÙˆÙ†"],
          a: 1,
        },
        {
          q: "Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ",
          opts: ["Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø¬Ø¯Ø©", "Ø§Ù„Ø¯Ù…Ø§Ù…", "Ù…ÙƒØ©"],
          a: 0,
        },
        {
          q: "Ù…Ø§ Ù„ÙˆÙ† Ø§Ù„Ø³Ù…Ø§Ø¡ ÙÙŠ ÙŠÙˆÙ… ØµØ§ÙÙØŸ",
          opts: ["Ø£Ø²Ø±Ù‚", "Ø£Ø³ÙˆØ¯", "Ø£Ø®Ø¶Ø±", "Ø£Ø­Ù…Ø±"],
          a: 0,
        },
        {
          q: "Ø£Ø´Ù‡ÙØ± Ù…Ø­Ø±Ùƒ Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ±Ù†ØªØŸ",
          opts: ["Bing", "Google", "Yahoo", "DuckDuckGo"],
          a: 1,
        },
      ];

      /* ------------------ UI references ------------------ */
      const ui = {
        welcomeCard: document.getElementById("welcomeCard"),
        joinBtn: document.getElementById("joinBtn"),
        spectateBtn: document.getElementById("spectateBtn"),
        joinName: document.getElementById("joinName"),
        quizCard: document.getElementById("quizCard"),
        questionText: document.getElementById("questionText"),
        optionsWrap: document.getElementById("options"),
        progressText: document.getElementById("progressText"),
        progressBar: document.getElementById("progressBar"),
        circleTimer: document.getElementById("circleTimer"),
        timeText: document.getElementById("timeText"),
        feedback: document.getElementById("feedback"),
        playersCount: document.getElementById("playersCount"),
        leaderboardList: document.getElementById("leaderboardList"),
        statusLabel: document.getElementById("statusLabel"),
        totalTimeLabel: document.getElementById("totalTimeLabel"),
        adminTrigger: document.getElementById("adminTrigger"),
        adminModal: document.getElementById("adminModal"),
        adminLoginBox: document.getElementById("adminLoginBox"),
        adminPanelBox: document.getElementById("adminPanelBox"),
        adminUser: document.getElementById("adminUser"),
        adminPass: document.getElementById("adminPass"),
        adminError: document.getElementById("adminError"),
        adminLoginBtn: document.getElementById("adminLoginBtn"),
        adminCloseBtn: document.getElementById("closeAdminBtn"),
        adminSaveBtn: document.getElementById("adminSaveBtn"),
        adminStartBtn: document.getElementById("adminStartBtn"),
        adminEndBtn: document.getElementById("adminEndBtn"),
        adminClearBtn: document.getElementById("adminClearBtn"),
        adminDuration: document.getElementById("adminDuration"),
        adminMinPlayers: document.getElementById("adminMinPlayers"),
        toggleVoice: document.getElementById("toggleVoice"),
        topBadge: document.getElementById("topBadge"),
      };

      /* ------------------ State ------------------ */
      let PLAYER_ID = null;
      let PLAYER_NAME = "";
      let localScore = 0;
      let localIndex = 0;
      let shuffled = [];
      let quizEndAt = null;
      let totalSeconds = 300;
      let minPlayers = 2;
      let status = "waiting"; // waiting | countdown | started | ended
      let optionLock = false;
      let voiceOn = true;
      let cheerTimer = null;

      /* ------------------ Sounds ------------------ */
      const sCorrect = new Audio(
        "https://cdn.pixabay.com/download/audio/2021/08/04/audio_6a0b0f24c1.mp3?filename=success-fanfare-trumpets-6185.mp3"
      );
      const sWrong = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_3f0a9a5e17.mp3?filename=wrong-buzzer-6266.mp3"
      );
      const sStart = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_1d8f3f9f2d.mp3?filename=short-whistle-6096.mp3"
      );
      const sEnd = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_1b5b8b5a3b.mp3?filename=bell-small-6282.mp3"
      );
      const sTick = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_9c1d2b1a4d.mp3?filename=clock-tick-6272.mp3"
      );

      /* try to unlock audio on first click */
      document.addEventListener(
        "click",
        () => {
          [sCorrect, sWrong, sStart, sEnd, sTick].forEach((a) => {
            a.muted = false;
            a.play()
              .then(() => a.pause())
              .catch(() => {});
          });
        },
        { once: true }
      );

      /* ------------------ Firebase refs ------------------ */
      const liveRef = db.ref("liveQuiz");
      const playersRef = db.ref("liveQuiz/players");
      const settingsRef = db.ref("liveQuiz/settings");
      const statusRef = db.ref("liveQuiz/status");

      /* ------------------ Admin UI behavior ------------------ */
      ui.adminTrigger.addEventListener("click", () =>
        ui.adminModal.classList.toggle("open")
      );
      ui.adminCloseBtn.addEventListener("click", () =>
        ui.adminModal.classList.remove("open")
      );

      ui.adminLoginBtn.addEventListener("click", () => {
        const u = ui.adminUser.value.trim(),
          p = ui.adminPass.value.trim();
        if (u === ADMIN_USER && p === ADMIN_PASS) {
          ui.adminLoginBox.style.display = "none";
          ui.adminPanelBox.style.display = "block";
          ui.adminError.innerText = "";
        } else {
          ui.adminError.innerText = "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
        }
      });

      /* admin actions */
      ui.adminSaveBtn.addEventListener("click", async () => {
        const mins = parseInt(ui.adminDuration.value) || 5;
        minPlayers = parseInt(ui.adminMinPlayers.value) || 2;
        totalSeconds = mins * 60;
        await liveRef.update({ settings: { totalSeconds, minPlayers } });
        ui.totalTimeLabel.innerText = `${mins} Ø¯Ù‚Ø§Ø¦Ù‚`;
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
      });

      ui.adminStartBtn.addEventListener("click", async () => {
        // set countdown start then move to started
        await liveRef.update({
          status: "countdown",
          lobbyCountdownStartsAt: Date.now(),
        });
        alert("Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ (countdown)");
      });

      ui.adminEndBtn.addEventListener("click", async () => {
        await liveRef.update({ status: "ended", endedAt: Date.now() });
        alert("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
      });

      ui.adminClearBtn.addEventListener("click", async () => {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (ØªØ¬Ø±ÙŠØ¨ÙŠ)ØŸ")) return;
        await playersRef.remove();
        alert("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
      });

      /* ------------------ Player join and local resume ------------------ */
      ui.joinBtn.addEventListener("click", async () => {
        const name =
          ui.joinName.value.trim() ||
          localStorage.getItem("savedName") ||
          "Ù„Ø§Ø¹Ø¨";
        PLAYER_NAME = name;
        localStorage.setItem("savedName", PLAYER_NAME);
        // create row with push key (use push().key)
        const newKey = playersRef.push().key;
        PLAYER_ID = newKey;
        // initial write
        await db
          .ref(`liveQuiz/players/${PLAYER_ID}`)
          .set({
            name: PLAYER_NAME,
            score: 0,
            currentQuestion: 0,
            joinedAt: Date.now(),
          });
        // ensure onDisconnect removal
        db.ref(`liveQuiz/players/${PLAYER_ID}`).onDisconnect().remove();
        ui.welcomeCard.style.display = "none";
        // if status already started -> enter quiz
        // other listeners will call enterQuiz on status started
      });

      ui.spectateBtn.addEventListener("click", () => {
        ui.welcomeCard.style.display = "none";
        // just show leaderboard
      });

      /* ------------------ Listen players count and list ------------------ */
      playersRef.on("value", (snap) => {
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([k, v]) => ({
          id: k,
          name: v.name || "Ù„Ø§Ø¹Ø¨",
          score: v.score || 0,
        }));
        ui.playersCount.innerText = arr.length;
      });

      /* ------------------ Live status listener ------------------ */
      liveRef.on("value", (snap) => {
        const data = snap.val() || {};
        status = data.status || "waiting";
        const settings = data.settings || {};
        if (settings.totalSeconds) totalSeconds = settings.totalSeconds;
        if (settings.minPlayers) minPlayers = settings.minPlayers;
        ui.statusLabel.innerText = status;
        ui.totalTimeLabel.innerText = `${Math.round(totalSeconds / 60)} Ø¯Ù‚Ø§Ø¦Ù‚`;
        if (status === "countdown") {
          // small client-side countdown of 10s then mark started
          const startAt = data.lobbyCountdownStartsAt || Date.now();
          startLocalLobbyCountdown(startAt);
        }
        if (status === "started") {
          // begin quiz for joined players
          const quizStartsAt = data.quizStartsAt || Date.now();
          quizEndAt =
            (data.quizStartsAt ? data.quizStartsAt : Date.now()) +
            totalSeconds * 1000;
          // if we are admin we used adminStartBtn to set countdown earlier; if not, when server sets 'started' we enter
          if (PLAYER_ID) enterQuiz();
          if (voiceOn) playStartSound();
        }
        if (status === "ended") {
          stopCheer();
          if (PLAYER_ID) finishLocal();
          if (voiceOn) {
            sEnd.play().catch(() => {});
            speak("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
          }
        }
      });

      /* ------------------ Countdown logic (lobby) ------------------ */
      let lobbyTimer = null;
      function startLocalLobbyCountdown(startAt) {
        clearInterval(lobbyTimer);
        const COUNTDOWN = 10; // seconds shown before starting
        lobbyTimer = setInterval(() => {
          const startMs = startAt || Date.now();
          const endAt = startMs + COUNTDOWN * 1000;
          const remain = Math.max(0, Math.ceil((endAt - Date.now()) / 1000));
          ui.timeText.innerText = `ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„ ${remain} Ø«Ø§Ù†ÙŠØ©`;
          if (remain <= 0) {
            clearInterval(lobbyTimer);
            // set global started and quizStartsAt (run transaction to avoid races)
            liveRef.update({ status: "started", quizStartsAt: Date.now() });
            // update quizEndAt
            quizEndAt = Date.now() + totalSeconds * 1000;
          }
        }, 300);
      }

      /* ------------------ Enter quiz for player ------------------ */
      function enterQuiz() {
        // resume progress if exists
        db.ref(`liveQuiz/players/${PLAYER_ID}`)
          .once("value")
          .then((snap) => {
            const v = snap.val() || {};
            localScore = v.score || 0;
            localIndex = v.currentQuestion || 0;
            shuffled = shuffleArray(QUESTIONS);
            // If player had progressed some questions, ensure we keep order by storing shuffled in localStorage per session
            // Present quiz UI
            ui.quizCard.style.display = "block";
            ui.welcomeCard.style.display = "none";
            startGlobalTimer();
            renderQuestion();
            listenLeaderboard();
            startCheer(); // start cheer interval
          });
      }

      /* ------------------ Global timer UI (text + circular) ------------------ */
      let globalTimer = null;
      function startGlobalTimer() {
        clearInterval(globalTimer);
        if (!quizEndAt) quizEndAt = Date.now() + totalSeconds * 1000;
        globalTimer = setInterval(() => {
          const remainMs = Math.max(0, quizEndAt - Date.now());
          const remainSec = Math.ceil(remainMs / 1000);
          const m = Math.floor(remainSec / 60);
          const s = remainSec % 60;
          ui.timeText.innerText = `${m}:${s.toString().padStart(2, "0")}`;
          // progress circle
          const elapsed = Math.max(0, totalSeconds * 1000 - remainMs);
          const pct = Math.min(
            100,
            Math.round((elapsed / (totalSeconds * 1000)) * 100)
          );
          ui.circleTimer.style.background = `conic-gradient(${getComputedStyle(
            document.documentElement
          ).getPropertyValue("--brand")} ${pct * 3.6}deg, #eee ${
            pct * 3.6
          }deg)`;
          ui.circleTimer.innerText = remainSec;
          // progress bar for question position
          const progPct = Math.min(
            100,
            Math.round((localIndex / QUESTIONS.length) * 100)
          );
          ui.progressBar.style.width = progPct + "%";
          ui.progressText.innerText = `Ø³Ø¤Ø§Ù„ ${Math.min(
            localIndex + 1,
            QUESTIONS.length
          )} / ${QUESTIONS.length}`;
          // tick sound occasionally (muted if too frequent)
          if (remainSec % 10 === 0) {
            sTick.play().catch(() => {});
          }
          if (remainSec <= 0) {
            clearInterval(globalTimer);
            // end quiz
            db.ref("liveQuiz").update({ status: "ended" });
          }
        }, 500);
      }

      /* ------------------ Render question & handle answer ------------------ */
      function renderQuestion() {
        ui.feedback.innerText = "";
        if (localIndex >= QUESTIONS.length) {
          // finished questions
          finishLocal();
          return;
        }
        const q = shuffled[localIndex];
        ui.questionText.innerText = q.q;
        ui.optionsWrap.innerHTML = "";
        const opts = shuffleArray(q.opts.map((o, i) => ({ o, i })));
        opts.forEach((item) => {
          const btn = document.createElement("div");
          btn.className = "option";
          btn.innerText = item.o;
          btn.onclick = () => {
            if (optionLock) return;
            optionLock = true;
            handleAnswer(item.i, btn);
          };
          ui.optionsWrap.appendChild(btn);
        });
      }

      async function handleAnswer(chosenIndex, btn) {
        const real = shuffled[localIndex].a;
        if (chosenIndex === real) {
          btn.classList.add("correct");
          ui.feedback.innerText = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
          localScore++;
          sCorrect.play().catch(() => {});
        } else {
          btn.classList.add("wrong");
          ui.feedback.innerText = `Ø®Ø·Ø£ âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${shuffled[localIndex].opts[real]}`;
          sWrong.play().catch(() => {});
          // mark the correct one visually
          Array.from(ui.optionsWrap.children).forEach((c) => {
            if (c.innerText === shuffled[localIndex].opts[real])
              c.classList.add("correct");
          });
        }

        // update once (debounced by nature - one update per answer)
        await db
          .ref(`liveQuiz/players/${PLAYER_ID}`)
          .update({
            score: localScore,
            currentQuestion: localIndex + 1,
            lastSeen: Date.now(),
          });

        localIndex++;
        setTimeout(() => {
          optionLock = false;
          if (Date.now() < quizEndAt) renderQuestion();
          else finishLocal();
        }, 900);
      }

      /* ------------------ Leaderboard live listener ------------------ */
      function listenLeaderboard() {
        playersRef.on("value", (snap) => {
          const data = snap.val() || {};
          const arr = Object.entries(data).map(([id, v]) => ({
            id,
            name: v.name || "Ù„Ø§Ø¹Ø¨",
            score: v.score || 0,
          }));
          arr.sort((a, b) => b.score - a.score);
          ui.leaderboardList.innerHTML = "";
          arr.forEach((p, i) => {
            const li = document.createElement("li");
            li.innerHTML = `<span class="name">${
              i < 3 ? (i === 0 ? "ğŸ†" : "") : ""
            } ${escapeHtml(p.name)}</span><span class="badge">${
              p.score
            }</span>`;
            if (i === 0) li.classList.add("rank1");
            if (i === 1) li.classList.add("rank2");
            if (i === 2) li.classList.add("rank3");
            ui.leaderboardList.appendChild(li);
          });
          // update top badge
          ui.topBadge.innerText =
            arr.length > 0 ? `${arr[0].name} (${arr[0].score})` : "â€”";
        });
      }

      /* ------------------ Finish & announce ------------------ */
      function finishLocal() {
        ui.feedback.innerText = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ Ø®Ù„ØµØª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ğŸ‰";
        ui.questionText.innerText = "Ø§Ù†ØªÙ‡Øª!";
        ui.optionsWrap.innerHTML = "";
        stopCheer();
        if (voiceOn) {
          sEnd.play().catch(() => {});
          speak(`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©. Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²`);
        }
      }

      /* ------------------ Cheer functionality (speech) ------------------ */
      function startCheer() {
        stopCheer();
        if (!voiceOn) return;
        cheerTimer = setInterval(() => {
          playersRef.once("value").then((snap) => {
            const data = snap.val() || {};
            const arr = Object.entries(data)
              .map(([id, v]) => ({ id, name: v.name, score: v.score || 0 }))
              .sort((a, b) => b.score - a.score);
            if (arr.length === 0) return;
            const top = arr[0];
            speakRandomTop(top.name);
          });
        }, 30000); // every 30s
      }
      function stopCheer() {
        if (cheerTimer) {
          clearInterval(cheerTimer);
          cheerTimer = null;
        }
      }
      function speakRandomTop(name) {
        if (!voiceOn) return;
        const msgs = [
          `Ø¨Ø±Ø§ÙÙˆ ÙŠØ§ ${name}! Ø§Ù†Øª Ù…ØªØµØ¯Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠ`,
          `Ø­Ø§ÙØ¸ ÙŠØ§ ${name}ØŒ Ù‚Ø¯Ù‘Ø§Ù…Ùƒ Ù…Ù†Ø§ÙØ³Ø© Ù‚ÙˆÙŠØ©!`,
          `Ø§Ø³ØªÙ…Ø± ÙŠØ§ ${name}ØŒ Ù‚Ø¯Ø§Ù…Ùƒ Ù†Ø§Ø³ Ø¨ØªØ­Ø§ÙˆÙ„ ØªÙ„Ø­Ù‚Ùƒ!`,
        ];
        const text = msgs[Math.floor(Math.random() * msgs.length)];
        speak(text);
      }
      function speak(text) {
        try {
          const u = new SpeechSynthesisUtterance(text);
          u.lang = "ar-EG";
          u.rate = 0.95;
          u.pitch = 1;
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        } catch (e) {}
      }
      function playStartSound() {
        sStart.play().catch(() => {});
      }
      function playEndSound() {
        sEnd.play().catch(() => {});
      }

      /* ------------------ Utils ------------------ */
      function shuffleArray(a) {
        return a.slice().sort(() => Math.random() - 0.5);
      }
      function escapeHtml(s) {
        return (s || "")
          .toString()
          .replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
      }

      /* ------------------ voice toggle control (small) ------------------ */
      ui.toggleVoice &&
        ui.toggleVoice.addEventListener("click", () => {
          voiceOn = !voiceOn;
          ui.toggleVoice.innerText = voiceOn ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª" : "ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª";
          if (!voiceOn) stopCheer();
        });

      /* ------------------ Initialize: set default settings in DB if not present (only once) ------------------ */
      (async function initDefaultSettings() {
        const snap = await liveRef.once("value");
        if (!snap.exists()) {
          await liveRef.set({
            status: "waiting",
            settings: { totalSeconds: 300, minPlayers: 2 },
          });
        } else {
          const val = snap.val() || {};
          if (val.settings && val.settings.totalSeconds)
            totalSeconds = val.settings.totalSeconds;
          if (val.settings && val.settings.minPlayers)
            minPlayers = val.settings.minPlayers;
          ui.totalTimeLabel.innerText = `${Math.round(
            totalSeconds / 60
          )} Ø¯Ù‚Ø§Ø¦Ù‚`;
        }
      })();
    </script>
  </body>
</html>
