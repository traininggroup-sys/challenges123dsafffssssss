<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      مسابقة أعضاء جروب المشتركين للتدريب - مباشر (Responsive + صوت)
    </title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #ff5722;
        --bg1: #ffecd2;
        --bg2: #fcb69f;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Cairo", system-ui, Segoe UI, Arial, sans-serif;
        background: linear-gradient(135deg, var(--bg1), var(--bg2));
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .card {
        width: 100%;
        max-width: 940px;
        background: #fff;
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      }
      h1 {
        margin: 0 0 8px;
        color: var(--brand);
        font-size: 22px;
      }
      p.muted {
        color: #666;
        margin: 6px 0;
      }

      .lobby-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type="text"] {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-size: 15px;
        width: 260px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.small {
        padding: 8px 10px;
        border-radius: 8px;
      }

      .pill {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        background: #fff;
        padding: 8px;
        border-radius: 999px;
        border: 1px solid #eee;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 14px;
        margin-top: 12px;
      }
      .board {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 10px;
      }
      .board h3 {
        margin: 0 0 8px;
      }
      .board ol {
        margin: 0;
        padding-left: 18px;
        max-height: 360px;
        overflow: auto;
      }

      .question-card {
        background: #fff;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .options {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }
      .option {
        background: #f7f7f7;
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.15s;
      }
      .option:hover {
        background: #fff3e8;
        border-color: var(--brand);
      }

      #timer {
        font-weight: 800;
        color: var(--brand);
        margin-bottom: 6px;
      }
      #message {
        font-weight: 700;
        margin-top: 8px;
      }

      .center {
        text-align: center;
      }

      /* responsive */
      @media (max-width: 880px) {
        .two-col {
          grid-template-columns: 1fr 260px;
        }
      }
      @media (max-width: 640px) {
        .two-col {
          grid-template-columns: 1fr;
        }
        .board {
          order: 2;
        }
        .lobby-row {
          flex-direction: column;
          align-items: stretch;
        }
        input[type="text"] {
          width: 100%;
        }
        .board ol {
          max-height: 220px;
        }
        h1 {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card" id="app">
      <!-- LOBBY -->
      <div id="screen-lobby">
        <h1>مسابقة أعضاء جروب المشتركين للتدريب</h1>
        <p class="muted">
          اضغطي مشاركة وابقي متصلة. المسابقة هتبدأ تلقائيًا لما يوصل الحد الأدنى
          أو بعد العدّاد.
        </p>

        <div class="lobby-row">
          <input id="playerName" type="text" placeholder="اكتب اسمك" />
          <button id="joinBtn" class="btn">المشاركة</button>
          <button id="muteVoice" class="btn small">إيقاف/تشغيل الصوت</button>
        </div>

        <div
          style="
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
          "
        >
          <div class="pill">المتصلون الآن: <b id="playersCount">0</b></div>
          <div class="pill">
            الحد الأدنى للبدء: <b id="minPlayersPill">--</b>
          </div>
          <div class="pill">وقت المسابقة: <b id="totalTimePill">--</b></div>
        </div>

        <div style="margin-top: 10px" class="center">
          <div id="lobbyStatus">بانتظار المشاركين...</div>
          <div
            id="lobbyCountdown"
            style="font-weight: 800; color: var(--brand); margin-top: 6px"
          ></div>
        </div>

        <div class="board" style="margin-top: 12px">
          <h3>المشاركون الحاليون</h3>
          <ol id="playersList"></ol>
        </div>
      </div>

      <!-- QUIZ -->
      <div id="screen-quiz" style="display: none">
        <div class="two-col">
          <div>
            <div class="question-card">
              <div id="timer">الوقت المتبقي للمسابقة: --</div>
              <h2 id="questionText">سؤال</h2>
              <div id="message"></div>
              <div class="options" id="options"></div>
            </div>
          </div>
          <div class="board">
            <h3>الترتيب المباشر</h3>
            <ol id="leaderboardList"></ol>
          </div>
        </div>
      </div>

      <!-- END -->
      <div id="screen-end" style="display: none">
        <h2>انتهت المسابقة 🎉</h2>
        <p class="muted">نتيجتك: <b id="finalScore">0</b></p>
        <div class="board">
          <h3>الترتيب النهائي</h3>
          <ol id="finalBoard"></ol>
        </div>
        <div class="center" style="margin-top: 12px">
          <button class="btn" onclick="location.reload()">
            الرجوع للبداية
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        onValue,
        onDisconnect,
        serverTimestamp,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // ===== إعداد Firebase (استخدمي إعدادات مشروعك لو اختلفت) =====
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ===== إعدادات المسابقة (قابلة للتعديل) =====
      const MIN_PLAYERS = 2; // الحد الأدنى لبدء العدّاد تلقائيًا
      const LOBBY_COUNTDOWN_SECONDS = 20; // عدّاد اللوبي عند اكتمال الحد
      const TOTAL_TIME = 300; // وقت المسابقة الكلي بالثواني (مثلاً 5 دقائق)

      document.getElementById("minPlayersPill").textContent = MIN_PLAYERS;
      document.getElementById("totalTimePill").textContent = `${Math.floor(
        TOTAL_TIME / 60
      )} دقائق`;

      // أصوات حدثية (روابط آمنة من pixabay)
      const sndCorrect = new Audio(
        "https://cdn.pixabay.com/download/audio/2021/08/04/audio_6a0b0f24c1.mp3?filename=success-fanfare-trumpets-6185.mp3"
      );
      const sndWrong = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_3f0a9a5e17.mp3?filename=wrong-buzzer-6266.mp3"
      );
      const sndTick = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_9c1d2b1a4d.mp3?filename=clock-tick-6272.mp3"
      );
      const sndTimeUp = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_1b5b8b5a3b.mp3?filename=bell-small-6282.mp3"
      );

      let voiceEnabled = true;
      document.getElementById("muteVoice").addEventListener("click", () => {
        voiceEnabled = !voiceEnabled;
        document.getElementById("muteVoice").textContent = voiceEnabled
          ? "إيقاف/تشغيل الصوت"
          : "الصوت متوقف";
      });

      // محاولة فك قيد autoplay عبر نقر المستخدم
      const unlockAudio = () => {
        [sndCorrect, sndWrong, sndTick, sndTimeUp].forEach((a) => {
          a.muted = false;
          a.play()
            .then(() => a.pause())
            .catch(() => {});
        });
        document.removeEventListener("click", unlockAudio);
      };
      document.addEventListener("click", unlockAudio);

      // بنك الأسئلة
      const QUESTIONS = [
        {
          q: "ما هي عاصمة مصر؟",
          opts: ["القاهرة", "الإسكندرية", "الأقصر", "الجيزة"],
          a: "القاهرة",
        },
        {
          q: "أكبر كوكب في النظام الشمسي هو؟",
          opts: ["الأرض", "المشتري", "المريخ", "زحل"],
          a: "المشتري",
        },
        {
          q: "لغة الويب الأشهر للواجهة الأمامية؟",
          opts: ["Python", "JavaScript", "C++", "Java"],
          a: "JavaScript",
        },
        {
          q: "أسرع حيوان بري؟",
          opts: ["الفهد", "الأسد", "الظبي", "النمر"],
          a: "الفهد",
        },
        {
          q: "كم عدد كواكب النظام الشمسي؟",
          opts: ["7", "8", "9", "10"],
          a: "8",
        },
      ];

      // عناصر DOM
      const el = (s) => document.querySelector(s);
      const screenLobby = el("#screen-lobby");
      const screenQuiz = el("#screen-quiz");
      const screenEnd = el("#screen-end");

      // مراجع Firebase
      const lobbyRef = ref(db, "liveQuiz");
      const playersRef = ref(db, "liveQuiz/players");
      const statusRef = ref(db, "liveQuiz/status");

      // حالة اللاعب المحلية
      let playerId = null,
        playerName = "",
        score = 0,
        qIndex = 0,
        shuffled = [],
        globalTimer = null,
        quizEndAt = null;

      // عرض المشاركين
      onValue(playersRef, (snap) => {
        const data = snap.val() || {};
        const arr = Object.values(data);
        el("#playersCount").textContent = arr.length;
        el("#playersList").innerHTML = arr
          .map((p) => `<li>${escapeHtml(p.name || "لاعب")}</li>`)
          .join("");

        // لو احنا في waiting ووصل العدد للحد، نفعل حالة countdown بإستخدام transaction
        onValue(
          statusRef,
          (sSnap) => {
            const st = sSnap.val() || "waiting";
            if (st === "waiting" && arr.length >= MIN_PLAYERS) {
              runTransaction(statusRef, (cur) => {
                if (cur === "waiting" || cur === null) return "countdown";
                return cur;
              })
                .then((res) => {
                  if (res.committed && res.snapshot.val() === "countdown") {
                    update(lobbyRef, {
                      lobbyCountdownStartsAt: serverTimestamp(),
                    });
                  }
                })
                .catch(() => {});
            }
          },
          { onlyOnce: true }
        );
      });

      // مراقبة حالة اللوبي/المسابقة
      onValue(lobbyRef, (snap) => {
        const data = snap.val() || {};
        const status = data.status || "waiting";
        const startsAt = data.lobbyCountdownStartsAt;
        const quizStartsAt = data.quizStartsAt;

        if (status === "waiting") {
          el("#lobbyStatus").textContent = "بانتظار المشاركين...";
          el("#lobbyCountdown").textContent = "";
        }
        if (status === "countdown") {
          el("#lobbyStatus").textContent = "يبدأ خلال:";
          startLobbyCountdown(startsAt);
        }
        if (status === "started") {
          // نحسب وقت نهاية المسابقة بناءً على quizStartsAt
          const startMs = quizStartsAt
            ? typeof quizStartsAt === "number"
              ? quizStartsAt
              : Date.now()
            : Date.now();
          quizEndAt = startMs + TOTAL_TIME * 1000;
          startGlobalTimer();
          // كل لاعب يظهر له شاشة المسابقة لو هو مسجل
          if (playerId) {
            enterQuizScreen();
          }
        }
        if (status === "ended") {
          // إعلان نهاية
          endScreen();
        }
      });

      // عدّاد اللوبي (عميل side countdown فقط)
      let lobbyTicker = null;
      function startLobbyCountdown(startsAt) {
        if (!startsAt) return;
        clearInterval(lobbyTicker);
        lobbyTicker = setInterval(() => {
          const startMs = typeof startsAt === "number" ? startsAt : Date.now();
          const endAt = startMs + LOBBY_COUNTDOWN_SECONDS * 1000;
          const remain = Math.max(0, Math.floor((endAt - Date.now()) / 1000));
          el("#lobbyCountdown").textContent = remain + " ثانية";
          if (remain <= 0) {
            clearInterval(lobbyTicker);
            runTransaction(statusRef, (cur) => {
              if (cur === "countdown") return "started";
              return cur;
            })
              .then((res) => {
                if (res.committed) {
                  update(lobbyRef, { quizStartsAt: serverTimestamp() });
                }
              })
              .catch(() => {});
          }
        }, 300);
      }

      // زر الانضمام
      el("#joinBtn").addEventListener("click", async () => {
        playerName = (el("#playerName").value || "لاعب مجهول").trim();
        if (!playerName) playerName = "لاعب مجهول";
        const newKey = push(playersRef).key;
        playerId = newKey;
        await set(ref(db, `liveQuiz/players/${playerId}`), {
          name: playerName,
          score: 0,
          joinedAt: serverTimestamp(),
          lastSeen: serverTimestamp(),
        });
        onDisconnect(ref(db, `liveQuiz/players/${playerId}`)).remove();
        el("#joinBtn").disabled = true;
        el("#joinBtn").textContent = "انت متصل";
        el("#lobbyStatus").textContent = "تم الانضمام ✔️";
      });

      // بدء المؤقت الكلي للمسابقة
      function startGlobalTimer() {
        clearInterval(globalTimer);
        if (!quizEndAt) quizEndAt = Date.now() + TOTAL_TIME * 1000;
        globalTimer = setInterval(() => {
          const remain = Math.max(
            0,
            Math.floor((quizEndAt - Date.now()) / 1000)
          );
          el("#timer").textContent = `الوقت المتبقي للمسابقة: ${remain} ثانية`;
          if (remain <= 0) {
            clearInterval(globalTimer);
            if (playerId) finishQuizLocal();
          }
        }, 500);
      }

      // عندما يدخل اللاعب إلى شاشة الاختبار
      function enterQuizScreen() {
        shuffled = shuffle(QUESTIONS);
        qIndex = 0;
        score = 0;
        screenLobby.style.display = "none";
        screenEnd.style.display = "none";
        screenQuiz.style.display = "block";
        renderQuestion();

        // تحديث اللوحة المباشرة باستمرار
        onValue(playersRef, (snap) => {
          const data = snap.val() || {};
          const arr = Object.values(data).sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );
          el("#leaderboardList").innerHTML = arr
            .map(
              (p) =>
                `<li>${escapeHtml(p.name || "لاعب")} - ${p.score || 0}</li>`
            )
            .join("");
        });
      }

      function renderQuestion() {
        if (qIndex >= shuffled.length) {
          // لو خلصت بنهاية الأسئلة
          finishQuizLocal();
          return;
        }
        const q = shuffled[qIndex];
        el("#questionText").textContent = q.q;
        el("#message").textContent = "";
        const opts = shuffle(q.opts);
        const wrap = el("#options");
        wrap.innerHTML = "";
        opts.forEach((op) => {
          const d = document.createElement("div");
          d.className = "option";
          d.textContent = op;
          d.onclick = () => onAnswer(op === q.a);
          wrap.appendChild(d);
        });
      }

      function onAnswer(correct) {
        if (correct) {
          score++;
          el("#message").textContent = "إجابة صحيحة ✅";
          el("#message").style.color = "green";
          sndCorrect.play().catch(() => {});
        } else {
          el("#message").textContent = "إجابة خاطئة ❌";
          el("#message").style.color = "#d00";
          sndWrong.play().catch(() => {});
        }
        // حدث النتيجة للسحابة — يجمع النقاط تبقى تراكمية
        if (playerId) {
          update(ref(db, `liveQuiz/players/${playerId}`), {
            score,
            lastSeen: serverTimestamp(),
          });
        }
        qIndex++;
        setTimeout(() => {
          if (Date.now() < quizEndAt) renderQuestion();
          else finishQuizLocal();
        }, 700);
      }

      function finishQuizLocal() {
        screenQuiz.style.display = "none";
        screenEnd.style.display = "block";
        el("#finalScore").textContent = `${score} / ${shuffled.length}`;
        // اعرض الترتيب النهائي لمرة واحدة
        onValue(
          playersRef,
          (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );
            el("#finalBoard").innerHTML = arr
              .map(
                (p) =>
                  `<li>${escapeHtml(p.name || "لاعب")} - ${p.score || 0}</li>`
              )
              .join("");
          },
          { onlyOnce: true }
        );
      }

      function endScreen() {
        screenLobby.style.display = "none";
        screenQuiz.style.display = "none";
        screenEnd.style.display = "block";
      }

      // تشجيع صوتي على المتصدر كل 30 ثانية (قابل للتعديل)
      let lastTop = null;
      setInterval(() => {
        if (!voiceEnabled) return;
        onValue(
          playersRef,
          (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );
            if (arr.length === 0) return;
            const top = arr[0];
            if (!top) return;
            if (top.name === lastTop) return;
            lastTop = top.name; // تحدث فقط لو تغير المتصدر
            const text = `برافو يا ${top.name}! إنت متصدر المسابقة دلوقتي`;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "ar-EG";
            u.rate = 0.95;
            u.pitch = 1;
            try {
              window.speechSynthesis.cancel();
              window.speechSynthesis.speak(u);
            } catch (e) {}
          },
          { onlyOnce: true }
        );
      }, 30000);

      // أدوات مساعدة
      function escapeHtml(s) {
        return (s || "")
          .toString()
          .replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
      }
      function shuffle(a) {
        return a.slice().sort(() => Math.random() - 0.5);
      }

      // أدوات سريعة للـ admin في الكونسول
      window.firebaseStart = async () => {
        await runTransaction(statusRef, (cur) => {
          if (cur === "waiting" || cur === null) return "countdown";
          return cur;
        });
        await update(lobbyRef, { lobbyCountdownStartsAt: serverTimestamp() });
      };
      window.firebaseForceStart = async () => {
        await set(statusRef, "started");
        await update(lobbyRef, { quizStartsAt: serverTimestamp() });
      };
      window.firebaseEnd = async () => {
        await set(statusRef, "ended");
      };
    </script>
  </body>
</html>
