<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      body {
        font-family: Tahoma, sans-serif;
        margin: 0;
        background: #f9f9f9;
        text-align: center;
      }
      header {
        background: #007bff;
        color: white;
        padding: 20px;
        font-size: 22px;
      }
      .container {
        padding: 20px;
        max-width: 600px;
        margin: auto;
      }
      input,
      button,
      select {
        padding: 10px;
        margin: 5px;
        font-size: 16px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      #adminPanel {
        display: none;
        padding: 10px;
        background: #eee;
        border-radius: 10px;
        margin: 20px 0;
      }
      #questions,
      #waitingScreen,
      #winnerScreen {
        display: none;
      }
      #leaderboard {
        margin-top: 20px;
        background: #fff;
        padding: 10px;
        border-radius: 8px;
      }
      .lock {
        position: fixed;
        bottom: 20px;
        right: 20px;
        font-size: 28px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</header>

    <div class="container">
      <div id="welcomeScreen">
        <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</h2>
        <h3 id="topicLabel"></h3>
        <input type="text" id="playerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
        <button onclick="joinGame()">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
      </div>

      <div id="waitingScreen">
        <h2>Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø£Ø³Ø¦Ù„ØªÙƒ âœ…</h2>
        <p>Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù†ØªØ¸Ø± Ø¨Ø§Ù‚ÙŠ Ø²Ù…Ù„Ø§Ø¦Ùƒ...</p>
      </div>

      <div id="questions"></div>

      <div id="leaderboard">
        <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
        <ul id="ranking"></ul>
      </div>

      <div id="winnerScreen">
        <h2 id="winnerMsg"></h2>
      </div>

      <div id="adminPanel">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
        <label>Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø­ÙˆØ±:</label>
        <select id="topicSelect">
          <option value="Ø­Ø§Ø³Ø¨">Ø­Ø§Ø³Ø¨</option>
          <option value="Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ">Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</option>
          <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option></select
        ><br />
        <button onclick="startCompetition()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
        <button onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚</button>
        <p>
          Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="gameStatus">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</span>
        </p>
      </div>
    </div>

    <div class="lock" onclick="openAdminLogin()">ğŸ”’</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        update,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

      // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.appspot.com",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let playerName = "";
      let playerScore = 0;
      let currentQuestion = 0;
      const questions = [
        { q: "2 + 2 = ?", options: ["3", "4", "5"], correct: 1 },
        {
          q: "Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ",
          options: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø®Ø±Ø·ÙˆÙ…"],
          correct: 0,
        },
        {
          q: "HTML ØªØ³ØªØ®Ø¯Ù… ÙÙŠØŸ",
          options: ["Ø§Ù„Ø·Ø¨Ø®", "Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©", "Ø§Ù„Ø±Ø³Ù…"],
          correct: 1,
        },
      ];

      // Ø¯Ø®ÙˆÙ„ Ù…Ø´Ø§Ø±Ùƒ
      window.joinGame = async function () {
        playerName = document.getElementById("playerName").value.trim();
        if (!playerName) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");
        await set(ref(db, "players/" + playerName), {
          score: 0,
          finished: false,
        });
        document.getElementById("welcomeScreen").style.display = "none";
        showQuestion();
      };

      // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      function showQuestion() {
        if (currentQuestion >= questions.length) {
          update(ref(db, "players/" + playerName), {
            score: playerScore,
            finished: true,
          });
          document.getElementById("questions").style.display = "none";
          document.getElementById("waitingScreen").style.display = "block";
          checkAllFinished();
          return;
        }
        let q = questions[currentQuestion];
        let html = `<h3>${q.q}</h3>`;
        q.options.forEach((opt, i) => {
          html += `<button onclick="answer(${i})">${opt}</button><br>`;
        });
        document.getElementById("questions").innerHTML = html;
        document.getElementById("questions").style.display = "block";
      }

      // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
      window.answer = function (i) {
        if (i === questions[currentQuestion].correct) playerScore++;
        currentQuestion++;
        showQuestion();
      };

      // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
      const rankingRef = ref(db, "players");
      onValue(rankingRef, (snap) => {
        const data = snap.val() || {};
        let arr = Object.entries(data).map(([name, v]) => ({
          name,
          score: v.score,
        }));
        arr.sort((a, b) => b.score - a.score);
        document.getElementById("ranking").innerHTML = arr
          .map((p) => `<li>${p.name}: ${p.score}</li>`)
          .join("");
      });

      // Ù„Ùˆ ÙƒÙ„Ù‡Ù… Ø®Ù„ØµÙˆØ§
      function checkAllFinished() {
        get(rankingRef).then((snap) => {
          const data = snap.val() || {};
          if (
            Object.values(data).length &&
            Object.values(data).every((p) => p.finished)
          ) {
            update(ref(db, "game"), { status: "ended" });
            showWinner(data);
          }
        });
      }

      // Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø²
      function showWinner(data) {
        let arr = Object.entries(data).map(([n, v]) => ({
          name: n,
          score: v.score,
        }));
        arr.sort((a, b) => b.score - a.score);
        let top = arr[0];
        document.getElementById(
          "winnerMsg"
        ).innerText = `ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ ${top.name} Ø¨Ø¯Ø±Ø¬Ø© ${top.score}!`;
        document.getElementById("winnerScreen").style.display = "block";
        confetti();
        setTimeout(() => location.reload(), 10000); // Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ ÙŠØ±Ø¬Ø¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      }

      // Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
      window.openAdminLogin = function () {
        let pass = prompt("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:");
        if (pass === "admin123") {
          document.getElementById("adminPanel").style.display = "block";
        }
      };
      window.closeAdmin = function () {
        document.getElementById("adminPanel").style.display = "none";
      };
      window.startCompetition = function () {
        let topic = document.getElementById("topicSelect").value;
        set(ref(db, "game"), { status: "running", topic });
        document.getElementById("gameStatus").innerText = "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©";
        document.getElementById("topicLabel").innerText = "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: " + topic;
      };

      // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
      const gameRef = ref(db, "game");
      onValue(gameRef, (snap) => {
        let g = snap.val();
        if (!g) return;
        let status = g.status;
        if (status === "waiting")
          document.getElementById("gameStatus").innerText =
            "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©";
        if (status === "running")
          document.getElementById("gameStatus").innerText = "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©";
        if (status === "ended")
          document.getElementById("gameStatus").innerText = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©";
        if (g.topic)
          document.getElementById("topicLabel").innerText =
            "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: " + g.topic;
      });
    </script>
  </body>
</html>
