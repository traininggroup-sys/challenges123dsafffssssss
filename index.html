<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مسابقة أعضاء جروب المشتركين للتدريب</title>
    <style>
      body {
        font-family: Cairo, sans-serif;
        background: #f0f0f0;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 700px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      #adminPanel {
        display: none;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        background: #e0e0e0;
      }
      #competition {
        display: none;
        margin-top: 20px;
      }
      .question {
        margin: 20px 0;
      }
      #leaderboard {
        margin-top: 20px;
      }
      #celebration {
        display: none;
        font-size: 24px;
        color: green;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>أهلاً بكم في المسابقة! <span id="competitionTopic"></span></h2>

      <div id="loginForm">
        <input type="text" id="username" placeholder="اكتب اسمك" />
        <button onclick="joinCompetition()">المشاركة</button>
        <button onclick="showAdmin()">دخول كمراقب</button>
      </div>

      <div id="adminLogin" style="display: none">
        <input type="email" id="adminEmail" placeholder="البريد الإلكتروني" />
        <input type="password" id="adminPassword" placeholder="كلمة السر" />
        <button onclick="loginAdmin()">دخول</button>
      </div>

      <div id="adminPanel">
        <h3>لوحة الأدمن</h3>
        <p>حدد محور المسابقة وعدد الأسئلة وعدد المتسابقين:</p>
        <input type="text" id="topic" placeholder="مثال: إنجليزي" />
        <input
          type="number"
          id="numQuestions"
          placeholder="عدد الأسئلة"
          min="1"
          max="20"
        />
        <input
          type="number"
          id="numPlayers"
          placeholder="عدد المتسابقين المطلوب"
          min="1"
          max="50"
        />
        <button onclick="setCompetition()">تأكيد الإعدادات</button>
        <div id="adminStatus"></div>
      </div>

      <div id="competition">
        <h3 id="questionText"></h3>
        <div id="options"></div>
        <p id="status"></p>
      </div>

      <div id="leaderboard">
        <h3>الترتيب المباشر:</h3>
        <ul id="rankList"></ul>
      </div>

      <div id="celebration">🎉 الفائز: <span id="winnerName"></span> 🎉</div>
    </div>

    <audio id="cheerAudio">
      <source src="cheer.mp3" type="audio/mpeg" />
    </audio>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script>
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyDUMMY",
        authDomain: "test-competion.firebaseapp.com",
        projectId: "test-competion",
        storageBucket: "test-competion.appspot.com",
        messagingSenderId: "1234567890",
        appId: "1:1234567890:web:abcd",
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      // ==== بيانات الأسئلة التجريبية ====
      const allQuestions = [
        {
          q: "ما هي عاصمة مصر؟",
          options: ["القاهرة", "الإسكندرية", "أسوان", "الأقصر"],
          answer: 0,
        },
        {
          q: "كم عدد الأهرامات الرئيسية في الجيزة؟",
          options: [1, 2, 3, 4],
          answer: 2,
        },
        {
          q: "ما لون السماء؟",
          options: ["أحمر", "أزرق", "أخضر", "أسود"],
          answer: 1,
        },
        { q: "كم عدد أيام الأسبوع؟", options: [5, 6, 7, 8], answer: 2 },
        {
          q: "ما هو أسرع حيوان على الأرض؟",
          options: ["الأسد", "الفهد", "الحصان", "الكلب"],
          answer: 1,
        },
        {
          q: "ما هي لغة البرمجة الأكثر شعبية؟",
          options: ["Python", "C++", "Java", "HTML"],
          answer: 0,
        },
        {
          q: "أي الكواكب أقرب للشمس؟",
          options: ["المريخ", "الأرض", "عطارد", "الزهرة"],
          answer: 2,
        },
        {
          q: "ما هو أكبر محيط في العالم؟",
          options: ["الأطلسي", "الهادئ", "الهندي", "المتجمد"],
          answer: 1,
        },
      ];

      let currentUser = "";
      let currentQuestion = 0;
      let score = 0;
      let players = [];
      let competitionStarted = false;
      let competitionSettings = { topic: "", numQuestions: 5, numPlayers: 5 };

      // ==== المشاركة ====
      function joinCompetition() {
        const name = document.getElementById("username").value.trim();
        if (!name) {
          alert("اكتبي اسمك");
          return;
        }
        if (players.includes(name)) {
          alert("هذا الاسم مسجل بالفعل");
          return;
        }
        players.push(name);
        currentUser = name;
        document.getElementById("loginForm").style.display = "none";
        document.getElementById(
          "status"
        ).textContent = `انتظار باقي المتسابقين... (${players.length}/${competitionSettings.numPlayers})`;
        checkStartCompetition();
      }

      // ==== بدء المسابقة تلقائي ====
      function checkStartCompetition() {
        if (
          players.length >= competitionSettings.numPlayers &&
          !competitionStarted
        ) {
          competitionStarted = true;
          startCompetition();
          startCheer(); // بدء الأصوات
        }
      }

      // ==== المسابقة ====
      let questions = [];
      function startCompetition() {
        questions = shuffleArray(allQuestions).slice(
          0,
          competitionSettings.numQuestions
        );
        document.getElementById("competitionTopic").textContent =
          competitionSettings.topic;
        document.getElementById("competition").style.display = "block";
        currentQuestion = 0;
        score = 0;
        showQuestion();
        updateLeaderboard();
      }

      function showQuestion() {
        if (currentQuestion >= questions.length) {
          document.getElementById(
            "competition"
          ).innerHTML = `<h3>انتهت المسابقة! نتيجتك: ${score}</h3>`;
          checkEndCompetition();
          return;
        }
        const q = questions[currentQuestion];
        document.getElementById("questionText").textContent = q.q;
        const opts = document.getElementById("options");
        opts.innerHTML = "";
        q.options.forEach((o, i) => {
          const btn = document.createElement("button");
          btn.textContent = o;
          btn.onclick = () => {
            checkAnswer(i);
          };
          opts.appendChild(btn);
        });
      }

      function checkAnswer(selected) {
        if (selected === questions[currentQuestion].answer) score++;
        currentQuestion++;
        updateLeaderboard();
        showQuestion();
      }

      // ==== تحديث Leaderboard ====
      function updateLeaderboard() {
        const ul = document.getElementById("rankList");
        ul.innerHTML = "";
        const data = players
          .map((p) => {
            let s = p === currentUser ? score : 0;
            return { name: p, score: s };
          })
          .sort((a, b) => b.score - a.score);
        data.forEach((d) => {
          const li = document.createElement("li");
          li.textContent = `${d.name}: ${d.score}`;
          ul.appendChild(li);
        });
      }

      // ==== نهاية المسابقة ====
      function checkEndCompetition() {
        const maxScore = Math.max(
          ...players.map((p) => (p === currentUser ? score : 0))
        );
        document.getElementById("winnerName").textContent = currentUser;
        document.getElementById("celebration").style.display = "block";
        stopCheer();
      }

      // ==== الأصوات التشجيعية ====
      let cheerInterval;
      function startCheer() {
        const audio = document.getElementById("cheerAudio");
        cheerInterval = setInterval(() => {
          audio.play();
        }, 10000);
      }
      function stopCheer() {
        clearInterval(cheerInterval);
      }

      // ==== الأدمن باستخدام Firebase Auth ====
      function showAdmin() {
        document.getElementById("adminLogin").style.display = "block";
      }
      function loginAdmin() {
        const email = document.getElementById("adminEmail").value.trim();
        const pass = document.getElementById("adminPassword").value.trim();
        auth
          .signInWithEmailAndPassword(email, pass)
          .then((userCredential) => {
            document.getElementById("adminPanel").style.display = "block";
            document.getElementById("adminLogin").style.display = "none";
          })
          .catch((err) => alert("بيانات خاطئة!"));
      }

      function setCompetition() {
        const topic = document.getElementById("topic").value.trim();
        const numQ = parseInt(document.getElementById("numQuestions").value);
        const numP = parseInt(document.getElementById("numPlayers").value);
        if (!topic || !numQ || !numP) {
          alert("اكمل كل الحقول");
          return;
        }
        competitionSettings = {
          topic: topic,
          numQuestions: numQ,
          numPlayers: numP,
        };
        document.getElementById(
          "adminStatus"
        ).textContent = `تم الإعداد: محور=${topic}, الأسئلة=${numQ}, المتسابقين=${numP}`;
      }

      // ==== مساعدة ====
      function shuffleArray(array) {
        return array.sort(() => Math.random() - 0.5);
      }
    </script>
  </body>
</html>
