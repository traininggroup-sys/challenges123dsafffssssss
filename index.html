<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <!-- confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
      :root {
        --brand: #ff5722;
        --muted: #6b6b6b;
        --card: #fff;
        --success: #20a654;
        --danger: #d64545;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Cairo", sans-serif;
        margin: 0;
        background: linear-gradient(180deg, #071426, #0b2b46);
        color: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 18px;
      }
      .app {
        width: 100%;
        max-width: 1150px;
        background: linear-gradient(180deg, #fff, #fafafa);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(90deg, var(--brand), #ff8a50);
        color: #fff;
      }
      header h1 {
        margin: 0;
        font-size: 18px;
      }
      header .small {
        font-size: 13px;
        opacity: 0.95;
      }
      main {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 16px;
        padding: 18px;
      }
      @media (max-width: 980px) {
        main {
          grid-template-columns: 1fr;
          padding: 12px;
        }
        .aside {
          order: 2;
        }
      }

      .card {
        background: var(--card);
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      }
      .welcome {
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .input {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #eee;
        width: 260px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.ghost {
        background: transparent;
        border: 2px solid var(--brand);
        color: var(--brand);
      }
      .meta {
        color: var(--muted);
        font-size: 13px;
      }

      .quiz-top {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: flex-start;
      }
      .question {
        font-size: 20px;
        margin: 12px 0;
      }
      .options {
        display: grid;
        gap: 10px;
      }
      .option {
        padding: 12px;
        border-radius: 10px;
        background: #fafafa;
        border: 2px solid transparent;
        cursor: pointer;
        font-weight: 700;
        text-align: center;
        transition: all 0.16s;
      }
      .option:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.06);
      }
      .option.correct {
        background: #e8f8ef;
        border-color: var(--success);
      }
      .option.wrong {
        background: #ffecec;
        border-color: var(--danger);
      }
      .progress {
        height: 10px;
        background: #eee;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 10px;
      }
      .progress > i {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--brand), #ff8a50);
        width: 0%;
      }
      .timerWrap {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .circle {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-weight: 800;
        color: var(--brand);
        background: conic-gradient(var(--brand) 0deg, #eee 0deg);
      }

      .aside .leaders {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .leader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        background: linear-gradient(180deg, #fff, #fafafa);
        font-weight: 700;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
      }
      .rank1 {
        background: linear-gradient(90deg, #ffd700, #ffcf5b);
      }
      .rank2 {
        background: linear-gradient(90deg, #c0c0c0, #e6e6e6);
      }
      .rank3 {
        background: linear-gradient(90deg, #cd7f32, #e0a67a);
      }
      .smallMuted {
        font-size: 13px;
        color: var(--muted);
      }

      footer {
        padding: 10px 16px;
        background: #fff;
        border-top: 1px solid #f2f2f2;
        text-align: center;
        font-size: 13px;
        color: #333;
      }

      /* admin */
      .admin-trigger {
        position: fixed;
        left: 12px;
        bottom: 12px;
        z-index: 1000;
        opacity: 0.95;
        cursor: pointer;
      }
      .admin-modal {
        position: fixed;
        right: 14px;
        top: 14px;
        width: 420px;
        max-width: calc(100% - 28px);
        background: #fff;
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        display: none;
        z-index: 1100;
      }
      .admin-modal.open {
        display: block;
      }
      .form-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin: 8px 0;
      }
      .small-btn {
        padding: 8px 10px;
        background: var(--brand);
        color: #fff;
        border-radius: 8px;
        border: none;
        cursor: pointer;
      }
      .close-admin {
        background: #ddd;
        color: #111;
      }
      .muted-small {
        font-size: 13px;
        color: #666;
      }
      .celebration {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        z-index: 1200;
        pointer-events: none;
      }
      .celebration .box {
        background: rgba(255, 255, 255, 0.98);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        text-align: center;
      }
      .wait-box {
        display: grid;
        place-items: center;
        padding: 18px;
      }
      .hidden {
        display: none;
      }
      .badge {
        background: #eee;
        padding: 6px 8px;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div class="app" role="application">
      <header>
        <div>
          <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</h1>
          <div class="small muted-small" id="topicLabel">Ø§Ù„Ù…Ø­ÙˆØ±: Ø¹Ø§Ù…</div>
        </div>
        <div class="small muted-small">
          Ø§Ù„Ø­Ø§Ù„Ø©: <span id="statusLabel">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯</span>
        </div>
      </header>

      <main>
        <!-- LEFT -->
        <section>
          <!-- Welcome -->
          <div id="welcomeCard" class="card welcome">
            <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</h2>
            <p class="meta" id="welcomeMeta">
              Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø¶ØºØ·ÙŠ Ù…Ø´Ø§Ø±ÙƒØ© â€” Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø³ØªØ¨Ø¯Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„
              Ø§Ù„Ø¹Ø¯Ø¯.
            </p>
            <input
              id="nameInput"
              class="input"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯)"
            />
            <div
              style="
                margin-top: 12px;
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
              "
            >
              <button id="joinBtn" class="btn">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
            </div>
            <div style="margin-top: 12px" class="meta">
              Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†: <span id="playersCount">0</span>
            </div>

            <div id="waitingBox" style="margin-top: 14px" class="hidden">
              <div class="wait-box card">
                <div id="waitingText">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯...</div>
                <div style="margin-top: 8px" class="meta">
                  Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <b id="requiredCount">â€”</b>
                </div>
                <div style="margin-top: 8px" class="progress" aria-hidden>
                  <i id="waitingProgress" style="width: 0%"></i>
                </div>
                <div style="margin-top: 8px" class="meta">
                  Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ø´Ø§Ø·: ÙŠÙØ³ØªØ¨Ø¹Ø¯ Ù…Ù† Ù„Ù… ÙŠØ´Ø§Ø±Ùƒ Ù…Ù†Ø° Ø²Ù…Ù† Ø·ÙˆÙŠÙ„
                </div>
              </div>
            </div>
          </div>

          <!-- Quiz -->
          <div id="quizCard" class="card hidden">
            <div class="quiz-top">
              <div style="flex: 1">
                <div id="progressText" class="smallMuted">Ø³Ø¤Ø§Ù„ 0 / 0</div>
                <div id="questionText" class="question">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
                <div id="hint" class="meta"></div>
                <div class="progress" aria-hidden><i id="progressBar"></i></div>
              </div>
              <div class="timerWrap">
                <div class="circle" id="circleTimer">--</div>
                <div style="text-align: right">
                  <div class="smallMuted">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
                  <div
                    id="timeText"
                    style="font-weight: 800; color: var(--brand)"
                  >
                    --
                  </div>
                </div>
              </div>
            </div>

            <div id="options" class="options" style="margin-top: 12px"></div>
            <div id="feedback" class="meta" style="margin-top: 10px"></div>

            <div id="doneBox" class="card hidden" style="margin-top: 12px">
              <div class="wait-box">
                <div><strong>âœ… Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø¥Ø¬Ø§Ø¨ØªÙƒ.</strong></div>
                <div class="meta" style="margin-top: 8px">
                  Ø§Ù†ØªØ¸Ø±ÙŠ Ø¨Ø§Ù‚ÙŠ Ø²Ù…Ù„Ø§Ø¦Ùƒ Ù„ÙŠÙ†ØªÙ‡ÙˆØ§ØŒ Ø«Ù… Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ù„.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT -->
        <aside class="aside">
          <div class="card">
            <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
            <ol id="leaderList" class="leaders" style="margin-top: 10px"></ol>
            <div style="margin-top: 12px" class="smallMuted">
              Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙˆÙ† ÙŠØ¸Ù‡Ø±ÙˆÙ† Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹
            </div>
          </div>

          <div class="card" style="margin-top: 12px">
            <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
            <div class="smallMuted">
              Ø§Ù„Ø­Ø§Ù„Ø©: <b id="statusShort">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±</b>
            </div>
            <div style="margin-top: 6px" class="smallMuted">
              Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒÙ„ÙŠ: <b id="totalTimeLabel">â€”</b>
            </div>
            <div style="margin-top: 6px" class="smallMuted">
              Ø§Ù„Ù…ØªØµØ¯Ø±: <b id="topBadge">â€”</b>
            </div>
          </div>
        </aside>
      </main>

      <footer>Â© Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</footer>
    </div>

    <!-- admin trigger -->
    <div id="adminTrigger" class="admin-trigger" title="ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
        <rect
          x="3"
          y="7"
          width="18"
          height="13"
          rx="2"
          stroke="#fff"
          stroke-width="1.6"
        />
        <path d="M7 7V6a5 5 0 0110 0v1" stroke="#fff" stroke-width="1.6" />
      </svg>
    </div>

    <!-- admin modal -->
    <div id="adminModal" class="admin-modal" aria-hidden="true">
      <div id="adminLoginBox">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
        <div class="form-row">
          <input
            id="adminUser"
            placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†"
            style="
              flex: 1;
              padding: 8px;
              border: 1px solid #eee;
              border-radius: 8px;
            "
          />
        </div>
        <div class="form-row">
          <input
            id="adminPass"
            placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"
            type="password"
            style="
              flex: 1;
              padding: 8px;
              border: 1px solid #eee;
              border-radius: 8px;
            "
          />
        </div>
        <div class="form-row">
          <button id="adminLoginBtn" class="small-btn">Ø¯Ø®ÙˆÙ„</button
          ><button id="adminCloseBtn" class="small-btn close-admin">
            Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>
        <div id="adminError" style="color: #c00; margin-top: 6px"></div>
      </div>

      <div id="adminPanelBox" style="display: none">
        <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
        <div class="form-row">
          <label style="flex: 1"
            >Ø§Ù„Ù…Ø­ÙˆØ± (topic)<input
              id="adminTopic"
              placeholder="Ù…Ø«Ø§Ù„: Ø­Ø§Ø³Ø¨/Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ"
              style="width: 160px; margin-left: 8px; padding: 6px"
          /></label>
        </div>
        <div class="form-row">
          <label style="flex: 1"
            >Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨<input
              id="adminMax"
              type="number"
              min="2"
              value="5"
              style="width: 110px; margin-left: 8px; padding: 6px"
          /></label>
        </div>
        <div class="form-row">
          <label style="flex: 1"
            >Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚<input
              id="adminDuration"
              type="number"
              min="1"
              value="5"
              style="width: 110px; margin-left: 8px; padding: 6px"
          /></label>
        </div>

        <div style="display: flex; gap: 8px; margin-top: 8px">
          <button id="saveSettingsBtn" class="small-btn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <button id="adminForceStartBtn" class="small-btn">Ø¨Ø¯Ø¡ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</button>
          <button
            id="adminEndBtn"
            class="small-btn close-admin"
            style="background: #c0392b"
          >
            Ø¥Ù†Ù‡Ø§Ø¡
          </button>
          <button id="adminClearBtn" class="small-btn" style="background: #666">
            Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
          </button>
        </div>

        <div style="margin-top: 10px">
          <button
            id="closePanelBtn"
            class="small-btn close-admin"
            style="background: #ddd; color: #111"
          >
            Close
          </button>
          <button id="downloadCSV" class="small-btn" style="background: #2d7">
            ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ CSV
          </button>
        </div>

        <div style="margin-top: 8px" class="muted-small">
          Ù…Ù„Ø§Ø­Ø¸Ø©: Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø³ÙŠØ·Ø©. ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Firebase Auth Ù„Ø§Ø­Ù‚Ù‹Ø§.
        </div>
      </div>
    </div>

    <!-- celebration overlay -->
    <div
      id="celebration"
      class="celebration"
      style="display: none; pointer-events: none"
    >
      <div class="box">
        <h2 id="winnerText">Ø§Ù„ÙØ§Ø¦Ø²: â€”</h2>
        <p class="smallMuted">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø§Ù„Ø§Ø­ØªÙØ§Ù„ Ø¬Ø§Ø±Ù...</p>
      </div>
    </div>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      /* ================ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ================ */
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      /* ================ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ================ */
      const ADMIN_USER = "Eman";
      const ADMIN_PASS = "admin123"; // ØºÙŠÙ‘Ø±ÙŠÙ‡Ø§ Ù„Ùˆ Ø­Ø¨ÙŠØªÙŠ

      /* ================ Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ© (Ø¹Ø¯Ù‘Ù„ÙŠÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯) ================ */
      const QUESTIONS = [
        {
          q: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ",
          opts: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„Ø³ÙˆÙŠØ³"],
          a: 0,
        },
        { q: "2 + 2 = ?", opts: ["3", "4", "5", "6"], a: 1 },
        {
          q: "Ù…Ø§ Ù„ÙˆÙ† Ø§Ù„Ø³Ù…Ø§Ø¡ ÙŠÙˆÙ… ØµØ§ÙÙØŸ",
          opts: ["Ø£Ø²Ø±Ù‚", "Ø£Ø³ÙˆØ¯", "Ø£Ø®Ø¶Ø±", "Ø£Ø­Ù…Ø±"],
          a: 0,
        },
        {
          q: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ØŸ",
          opts: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø§Ù„Ø²Ù‡Ø±Ø©"],
          a: 1,
        },
      ];

      /* ================ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ================ */
      const $ = (s) => document.querySelector(s);
      const nameInput = $("#nameInput"),
        joinBtn = $("#joinBtn"),
        welcomeCard = $("#welcomeCard");
      const waitingBox = $("#waitingBox"),
        waitingText = $("#waitingText"),
        waitingProgress = $("#waitingProgress");
      const requiredCountEl = $("#requiredCount"),
        playersCountEl = $("#playersCount");
      const quizCard = $("#quizCard"),
        questionText = $("#questionText"),
        optionsWrap = $("#options"),
        progressBar = $("#progressBar"),
        progressText = $("#progressText");
      const circleTimer = $("#circleTimer"),
        timeText = $("#timeText"),
        feedback = $("#feedback"),
        doneBox = $("#doneBox");
      const leaderList = $("#leaderList"),
        topBadge = $("#topBadge"),
        statusLabel = $("#statusLabel"),
        statusShort = $("#statusShort"),
        totalTimeLabel = $("#totalTimeLabel"),
        topicLabel = $("#topicLabel");
      const adminTrigger = $("#adminTrigger"),
        adminModal = $("#adminModal"),
        adminLoginBox = $("#adminLoginBox"),
        adminPanelBox = $("#adminPanelBox");
      const adminUser = $("#adminUser"),
        adminPass = $("#adminPass"),
        adminLoginBtn = $("#adminLoginBtn"),
        adminCloseBtn = $("#adminCloseBtn");
      const saveSettingsBtn = $("#saveSettingsBtn"),
        adminForceStartBtn = $("#adminForceStartBtn"),
        adminEndBtn = $("#adminEndBtn"),
        adminClearBtn = $("#adminClearBtn");
      const adminMax = $("#adminMax"),
        adminDuration = $("#adminDuration"),
        adminTopic = $("#adminTopic"),
        closePanelBtn = $("#closePanelBtn"),
        downloadCSV = $("#downloadCSV");
      const celebration = $("#celebration"),
        winnerText = $("#winnerText");

      /* ================ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ================ */
      let playerKey = null,
        playerName = "",
        shuffled = [],
        localIndex = 0,
        localScore = 0;
      let totalSeconds = 300,
        maxParticipants = 5,
        topic = "Ø¹Ø§Ù…",
        status = "waiting",
        quizEndAt = null;
      let heartbeatInterval = null,
        lastSeenInterval = null;
      let audioUnlocked = false,
        cheerTimer = null;

      /* ================ Ø£ØµÙˆØ§Øª ================ */
      const sCorrect = new Audio(
        "https://cdn.pixabay.com/download/audio/2021/08/04/audio_6a0b0f24c1.mp3?filename=success-fanfare-trumpets-6185.mp3"
      );
      const sWrong = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_3f0a9a5e17.mp3?filename=wrong-buzzer-6266.mp3"
      );
      const sStart = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_1d8f3f9f2d.mp3?filename=short-whistle-6096.mp3"
      );
      const sEnd = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_1b5b8b5a3b.mp3?filename=bell-small-6282.mp3"
      );
      const sClap = new Audio(
        "https://cdn.pixabay.com/download/audio/2021/08/04/audio_6a0b0f24c1.mp3?filename=success-fanfare-trumpets-6185.mp3"
      );

      /* unlock audio on first interaction */
      document.addEventListener(
        "click",
        () => {
          if (!audioUnlocked) {
            [sCorrect, sWrong, sStart, sEnd, sClap].forEach((a) => {
              a.muted = false;
              a.play()
                .then(() => a.pause())
                .catch(() => {});
            });
            audioUnlocked = true;
          }
        },
        { once: true }
      );

      /* ================ Ù…Ø±Ø§Ø¬Ø¹ Firebase ================ */
      const liveRef = db.ref("liveQuiz"); // { status, settings:{ totalSeconds, maxParticipants, topic }, quizStartsAt, quizEndAt }
      const playersRef = db.ref("liveQuiz/players"); // players/{pushKey} = { name, score, currentQuestion, finished, lastSeen }

      /* ================ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ================ */
      adminTrigger.addEventListener("click", () =>
        adminModal.classList.toggle("open")
      );
      adminCloseBtn.addEventListener("click", () =>
        adminModal.classList.remove("open")
      );

      adminLoginBtn.addEventListener("click", () => {
        const u = adminUser.value.trim(),
          p = adminPass.value.trim();
        if (u === ADMIN_USER && p === ADMIN_PASS) {
          adminLoginBox.style.display = "none";
          adminPanelBox.style.display = "block";
          $("#adminError").innerText = "";
        } else {
          $("#adminError").innerText = "Ø§Ø³Ù…/ÙƒÙ„Ù…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
        }
      });
      closePanelBtn.addEventListener("click", () =>
        adminModal.classList.remove("open")
      );

      /* save settings */
      saveSettingsBtn.addEventListener("click", async () => {
        const mins = parseInt(adminDuration.value) || 5;
        totalSeconds = mins * 60;
        maxParticipants = parseInt(adminMax.value) || 5;
        topic = adminTopic.value.trim() || "Ø¹Ø§Ù…";
        await liveRef.update({
          settings: { totalSeconds, maxParticipants, topic },
        });
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
      });

      /* admin forced start */
      adminForceStartBtn.addEventListener("click", async () => {
        const now = Date.now();
        await liveRef.update({
          status: "started",
          quizStartsAt: now,
          quizEndAt: now + totalSeconds * 1000,
        });
        playStart();
      });

      /* admin end */
      adminEndBtn.addEventListener("click", async () => {
        await liveRef.update({ status: "ended", endedAt: Date.now() });
        stopCheer();
        performFinalization();
      });

      /* clear participants */
      adminClearBtn.addEventListener("click", async () => {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†ØŸ")) return;
        await playersRef.remove();
        alert("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
      });

      /* download CSV */
      downloadCSV.addEventListener("click", async () => {
        const snap = await playersRef.once("value");
        const data = snap.val() || {};
        const rows = [["name", "score"]];
        Object.values(data).forEach((p) =>
          rows.push([p.name || "", p.score || 0])
        );
        const csv = rows
          .map((r) =>
            r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `results_${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });

      /* ================ Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ================ */
      joinBtn.addEventListener("click", async () => {
        if (playerKey) return; // already joined
        const name = nameInput.value.trim();
        if (!name) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ù…Ù† ÙØ¶Ù„Ùƒ");
        // create push key
        const key = playersRef.push().key;
        playerKey = key;
        playerName = name;
        // initial write
        await db
          .ref(`liveQuiz/players/${playerKey}`)
          .set({
            name: playerName,
            score: 0,
            currentQuestion: 0,
            finished: false,
            lastSeen: Date.now(),
          });
        // ensure removal on disconnect
        db.ref(`liveQuiz/players/${playerKey}`).onDisconnect().remove();
        // set periodic heartbeat
        startHeartbeat();
        // hide welcome and show waiting UI (real switch will happen when status changes)
        welcomeCard.style.display = "none";
        waitingBox.classList.remove("hidden");
      });

      /* heartbeat updates lastSeen */
      function startHeartbeat() {
        if (lastSeenInterval) clearInterval(lastSeenInterval);
        const update = () => {
          if (playerKey)
            db.ref(`liveQuiz/players/${playerKey}`).update({
              lastSeen: Date.now(),
            });
        };
        update();
        lastSeenInterval = setInterval(update, 10000); // every 10s
      }

      /* stop heartbeat */
      function stopHeartbeat() {
        if (lastSeenInterval) clearInterval(lastSeenInterval);
      }

      /* ================ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© ================ */
      /* Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
      liveRef.on("value", async (snap) => {
        const val = snap.val() || {};
        status = val.status || "waiting";
        const settings = val.settings || {};
        totalSeconds = settings.totalSeconds || totalSeconds;
        maxParticipants = settings.maxParticipants || maxParticipants;
        topic = settings.topic || topic;
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø©
        statusLabel.innerText = translateStatus(status);
        statusShort.innerText = translateStatusShort(status);
        totalTimeLabel.innerText = `${Math.round(totalSeconds / 60)} Ø¯Ù‚Ø§Ø¦Ù‚`;
        topicLabel.innerText = `Ø§Ù„Ù…Ø­ÙˆØ±: ${topic}`;
        requiredCountEl.innerText = maxParticipants;

        // Ø¥Ø°Ø§ Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        if (status === "started") {
          quizEndAt =
            val.quizEndAt ||
            (val.quizStartsAt || Date.now()) + totalSeconds * 1000;
          // Ø¥Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù†Ø¶Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ÙŠØ¯Ø®Ù„ Quiz
          if (playerKey) enterQuiz();
          startCheer();
        }

        if (status === "ended") {
          stopCheer();
          performFinalization();
        }
      });

      /* Ù†Ø±Ø§Ù‚Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆÙ†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø§Ù„ÙØ¹Ù„ÙŠÙŠÙ† (Ø­Ø³Ø¨ lastSeen) */
      playersRef.on("value", async (snap) => {
        const data = snap.val() || {};
        // filter active by lastSeen <= 45s
        const now = Date.now();
        const arr = Object.entries(data).map(([k, v]) => ({ key: k, ...v }));
        const active = arr.filter(
          (p) => p.lastSeen && now - p.lastSeen <= 45000
        ); // active within 45s
        // update UI counts
        playersCountEl.innerText = active.length;
        waitingProgress.style.width = `${Math.min(
          100,
          Math.round((active.length / maxParticipants) * 100)
        )}%`;
        waitingText.innerText = `Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†: ${active.length} / ${maxParticipants}`;

        // update leader list (global: sort by score)
        const sorted = arr
          .slice()
          .sort((a, b) => (b.score || 0) - (a.score || 0));
        leaderList.innerHTML = "";
        sorted.forEach((p, i) => {
          const li = document.createElement("li");
          li.className =
            "leader" +
            (i === 0 ? " rank1" : i === 1 ? " rank2" : i === 2 ? " rank3" : "");
          li.innerHTML = `<span>${escapeHtml(
            p.name
          )}</span><span class="badge">${p.score || 0}</span>`;
          leaderList.appendChild(li);
        });
        topBadge.innerText =
          sorted.length > 0
            ? `${sorted[0].name} (${sorted[0].score || 0})`
            : "â€”";

        // auto-start: Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© waiting ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù€ active >= maxParticipants
        const live = (await liveRef.once("value")).val() || {};
        if (
          (live.status || "waiting") === "waiting" &&
          active.length >= maxParticipants
        ) {
          // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          const nowMs = Date.now();
          await liveRef.update({
            status: "started",
            quizStartsAt: nowMs,
            quizEndAt: nowMs + totalSeconds * 1000,
          });
          playStart();
        }

        // auto-end: Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© started ÙˆÙƒÙ„ Ø§Ù„Ù€ active participants finished === true
        if ((await liveRef.once("value")).val().status === "started") {
          const activePlayers = active;
          if (
            activePlayers.length > 0 &&
            activePlayers.every((p) => p.finished === true)
          ) {
            await liveRef.update({ status: "ended", endedAt: Date.now() });
          }
        }
      });

      /* ================ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ Ø¨Ø¹Ø¯ start ================ */
      async function enterQuiz() {
        // load player record
        const snap = await db
          .ref(`liveQuiz/players/${playerKey}`)
          .once("value");
        const v = snap.val() || {};
        localScore = v.score || 0;
        localIndex = v.currentQuestion || 0;
        shuffled = shuffleArray(QUESTIONS);
        // ØªØ­ÙƒÙ… Ø¨Ù€ UI
        waitingBox.classList.add("hidden");
        quizCard.classList.remove("hidden");
        doneBox.classList.add("hidden");
        startGlobalTimer();
        renderQuestion();
      }

      /* ================= Timer Ø³Ø¨Ø¹Ø© ================= */
      let globalTimer = null;
      function startGlobalTimer() {
        clearInterval(globalTimer);
        if (!quizEndAt) quizEndAt = Date.now() + totalSeconds * 1000;
        globalTimer = setInterval(() => {
          const remainMs = Math.max(0, quizEndAt - Date.now());
          const remainSec = Math.ceil(remainMs / 1000);
          const m = Math.floor(remainSec / 60),
            s = remainSec % 60;
          timeText.innerText = `${m}:${s.toString().padStart(2, "0")}`;
          const elapsed = Math.max(0, totalSeconds * 1000 - remainMs);
          const pct = Math.min(
            100,
            Math.round((elapsed / (totalSeconds * 1000)) * 100)
          );
          circleTimer.style.background = `conic-gradient(var(--brand) ${
            pct * 3.6
          }deg, #eee ${pct * 3.6}deg)`;
          circleTimer.innerText = remainSec;
          progressText.innerText = `Ø³Ø¤Ø§Ù„ ${Math.min(
            localIndex + 1,
            QUESTIONS.length
          )} / ${QUESTIONS.length}`;
          progressBar.style.width = `${Math.round(
            (localIndex / QUESTIONS.length) * 100
          )}%`;
          if (remainSec <= 0) {
            clearInterval(globalTimer);
            if (playerKey)
              db.ref(`liveQuiz/players/${playerKey}`).update({
                finished: true,
              });
            liveRef.update({ status: "ended", endedAt: Date.now() });
          }
        }, 500);
      }

      /* ================ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ùˆ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ================ */
      let optionLock = false;
      function renderQuestion() {
        feedback.innerText = "";
        doneBox.classList.add("hidden");
        if (localIndex >= shuffled.length) {
          finishLocal();
          return;
        }
        const q = shuffled[localIndex];
        questionText.innerText = q.q;
        optionsWrap.innerHTML = "";
        const opts = shuffleArray(q.opts.map((o, i) => ({ o, i })));
        opts.forEach((it) => {
          const div = document.createElement("div");
          div.className = "option";
          div.innerText = it.o;
          div.onclick = () => {
            if (optionLock) return;
            optionLock = true;
            handleAnswer(it.i, div);
          };
          optionsWrap.appendChild(div);
        });
      }

      async function handleAnswer(chosenIndex, btn) {
        const q = shuffled[localIndex];
        const real = q.a;
        if (chosenIndex === real) {
          btn.classList.add("correct");
          feedback.innerText = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
          localScore++;
          sCorrect.play().catch(() => {});
        } else {
          btn.classList.add("wrong");
          feedback.innerText = `Ø®Ø·Ø£ âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.opts[real]}`;
          sWrong.play().catch(() => {});
          Array.from(optionsWrap.children).forEach((c) => {
            if (c.innerText === q.opts[real]) c.classList.add("correct");
          });
        }
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø­Ø¯ ÙÙŠ DB
        await db
          .ref(`liveQuiz/players/${playerKey}`)
          .update({
            score: localScore,
            currentQuestion: localIndex + 1,
            lastSeen: Date.now(),
          });
        localIndex++;
        setTimeout(() => {
          optionLock = false;
          if (Date.now() < quizEndAt) renderQuestion();
          else finishLocal();
        }, 900);
      }

      /* ================ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø§Ù„Ù…Ø­Ù„ÙŠ ================ */
      function finishLocal() {
        feedback.innerText = "Ø§Ù†ØªÙ‡ÙŠØª â€” Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©";
        optionsWrap.innerHTML = "";
        doneBox.classList.remove("hidden");
        if (playerKey)
          db.ref(`liveQuiz/players/${playerKey}`).update({ finished: true });
      }

      /* ================ Cheer speech ================= */
      function startCheer() {
        stopCheer();
        if (!audioUnlocked) return;
        cheerTimer = setInterval(() => {
          // announce top
          playersRef.once("value").then((snap) => {
            const data = snap.val() || {};
            const arr = Object.entries(data)
              .map(([k, v]) => ({ key: k, name: v.name, score: v.score || 0 }))
              .sort((a, b) => b.score - a.score);
            if (arr.length === 0) return;
            const top = arr[0];
            speakRandomTop(top.name);
          });
        }, 30000);
      }
      function stopCheer() {
        if (cheerTimer) {
          clearInterval(cheerTimer);
          cheerTimer = null;
        }
      }
      function speakRandomTop(name) {
        if (!audioUnlocked) return;
        const msgs = [
          `Ø¨Ø±Ø§ÙÙˆ ÙŠØ§ ${name}! Ø§Ù†Øª Ù…ØªØµØ¯Ø± Ø¯Ù„ÙˆÙ‚ØªÙŠ`,
          `Ø§Ø³ØªÙ…Ø± ÙŠØ§ ${name}ØŒ Ù‚Ø¯Ø§Ù…Ùƒ Ù…Ù†Ø§ÙØ³Ø©`,
          `ÙŠØ§ Ø³Ù„Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø´ØºÙ„ ÙŠØ§ ${name}`,
        ];
        speak(msgs[Math.floor(Math.random() * msgs.length)]);
      }
      function speak(txt) {
        try {
          const u = new SpeechSynthesisUtterance(txt);
          u.lang = "ar-EG";
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        } catch (e) {}
      }
      function playStart() {
        sStart.play().catch(() => {});
      }
      function playEnd() {
        sEnd.play().catch(() => {});
      }

      /* ================ Finalize: save results, celebrate, reset ================ */
      async function performFinalization() {
        // collect snapshot
        const snap = await playersRef.once("value");
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([k, v]) => ({
          key: k,
          name: v.name,
          score: v.score || 0,
        }));
        arr.sort((a, b) => b.score - a.score);
        if (arr.length === 0) {
          // reset status to waiting
          await liveRef.update({ status: "waiting" });
          await playersRef.remove();
          return;
        }
        const top = arr[0];
        // save snapshot under results
        await db
          .ref("results")
          .push({ timestamp: Date.now(), topic, totalSeconds, standings: arr });
        // show celebration
        winnerText.innerText = `Ø§Ù„ÙØ§Ø¦Ø²: ${top.name} â€” ${top.score} Ù†Ù‚Ø·Ø© ğŸ†`;
        celebration.style.display = "grid";
        confetti({ particleCount: 250, spread: 80, origin: { y: 0.2 } });
        playEnd();
        sClap.play().catch(() => {});
        // after delay hide and reset for next round
        setTimeout(async () => {
          celebration.style.display = "none";
          // set status waiting and clear players
          await liveRef.update({ status: "waiting" });
          // remove players to start fresh
          await playersRef.remove();
        }, 6000);
      }

      /* ================ Utilities ================ */
      function shuffleArray(a) {
        return a.slice().sort(() => Math.random() - 0.5);
      }
      function escapeHtml(s) {
        return (s || "")
          .toString()
          .replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
      }
      function translateStatus(s) {
        if (s === "waiting") return "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯";
        if (s === "started") return "Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©";
        if (s === "ended") return "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©";
        return s;
      }
      function translateStatusShort(s) {
        if (s === "waiting") return "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±";
        if (s === "started") return "Ø¬Ø§Ø±ÙŠØ©";
        if (s === "ended") return "Ø§Ù†ØªÙ‡Øª";
        return s;
      }

      /* ================ Visibility (basic anti-cheat) ================ */
      document.addEventListener("visibilitychange", () => {
        if (!playerKey) return;
        db.ref(`liveQuiz/players/${playerKey}`).update({
          lastSeen: Date.now(),
        });
      });

      /* ================ Init defaults ================ */
      (async function init() {
        const snap = await liveRef.once("value");
        if (!snap.exists()) {
          await liveRef.set({
            status: "waiting",
            settings: { totalSeconds: 300, maxParticipants: 5, topic: "Ø¹Ø§Ù…" },
          });
          totalTimeLabel.innerText = `5 Ø¯Ù‚Ø§Ø¦Ù‚`;
          requiredCountEl.innerText = 5;
          adminMax.value = 5;
          adminDuration.value = 5;
          adminTopic.value = "Ø¹Ø§Ù…";
        } else {
          const val = snap.val() || {};
          const settings = val.settings || {};
          totalSeconds = settings.totalSeconds || totalSeconds;
          maxParticipants = settings.maxParticipants || maxParticipants;
          topic = settings.topic || topic;
          totalTimeLabel.innerText = `${Math.round(totalSeconds / 60)} Ø¯Ù‚Ø§Ø¦Ù‚`;
          requiredCountEl.innerText = maxParticipants;
          adminMax.value = maxParticipants;
          adminDuration.value = Math.round(totalSeconds / 60);
          adminTopic.value = topic;
        }
        // update players count in UI
        playersRef.on("value", (snap) => {
          const d = snap.val() || {};
          const now = Date.now();
          const arr = Object.entries(d).map(([k, v]) => ({ key: k, ...v }));
          const active = arr.filter(
            (p) => p.lastSeen && now - p.lastSeen <= 45000
          );
          playersCountEl.innerText = active.length;
          waitingProgress.style.width = `${Math.min(
            100,
            Math.round((active.length / maxParticipants) * 100)
          )}%`;
          waitingText.innerText = `Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†: ${active.length} / ${maxParticipants}`;
        });
      })();
    </script>
  </body>
</html>
