<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ูุณุงุจูุฉ ุฃุนุถุงุก ุฌุฑูุจ ุงููุดุชุฑููู ููุชุฏุฑูุจ</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
      :root {
        --brand: #ff5722;
        --brand2: #ff8a50;
        --card: #fff;
        --muted: #67748e;
        --ok: #1faa59;
        --bad: #e53935;
        --bg1: #071426;
        --bg2: #0b2b46;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Cairo", sans-serif;
        color: #0d1b2a;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, var(--bg1), var(--bg2));
        padding: 18px;
      }
      .app {
        width: 100%;
        max-width: 1150px;
        overflow: hidden;
        border-radius: 16px;
        background: linear-gradient(180deg, #fff, #fafafa);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }
      header h1 {
        margin: 0;
        font-size: 18px;
      }
      header .sub {
        opacity: 0.95;
        font-size: 13px;
      }

      main {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 16px;
        padding: 18px;
      }
      @media (max-width: 980px) {
        main {
          grid-template-columns: 1fr;
        }
        .aside {
          order: 2;
        }
      }

      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      }
      .welcome {
        display: grid;
        gap: 12px;
        place-items: center;
        padding: 28px;
      }
      .input {
        width: 100%;
        max-width: 320px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #eee;
        outline: none;
        font-size: 16px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
        transition: 0.15s transform, 0.15s box-shadow;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.1);
      }
      .meta {
        color: var(--muted);
        font-size: 13px;
      }

      .question {
        font-size: 20px;
        margin: 10px 0 6px;
      }
      .options {
        display: grid;
        gap: 10px;
      }
      .option {
        background: #f6f8fa;
        padding: 12px;
        border-radius: 12px;
        text-align: center;
        font-weight: 800;
        border: 2px solid transparent;
        cursor: pointer;
        transition: 0.16s;
      }
      .option:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      }
      .option.correct {
        background: #e8f8ef;
        border-color: var(--ok);
      }
      .option.wrong {
        background: #ffecec;
        border-color: var(--bad);
      }

      .row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap; /* ูุฎูู ุงูุนูุงุตุฑ ุชูุฒู ุชุญุช ุจุนุถ ุนูุฏ ุถูู ุงูุดุงุดุฉ */
      }

      @media (max-width: 600px) {
        .row {
          flex-direction: column; /* ูุฎูููู ููู ูุชุญุช ุจุฏู ุฌูุจ ุจุนุถ */
        }
        .timerWrap {
          align-self: center; /* ูุฎูู ุงูุนุฏุงุฏ ูู ุงููุต */
          margin-top: 12px;
        }
        .question {
          font-size: 18px; /* ูุตุบุฑ ุงูุฎุท ุดููุฉ ุนุดุงู ุงูููุจุงูู */
          line-height: 1.6;
        }
      }

      .progress {
        height: 10px;
        background: #eee;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }

      .timerWrap {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .circle {
        width: 74px;
        height: 74px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-weight: 900;
        color: var(--brand);
        background: conic-gradient(var(--brand) 0deg, #eee 0deg);
      }

      .leaders {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .leader {
        background: linear-gradient(180deg, #fff, #fafafa);
        border-radius: 12px;
        padding: 10px;
        display: grid;
        grid-template-columns: 32px 1fr auto;
        gap: 10px;
        align-items: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        font-weight: 800;
      }
      .leader .bar {
        height: 8px;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 6px;
      }
      .leader .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }
      .crown {
        font-size: 18px;
      }
      .rank1 {
        background: linear-gradient(90deg, #ffd700, #ffcf5b);
      }
      .rank2 {
        background: linear-gradient(90deg, #c0c0c0, #e6e6e6);
      }
      .rank3 {
        background: linear-gradient(90deg, #cd7f32, #e0a67a);
      }

      .center {
        text-align: center;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app" role="application">
      <header>
        <div>
          <h1>ูุณุงุจูุฉ ุฃุนุถุงุก ุฌุฑูุจ ุงููุดุชุฑููู ููุชุฏุฑูุจ</h1>
          <div class="sub" id="topicLabel">ุงููุญูุฑ: ุนุงู</div>
        </div>
        <div class="sub">ุงูุญุงูุฉ: <span id="statusShort">ูู ุงูุชุธุงุฑ</span></div>
      </header>

      <main>
        <section>
          <!-- ุจุทุงูุฉ ุงูุชุฑุญูุจ -->
          <!-- ุฏุงุฎู ุจุทุงูุฉ ุงููุณุงุจูุฉ -->
          <div id="quizCard" class="card hidden">
            <div class="row">
              <div style="flex: 1">
                <div class="meta" id="progressText">ุณุคุงู 0 / 0</div>
                <div id="questionText" class="question">ุงูุณุคุงู ุณูุธูุฑ ููุง</div>
                <div class="progress" style="margin-top: 8px">
                  <i id="qProgress"></i>
                </div>
              </div>
              <div class="timerWrap">
                <div class="circle" id="circleTimer">--</div>
                <div style="text-align: right">
                  <div class="meta">ุงูููุช ุงููุชุจูู ููุณุคุงู</div>
                  <div
                    id="timeText"
                    style="font-weight: 900; color: var(--brand)"
                  >
                    --
                  </div>
                </div>
              </div>
            </div>

            <div id="options" class="options" style="margin-top: 12px"></div>
            <div
              id="feedback"
              class="meta"
              style="margin-top: 8px; min-height: 20px"
            ></div>

            <div id="doneBox" class="card hidden" style="margin-top: 12px">
              <div class="center">
                <strong>โ ุงูุชููุช ูู ุฅุฌุงุจุงุชู.</strong>
                <div class="meta" style="margin-top: 6px">
                  ุงูุชุธุฑ ุฒููุงุฆู ูุนุฑุถ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ.
                </div>
              </div>
            </div>

            <!-- ุฒุฑุงุฑ ุงูุงูุณุญุงุจ -->
            <div style="margin-top: 16px; text-align: center">
              <button id="leaveBtn" class="btn" style="background: #e53935">
                ๐ช ุงูุณุญุงุจ ูู ุงููุณุงุจูุฉ
              </button>
            </div>
          </div>
        </section>

        <!-- ุฌุงูุจ: ุชุฑุชูุจ ูุจุงุดุฑ -->
        <aside class="aside">
          <div class="card">
            <h3>ุงูุชุฑุชูุจ ุงููุจุงุดุฑ</h3>
            <ol id="leaderList" class="leaders" style="margin-top: 10px"></ol>
            <div class="meta" style="margin-top: 8px">
              ูุดูู ุงูููุงุท ูุจุงุดุฑุฉู ูุชุญููุฒ ุงูููุงูุณุฉ
            </div>
          </div>

          <div class="card" style="margin-top: 12px">
            <h3>ุญุงูุฉ ุงููุณุงุจูุฉ</h3>
            <div class="meta">ุงูุญุงูุฉ: <b id="statusLabel">ูู ุงูุชุธุงุฑ</b></div>
            <div style="margin-top: 6px" class="meta">
              ุงููุชุตุฏุฑ: <b id="topBadge">โ</b>
            </div>
          </div>
        </aside>
      </main>

      <footer>ยฉ ูุณุงุจูุฉ ุฃุนุถุงุก ุฌุฑูุจ ุงููุดุชุฑููู ููุชุฏุฑูุจ</footer>
    </div>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      /* ========== Firebase ========== */
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.appspot.com",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const liveRef = db.ref("liveQuiz");
      const playersRef = db.ref("liveQuiz/players");

      /* ========== ุฃุณุฆูุฉ (ูุซุงู) ========== */
      const QUESTIONS = [
        {
          q: "ุฃููู ููุง ููู ููุณ ุฃุฏุงุฉ ููู:",
          opts: ["ูู", "ูู", "ูุง", "ูู"],
          a: 3,
        },
        {
          q: "ุฃููู ููุง ููู ุฃุฏุงุฉ ููู:",
          opts: ["ูู", "ูู", "ุนูู"],
          a: 1,
        },
        {
          q: "ุงุฎุชุฑ ุงูุฌููุฉ ุงูุตุญูุญุฉ:",
          opts: ["ุฃูุณ ุจู ูุงูู", "ุฃูุณ ุงุจู ูุงูู", "ุฃูุณ ุฅุจู ูุงูู", "ุงูุณ ุจู ูุงูู"],
          a: 0,
        },
        {
          q: "ุงุฎุชุฑ ุงููููุฉ ุงูุตุญูุญุฉ:",
          opts: ["ุฃุฏุนู", "ุฃุฏุนู"],
          a: 0,
        },
        {
          q: "ุญุฑู ุงููุฏ ูู ูููุฉ (ุนูุฏ):",
          opts: ["ุงูุนูู", "ุงููุงู", "ุฏุงู"],
          a: 1,
        },
        {
          q: "ุงูุญุฑู ุงูููุฏูุฏ ูู ูููุฉ (ุนูุฏ):",
          opts: ["ุงูุนูู", "ุงููุงู", "ุฏุงู"],
          a: 0,
        },
        {
          q: "ูู ุงูุญุฑูู ุงูุชู ุชูุตุจ ุงููุจุชุฏุฃ ููุณูู ุงุณููุง ูุชุฑูุน ุงูุฎุจุฑ ููุณูู ุฎุจุฑูุง:",
          opts: ["ูุงู", "ุฃุตุจุญ", "ุฅู"],
          a: 2,
        },
        {
          q: "ูุฑููุน ุฏุงุฆููุง:",
          opts: ["ุงููุจุชุฏุฃ", "ุงูุญุงู", "ุงููุถุงู ุฅููู"],
          a: 0,
        },
        {
          q: "ุฌููุน ุงููููุงุช ุงูุขุชูุฉ ุจูุง ูุฏ ูุงุนุฏุง:",
          opts: ["ุนูุฏ", "ุตูุช", "ุจููุช", "ุชูุช"],
          a: 1,
        },
        {
          q: "ุฅุญุฏู ุงููููุงุช ุงูุขุชูุฉ ุจูุง ูุฏ:",
          opts: ["ุจูุช", "ุตูุช", "ุจูุช", "ุนูุฏ"],
          a: 3,
        },
        {
          q: "ุงุฎุชุฑ ุงูุฌููุฉ ุงูุตุญูุญุฉ:",
          opts: ["ููุฏ ุชูููุฐู ูุฌูุจูุง", "ููุฏู ุชูููุฐู ูุฌูุจู"],
          a: 1,
        },
        {
          q: "ุงุฎุชุฑ ุงูุฌููุฉ ุงูุตุญูุญุฉ:",
          opts: [
            "ุงูุทุงูุจุงู ูุฑูุฏุงู ุฃู ููุฌุญุงู",
            "ุงูุทุงูุจุงู ูุฑูุฏุงู ุฃู ููุฌุญุง",
            "ุงูุทุงูุจุงู ูุฑูุฏุง ุฃู ููุฌุญุง",
          ],
          a: 1,
        },
        {
          q: "ููู ุงูุชูููุฏ ุชุชุตู ุจุงููุนู ..............",
          opts: ["ููุท ุงููุงุถู", "ุงูุฃูุฑ ููุท", "ุงููุถุงุฑุน ููุท", "ุงููุถุงุฑุน ูุงูุฃูุฑ"],
          a: 3,
        },
        {
          q: "ุงุฎุชุฑ ุงููููุฉ ุงูุตุญูุญุฉ:",
          opts: ["ุถุบุงุคู", "ุถุบุงุฆู", "ุถุบุงุกู"],
          a: 1,
        },
        {
          q: "ุงุฎุชุฑ ุงูุฌููุฉ ุงูุตุญูุญุฉ:",
          opts: ["ุฌุงุก ุงูุฃููุฑ ุฃุญูุฏ", "ุฌุงุก ุฃูุงููุฑ ุฃุญูุฏ", "ุฌุงุก ุงูุงููุฑ ุงุญูุฏ"],
          a: 0,
        },
        {
          q: "ุชูููุฒ ุงููุงุฆุฉ ุฏุงุฆููุง .............",
          opts: ["ุฌูุน ูุฌุฑูุฑ", "ููุฑุฏ ููุตูุจ", "ููุฑุฏ ูุฌุฑูุฑ"],
          a: 2,
        },
        {
          q: "ุชุงูููุ ูุฃุนุตูู ุงูุดูุทุงู ( )",
          opts: [".", "ุ", "!"],
          a: 0,
        },
        {
          q: "ุงูุฑูุน ูู ุงูุฃูุนุงู ูููุฑุฏ ุนู ุงูุฃุณูุงุก ุจู .............",
          opts: ["ุงููุงู", "ุงูุฃูู", "ุซุจูุช ุงูููู"],
          a: 2,
        },
        {
          q: "ุฑุฃูุชู ................. ุงูุฃุทูุงู",
          opts: ["ูุคูุงุกู", "ูุคูุงุกู", "ูุคูุงุกู"],
          a: 1,
        },
        {
          q: "ุตุฏููู ูุชุญุฏุซ ุจู ...........",
          opts: ["ุฃูุงุดุงุฑุฉ", "ุงูุฅุดุงุฑุฉ", "ุฅูุฅุดุงุฑุฉ"],
          a: 1,
        },
      ];

      const REQUIRED_PLAYERS = 2; // ุงูุชุฌุฑุจุฉ ุชุจุฏุฃ ุนูุฏ 2
      const PER_QUESTION_SECONDS = 15; // 15 ุซุงููุฉ ููู ุณุคุงู

      /* ========== ุนูุงุตุฑ ูุงุฌูุฉ ========== */
      const $ = (s) => document.querySelector(s);
      const welcomeCard = $("#welcomeCard"),
        joinBtn = $("#joinBtn"),
        nameInput = $("#nameInput"),
        playersCount = $("#playersCount");
      const waitingBox = $("#waitingBox"),
        waitingText = $("#waitingText"),
        waitingProgress = $("#waitingProgress");
      const quizCard = $("#quizCard"),
        questionText = $("#questionText"),
        optionsWrap = $("#options"),
        feedback = $("#feedback");
      const progressText = $("#progressText"),
        qProgress = $("#qProgress"),
        statusShort = $("#statusShort"),
        statusLabel = $("#statusLabel");
      const circleTimer = $("#circleTimer"),
        timeText = $("#timeText"),
        doneBox = $("#doneBox");
      const leaderList = $("#leaderList"),
        topBadge = $("#topBadge");

      /* ========== ุญุงูุฉ ูุญููุฉ ========== */
      let playerId = null,
        playerName = "",
        localScore = 0,
        localIndex = 0,
        questionTimer = null,
        questionDeadline = null,
        started = false;

      /* ========== ุฃุตูุงุช WebAudio (ุจุฏูู ุฑูุงุจุท ุฎุงุฑุฌูุฉ) ========== */
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      let audioUnlocked = false;
      function unlockAudio() {
        if (audioUnlocked) return;
        ctx
          .resume()
          .then(() => (audioUnlocked = true))
          .catch(() => {});
      }
      document.addEventListener("click", unlockAudio, { once: true });

      function beep({ freq = 600, type = "sine", ms = 200, gain = 0.06 } = {}) {
        try {
          const osc = ctx.createOscillator();
          const g = ctx.createGain();
          osc.type = type;
          osc.frequency.value = freq;
          g.gain.value = gain;
          osc.connect(g);
          g.connect(ctx.destination);
          osc.start();
          setTimeout(() => {
            osc.stop();
          }, ms);
        } catch (e) {}
      }
      const sfx = {
        start: () => beep({ freq: 900, type: "triangle", ms: 200 }),
        correct: () => {
          beep({ freq: 880, type: "sine", ms: 140 });
          setTimeout(() => beep({ freq: 1200, type: "sine", ms: 180 }), 120);
        },
        wrong: () => beep({ freq: 220, type: "sawtooth", ms: 260 }),
        tick: () => beep({ freq: 520, type: "square", ms: 60, gain: 0.03 }),
        win: () => {
          [880, 990, 1180, 1320].forEach((f, i) =>
            setTimeout(() => beep({ freq: f, type: "sine", ms: 160 }), i * 140)
          );
        },
      };

      /* ========== ุงูุถูุงู ========== */
      joinBtn.addEventListener("click", async () => {
        unlockAudio();
        const name =
          (nameInput.value || "").trim() ||
          "ูุงุนุจ_" + Math.floor(Math.random() * 900 + 100);
        playerName = name;
        const key = playersRef.push().key;
        playerId = key;
        await db.ref(`liveQuiz/players/${playerId}`).set({
          name: playerName,
          score: 0,
          currentQuestion: 0,
          finished: false,
          joinedAt: Date.now(),
        });
        db.ref(`liveQuiz/players/${playerId}`).onDisconnect().remove();
        welcomeCard.classList.add("hidden");
      });

      /* ========== ุงูุชุฑุชูุจ ุงููุจุงุดุฑ + ุจุฏุก ุชููุงุฆู ุนูุฏ 2 ========== */
      playersRef.on("value", async (snap) => {
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([id, v]) => ({ id, ...v }));
        playersCount.innerText = arr.length;

        // ุดุฑูุท ุงูุงูุชุธุงุฑ
        const pct = Math.min(
          100,
          Math.round((arr.length / REQUIRED_PLAYERS) * 100)
        );
        waitingProgress.style.width = pct + "%";
        waitingText.innerText = `ูู ุงูุชุธุงุฑ ุงูุชูุงู ุงูุนุฏุฏ โ ุงูุขู ${arr.length} / ${REQUIRED_PLAYERS}`;

        // ุชุฑุชูุจ ูุจุงุดุฑ
        renderLeaders(arr);

        // ุงุจุฏุฃ ุฃูู ูุฑุฉ ููุท ููุง ููุตู 2 ููุง ููููุด ุจุฏุฃ
        if (arr.length >= REQUIRED_PLAYERS) {
          const live = (await liveRef.once("value")).val() || {};
          if (live.status !== "started") {
            await liveRef.update({ status: "started", startedAt: Date.now() });
          }
        }
      });

      /* ========== ูุชุงุจุนุฉ ุญุงูุฉ ุงูู Live ========== */
      liveRef.on("value", (snap) => {
        const val = snap.val() || {};
        const st = val.status || "waiting";
        statusShort.innerText =
          st === "started" ? "ุจุฏุฃุช" : st === "ended" ? "ุงูุชูุช" : "ูู ุงูุชุธุงุฑ";
        statusLabel.innerText = statusShort.innerText;

        if (st === "started" && !started) {
          started = true;
          startGame();
        }
        if (st === "ended") {
          // ุชุธูุฑ ุงููุชูุฌุฉ/ุงูุงุญุชูุงู ูุชู ูู finalize()
        }
      });

      /* ========== ุจุฏุก ุงูุฌููุฉ (ููู ุนููู) ========== */
      function startGame() {
        // ุฅุนุงุฏุฉ ุชููุฆุฉ ูุญููุฉ
        localScore = 0;
        localIndex = 0;
        quizCard.classList.remove("hidden");
        welcomeCard.classList.add("hidden");
        sfx.start();
        renderQuestion();
      }

      /* ========== ุงููุคูุช ููู ุณุคุงู ========== */
      function startQuestionTimer(totalSec = PER_QUESTION_SECONDS) {
        stopQuestionTimer();
        const endAt = Date.now() + totalSec * 1000;
        questionDeadline = endAt;

        questionTimer = setInterval(() => {
          const remain = Math.max(
            0,
            Math.ceil((questionDeadline - Date.now()) / 1000)
          );
          timeText.innerText = remain + " ุซ";
          // ุฏุงุฆุฑุฉ
          const elapsed =
            PER_QUESTION_SECONDS * 1000 -
            Math.max(0, questionDeadline - Date.now());
          const pct = Math.min(
            100,
            Math.round((elapsed / (PER_QUESTION_SECONDS * 1000)) * 100)
          );
          circleTimer.style.background = `conic-gradient(var(--brand) ${
            pct * 3.6
          }deg, #eee ${pct * 3.6}deg)`;
          circleTimer.innerText = remain;

          if (remain <= 5 && remain > 0) sfx.tick();

          if (remain <= 0) {
            stopQuestionTimer();
            // ุจุฏูู ุฅุฌุงุจุฉ โ ููุชูู ุชููุงุฆููุง ููุณุคุงู ุงูุชุงูู
            nextQuestion();
          }
        }, 200);
      }
      function stopQuestionTimer() {
        if (questionTimer) {
          clearInterval(questionTimer);
          questionTimer = null;
        }
      }

      /* ========== ุนุฑุถ ุณุคุงู/ุฅุฌุงุจุงุช ========== */
      let optionLock = false;
      function renderQuestion() {
        feedback.innerText = "";
        doneBox.classList.add("hidden");

        if (localIndex >= QUESTIONS.length) {
          // ุฎููุตูุง
          finishLocal();
          return;
        }

        const q = QUESTIONS[localIndex];
        questionText.innerText = q.q;
        optionsWrap.innerHTML = "";
        optionLock = false;

        // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
        progressText.innerText = `ุณุคุงู ${localIndex + 1} / ${QUESTIONS.length}`;
        qProgress.style.width =
          Math.round((localIndex / QUESTIONS.length) * 100) + "%";

        // ุฎูุงุฑุงุช (shuffle ุจุณูุท)
        const opts = q.opts
          .map((o, i) => ({ o, i }))
          .sort(() => Math.random() - 0.5);
        opts.forEach(({ o, i }) => {
          const div = document.createElement("div");
          div.className = "option";
          div.innerText = o;
          div.onclick = async () => {
            if (optionLock) return;
            optionLock = true;

            if (i === q.a) {
              div.classList.add("correct");
              feedback.innerText = "ุฅุฌุงุจุฉ ุตุญูุญุฉ โ";
              sfx.correct();
              await db
                .ref(`liveQuiz/players/${playerId}/score`)
                .transaction((s) => (s || 0) + 1);
            } else {
              div.classList.add("wrong");
              feedback.innerText = `ุฎุทุฃ โ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ${q.opts[q.a]}`;
              sfx.wrong();
              // ุฅุจุฑุงุฒ ุงูุตุญ
              Array.from(optionsWrap.children).forEach((c) => {
                if (c.innerText === q.opts[q.a]) c.classList.add("correct");
              });
            }

            // ุญุฏูุซ ููุถุน ุงูุณุคุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงุฎุชูุงุฑู ููุนุฑุถ)
            await db
              .ref(`liveQuiz/players/${playerId}`)
              .update({ currentQuestion: localIndex + 1 });

            setTimeout(() => nextQuestion(), 900);
          };
          optionsWrap.appendChild(div);
        });

        // ุดุบูู ูุคูุช ุงูุณุคุงู
        startQuestionTimer(PER_QUESTION_SECONDS);
      }

      function nextQuestion() {
        stopQuestionTimer();
        localIndex++;
        renderQuestion();
      }

      async function finishLocal() {
        stopQuestionTimer();
        optionsWrap.innerHTML = "";
        feedback.innerText = "ุงูุชููุช โ ุงูุชุธุฑ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ";
        doneBox.classList.remove("hidden");

        // ุนููู ููุณู ููุชูู
        if (playerId)
          await db
            .ref(`liveQuiz/players/${playerId}`)
            .update({ finished: true });

        // ุชุญูู ุฅู ูุงู ุงูุฌููุน ุงูุชูู โ ุงููู ุงูุฌููุฉ
        const snap = await playersRef.once("value");
        const data = snap.val() || {};
        const arr = Object.values(data);
        const allFinished = arr.length > 0 && arr.every((p) => p.finished);
        if (allFinished) {
          await liveRef.update({ status: "ended", endedAt: Date.now() });
          finalize();
        }
      }

      /* ========== ุงูุชุฑุชูุจ ุงููุจุงุดุฑ ========== */
      function renderLeaders(list) {
        const arr = list
          .slice()
          .sort((a, b) => (b.score || 0) - (a.score || 0));
        leaderList.innerHTML = "";
        arr.forEach((p, i) => {
          const li = document.createElement("li");
          li.className = "leader";
          if (i === 0) li.classList.add("rank1");
          if (i === 1) li.classList.add("rank2");
          if (i === 2) li.classList.add("rank3");

          const crown = i === 0 ? "๐" : i + 1;
          const name = (p.name || "ูุงุนุจ").toString();
          const score = p.score || 0;
          const pct = Math.min(
            100,
            Math.round((score / Math.max(1, QUESTIONS.length)) * 100)
          );

          li.innerHTML = `
          <div class="crown">${crown}</div>
          <div>
            <div>${escapeHtml(name)}</div>
            <div class="bar"><i style="width:${pct}%"></i></div>
          </div>
          <div>${score} ููุทุฉ</div>
        `;
          leaderList.appendChild(li);
        });
        topBadge.innerText = arr.length
          ? `${arr[0].name} (${arr[0].score || 0})`
          : "โ";
      }

      function escapeHtml(s) {
        return (s || "").toString().replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      /* ========== ุฅููุงุก ุงูุฌููุฉ + ุงุญุชูุงู ========== */
      async function finalize() {
        // ุงุญุณุจ ุงููุงุฆุฒ
        const snap = await playersRef.once("value");
        const data = snap.val() || {};
        const arr = Object.values(data).map((v) => ({
          name: v.name,
          score: v.score || 0,
        }));
        arr.sort((a, b) => b.score - a.score);

        if (arr.length) {
          // confetti + ูุบูุฉ ููุฒ
          confetti({ particleCount: 250, spread: 80, origin: { y: 0.2 } });
          sfx.win();
          alert(`๐ ูุจุฑูู! ุงููุงุฆุฒ: ${arr[0].name} โ ${arr[0].score} ููุทุฉ`);
        }

        // ูุธูู ูุงุนุจู ุงูุฌููุฉ ุนุดุงู ุงูุฌููุฉ ุงูุฌุงูุฉ ุชุจุฏุฃ ูู ุงูุตูุฑ (ุญู ูุดููุฉ ุจูุงูุง ุงูุฃุณูุงุก)
        setTimeout(async () => {
          await playersRef.remove();
          await liveRef.update({ status: "waiting" });
          // ุงุฑุฌูุน ูุดุงุดุฉ ุงูุชุฑุญูุจ
          welcomeCard.classList.remove("hidden");
          quizCard.classList.add("hidden");
          started = false;
          statusShort.innerText = "ูู ุงูุชุธุงุฑ";
          statusLabel.innerText = "ูู ุงูุชุธุงุฑ";
        }, 500);
      }
    </script>
  </body>
</html>
