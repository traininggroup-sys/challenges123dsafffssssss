<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>جروب أسئلة الجهاز المركزي</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <meta name="google-adsense-account" content="ca-pub-3194084220429968" />
    <style>
      :root {
        --brand: #ff5722;
        --brand2: #ff8a50;
        --card: #fff;
        --muted: #67748e;
        --ok: #1faa59;
        --bad: #e53935;
        --bg1: #071426;
        --bg2: #0b2b46;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Cairo", sans-serif;
        color: #0d1b2a;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, var(--bg1), var(--bg2));
        padding: 18px;
      }
      .app {
        width: 100%;
        max-width: 1150px;
        overflow: hidden;
        border-radius: 16px;
        background: linear-gradient(180deg, #fff, #fafafa);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }
      header h1 {
        margin: 0;
        font-size: 18px;
      }
      header .sub {
        opacity: 0.95;
        font-size: 13px;
      }

      main {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 16px;
        padding: 18px;
      }
      @media (max-width: 980px) {
        main {
          grid-template-columns: 1fr;
        }
        .aside {
          order: 2;
        }
      }

      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      }
      .welcome {
        display: grid;
        gap: 12px;
        place-items: center;
        padding: 28px;
      }
      .input {
        width: 100%;
        max-width: 320px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #eee;
        outline: none;
        font-size: 16px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
        transition: 0.15s transform, 0.15s box-shadow;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.1);
      }
      .meta {
        color: var(--muted);
        font-size: 13px;
      }

      .question {
        font-size: 20px;
        margin: 10px 0 6px;
      }
      .options {
        display: grid;
        gap: 10px;
      }
      .option {
        background: #f6f8fa;
        padding: 12px;
        border-radius: 12px;
        text-align: center;
        font-weight: 800;
        border: 2px solid transparent;
        cursor: pointer;
        transition: 0.16s;
      }
      .option:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      }
      .option.correct {
        background: #e8f8ef;
        border-color: var(--ok);
      }
      .option.wrong {
        background: #ffecec;
        border-color: var(--bad);
      }

      /* الأساس */
      #question {
        font-size: 1.5rem;
        margin-bottom: 15px;
        text-align: center;
        line-height: 1.6;
      }

      .option-btn {
        display: block;
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        font-size: 1rem;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s;
      }

      /* للموبايل */
      @media (max-width: 600px) {
        #question {
          font-size: 1.2rem; /* خط أصغر شوية علشان يدخل */
          padding: 0 10px;
        }

        .option-btn {
          font-size: 0.95rem;
          padding: 10px;
        }
      }

      .progress {
        height: 10px;
        background: #eee;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }

      .timerWrap {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .circle {
        width: 74px;
        height: 74px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-weight: 900;
        color: var(--brand);
        background: conic-gradient(var(--brand) 0deg, #eee 0deg);
      }
      @media (max-width: 600px) {
        .circle {
          width: 60px;
          height: 60px;
          font-size: 14px;
        }
        .options {
          gap: 6px;
        }
      }

      .leaders {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .leader {
        background: linear-gradient(180deg, #fff, #fafafa);
        border-radius: 12px;
        padding: 10px;
        display: grid;
        grid-template-columns: 32px 1fr auto;
        gap: 10px;
        align-items: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        font-weight: 800;
      }
      .leader .bar {
        height: 8px;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 6px;
      }
      .leader .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }
      .crown {
        font-size: 18px;
      }
      .rank1 {
        background: linear-gradient(90deg, #ffd700, #ffcf5b);
      }
      .rank2 {
        background: linear-gradient(90deg, #c0c0c0, #e6e6e6);
      }
      .rank3 {
        background: linear-gradient(90deg, #cd7f32, #e0a67a);
      }

      .center {
        text-align: center;
      }
      .hidden {
        display: none;
      }
      footer {
        text-align: center;
        padding: 14px;
        font-size: 13px;
        color: #fff;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      #winnerPopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: #fff;
        padding: 28px 36px;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 9999;
        transition: transform 0.3s ease;
      }
      #winnerPopup.show {
        transform: translate(-50%, -50%) scale(1);
      }
      #winnerPopup h2 {
        font-size: 24px;
        margin: 0 0 12px;
        color: var(--brand);
      }
      #winnerPopup p {
        font-size: 18px;
        margin: 0;
        font-weight: 700;
      }
      #winnerOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 9998;
      }
      #winnerOverlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      #winnerPopup button {
        margin-top: 18px;
        padding: 10px 20px;
        border: none;
        background: var(--brand);
        color: #fff;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
      }
      #winnerPopup button:hover {
        transform: translateY(-2px);
      }
      #finalPage {
        background: linear-gradient(180deg, var(--bg1), var(--bg2));
        color: #fff;
        text-align: center;
        padding: 40px;
        width: 100%;
        height: 100vh;
        display: none; /* hidden افتراضي */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10000;
      }
      #finalPage.show {
        display: flex; /* تظهر لما نضيف class show */
      }

      #finalPage a {
        color: #ff8a50; /* لون واضح للرابط */
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .popup {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="app" role="application">
      <header>
        <div>
          <h1>جروب أسئلة الجهاز المركزي</h1>
          <div class="sub" id="topicLabel">المحور: عام</div>
        </div>
        <div class="sub">الحالة: <span id="statusShort">في انتظار</span></div>
      </header>

      <main>
        <section>
          <!-- بطاقة الترحيب -->
          <div id="welcomeCard" class="card welcome">
            <h2>أهلاً بكم في المسابقة!</h2>
            <p class="meta">
              اكتب اسمك واضغط مشاركة. تبدأ المسابقة تلقائيًا عند اكتمال عدد 2
              متسابق للتجربة.
            </p>
            <input
              id="nameInput"
              class="input"
              placeholder="اكتب اسمك (مثال: رانيا)"
            />
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 8px;
              "
            >
              <button id="joinBtn" class="btn">المشاركة</button>
            </div>
            <div class="meta" style="margin-top: 8px">
              متصلين الآن: <b id="playersCount">0</b>
            </div>

            <div id="waitingBox" class="card" style="margin-top: 10px">
              <div class="meta" id="waitingText">
                في انتظار اكتمال العدد — الآن 0 / 2
              </div>
              <div class="progress" style="margin-top: 8px">
                <i id="waitingProgress"></i>
              </div>
            </div>
          </div>

          <!-- بطاقة المسابقة -->
          <div id="quizCard" class="card hidden">
            <div class="row">
              <div style="flex: 1">
                <div class="meta" id="progressText">سؤال 0 / 0</div>
                <div id="questionText" class="question">السؤال سيظهر هنا</div>
                <div class="progress" style="margin-top: 8px">
                  <i id="qProgress"></i>
                </div>
              </div>
              <div class="timerWrap">
                <div class="circle" id="circleTimer">--</div>
                <div style="text-align: right">
                  <div class="meta">الوقت المتبقي للسؤال</div>
                  <div
                    id="timeText"
                    style="font-weight: 900; color: var(--brand)"
                  >
                    --
                  </div>
                </div>
              </div>
            </div>

            <div id="options" class="options" style="margin-top: 12px"></div>
            <div
              id="feedback"
              class="meta"
              style="margin-top: 8px; min-height: 20px"
            ></div>

            <div id="doneBox" class="card hidden" style="margin-top: 12px">
              <div class="center">
                <strong>✅ انتهيت من إجاباتك.</strong>
                <div class="meta" style="margin-top: 6px">
                  انتظر زملائك لعرض النتائج النهائية.
                </div>
              </div>
            </div>

            <!-- زر الانسحاب -->
            <div style="margin-top: 12px; text-align: center">
              <button id="leaveBtn" class="btn" style="background: crimson">
                انسحاب
              </button>
            </div>
          </div>
        </section>

        <!-- جانب: ترتيب مباشر -->
        <aside class="aside">
          <div class="card">
            <h3>الترتيب المباشر</h3>
            <ol id="leaderList" class="leaders" style="margin-top: 10px"></ol>
            <div class="meta" style="margin-top: 8px">
              يشمل النقاط مباشرةً لتحفيز المنافسة
            </div>
          </div>

          <div class="card" style="margin-top: 12px">
            <h3>حالة المسابقة</h3>
            <div class="meta">الحالة: <b id="statusLabel">في انتظار</b></div>
            <div style="margin-top: 6px" class="meta">
              المتصدر: <b id="topBadge">—</b>
            </div>
          </div>
        </aside>
      </main>
      <div id="winnerOverlay"></div>
      <div id="finalPage" class="hidden">
        <h2>انتهت المسابقة</h2>
        <p style="margin: 20px 0; font-size: 16px">
          ولو عايز باقي أهم الأسئلة اضغط على هذا الموقع:
          <a href="https://final-site-seven.vercel.app/" target="_blank"
            >final-site-seven.vercel.app</a
          >
        </p>
        <button id="backToHomeBtn" class="btn" style="margin-top: 20px">
          الرجوع للشاشة الرئيسية
        </button>
        <button id="openBtn" style="display: none">فتح المسابقة</button>
      </div>

      <div id="winnerPopup">
        <h2>🎉 مبروك!</h2>
        <p id="winnerName">—</p>
        <p id="winnerScore">— نقاط</p>
        <button id="closeWinnerPopup">اغلاق</button>
      </div>
      <!-- ضع هذا في الـ body -->
      <div
        id="fullLobbyMsg"
        style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.85);
          color: #fff;
          padding: 25px 40px;
          border-radius: 12px;
          font-size: 22px;
          text-align: center;
          z-index: 9999;
          display: none;
          box-shadow: 0 0 15px #000;
        "
      >
        الجولة الحالية اكتملت! انتظر الجولة القادمة 🔒
        <br /><br />
        <button
          id="closeLobbyMsg"
          style="
            padding: 8px 20px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #ffd700;
            color: #000;
            font-weight: bold;
          "
        >
          حسناً
        </button>
      </div>
      <button id="stopBtn" style="display: none">إيقاف المسابقة</button>

      <footer>© جروب أسئلة الجهاز المركزي</footer>
    </div>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      /* ========== Firebase ========== */
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.appspot.com",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const liveRef = db.ref("liveQuiz");
      const playersRef = db.ref("liveQuiz/players");

      /* ========== أسئلة (مثال) ========== */
      const QUESTIONS = [
        {
          q: "What is the antonym of 'full'?",
          opts: ["Clean", "Empty", "Long", "Old"],
          a: 1,
        },
        {
          q: "What is the opposite of 'spend'?",
          opts: ["Buy", "Lose", "Save", "Waste"],
          a: 2,
        },
        {
          q: "What is the opposite of 'happy'?",
          opts: ["Sad", "Angry", "Crazy", "Tired"],
          a: 0,
        },
        {
          q: "The opposite of 'soft' is ____.",
          opts: ["Smooth", "Firm", "Rough", "Hard"],
          a: 3,
        },
        {
          q: "Which question word is used to ask about people?",
          opts: ["What", "Who", "Where", "Why"],
          a: 1,
        },
        {
          q: "عاصمة السياحة لعام 2010؟",
          opts: ["الدوحة", "الأقصر", "الإسكندرية", "الخارجة"],
          a: 2,
        },
        {
          q: "عاصمة السياحة لعام 2023؟",
          opts: ["الدوحة", "الأقصر", "الإسكندرية", "الخارجة"],
          a: 0,
        },
        {
          q: "المدينة الصناعية الغذائية سايلو فودز تقع بالسادات محافظة؟",
          opts: ["الغربية", "المنوفية", "الشرقية", "سوهاج"],
          a: 1,
        },
        {
          q: "الجهة المسؤولة عن اقتراح وتنفيذ القرار في الاتحاد الأوروبي؟",
          opts: [
            "مجلس الوزراء",
            "المجلس الأوروبي",
            "المفوضية الأوروبية",
            "لا شيء",
          ],
          a: 2,
        },
        {
          q: "أين تقع مدينة أهناسيا في محافظة؟",
          opts: ["بني سويف", "الأقصر", "الإسكندرية", "القاهرة"],
          a: 0,
        },
        {
          q: "منح جائزة نوبل للسلام للرئيس محمد أنور السادات عام؟",
          opts: ["1665", "1977", "1978", "1987"],
          a: 2,
        },
        {
          q: "افتتاح محطة تحيا مصر متعددة الأغراض بميناء؟",
          opts: ["بني سويف", "بورسعيد", "الإسكندرية", "القاهرة"],
          a: 2,
        },
        {
          q: "أين تقع محطة عدلي منصور في محافظة؟",
          opts: ["بني سويف", "بور سعيد", "الإسكندرية", "القاهرة"],
          a: 3,
        },
        {
          q: "عقل الكمبيوتر هو ____",
          opts: ["القرص الصلب", "الذاكرة", "الشاشة", "وحدة الحساب والمنطق"],
          a: 3,
        },
        {
          q: "أي من التالي لا يوجد في وحدة المعالجة المركزية (CPU)؟",
          opts: [
            "الشاشة",
            "وحدة الحساب والمنطق ALU",
            "المسجلات",
            "وحدة التحكم",
          ],
          a: 0,
        },
        {
          q: "أقصى عرض لعمود الاكسل هو؟",
          opts: ["3001", "200", "255", "100"],
          a: 2,
        },
        {
          q: "في عرض تقديمي باستخدام POWERPOINT، يمكن تكرار الرسوم المتحركة كم مرة؟",
          opts: ["2 : 5", "2 : 10", "1 : 5", "1 : 20"],
          a: 1,
        },
        {
          q: "لفتح برنامج WORD هتكتب ايه في الأوامر؟",
          opts: ["Word.exe", "Pinword.exe", "openword.exe", "Winword.exe"],
          a: 3,
        },
        {
          q: "ما هو اختصار البحث عن الأخطاء الإملائية في مستند؟",
          opts: [
            "Function Key 2",
            "Function Key 7",
            "Function Key 5",
            "Function Key 9",
          ],
          a: 1,
        },
        {
          q: 'لو الكمبيوتر توقف عن الاستجابة "هنج" ، يمكن الضغط على اختصار:',
          opts: ["Ctrl + Alt + Delete", "Ctrl + S", "Alt + F4", "Shift + Esc"],
          a: 0,
        },
        {
          q: "واحدة من الجمل التالية صحيحة من حيث العدد والمعدود:",
          opts: [
            "هؤلاء تسعةُ طالبات",
            "هؤلاء تسع طالبات",
            "هؤلاء تسع طلاب",
            "هؤلاء تسعْ طلاب",
          ],
          a: 1,
        },
        {
          q: "الكلمة الصحيحة إملائيًّا في الفراغ في قولنا: تنزهنا على ........ البحر:",
          opts: ["شواطئ", "شواطؤ", "شواطأ", "شواطِء"],
          a: 0,
        },
        {
          q: "إحدى الكلمات الآتية، همزتها همزة وصل:",
          opts: ["احترام", "اقبل", "اقران", "انصاف"],
          a: 0,
        },
        {
          q: "إحدى الكلمات الآتية، همزتها همزة قطع:",
          opts: ["استنتج", "انتصر", "اثنان", "اقدم"],
          a: 3,
        },
        {
          q: "إحدى الكلمات الآتية كُتبت همزتها صحيحة:",
          opts: ["مُأسف", "مُشمأز", "مضيئة", "مُآزرة"],
          a: 2,
        },
        {
          q: "إحدى الكلمات الآتية كُتبت همزتها خطأ:",
          opts: ["مؤنس", "طمأن", "خطيأة", "جريئة"],
          a: 2,
        },
        {
          q: "إحدى الكلمات الآتية كُتبت همزتها صحيحة:",
          opts: ["مُألم", "مُأسسة", "يُآخذ", "يؤسس"],
          a: 3,
        },
        {
          q: "اسم المفعول من الفعل (طُبخ):",
          opts: ["مطبوخ", "طباخ", "مطبخ", "طابخ"],
          a: 0,
        },
        {
          q: "همزة كلمة يجرُأ صح ام خطا :",
          opts: ["صح", "خطا"],
          a: 1,
        },
        {
          q: "إحدى الكلمات الآتية كُتبت ألفها المقصورة صحيحة:",
          opts: ["تصدا", "افتدى", "لولى", "خبايى"],
          a: 1,
        },
      ];

      const REQUIRED_PLAYERS = 2; // التجربة تبدأ عند 2
      const PER_QUESTION_SECONDS = 15; // 15 ثانية لكل سؤال

      /* ========== عناصر واجهة ========== */
      const $ = (s) => document.querySelector(s);
      const welcomeCard = $("#welcomeCard"),
        joinBtn = $("#joinBtn"),
        nameInput = $("#nameInput"),
        playersCount = $("#playersCount");
      const waitingBox = $("#waitingBox"),
        waitingText = $("#waitingText"),
        waitingProgress = $("#waitingProgress");
      const quizCard = $("#quizCard"),
        questionText = $("#questionText"),
        optionsWrap = $("#options"),
        feedback = $("#feedback");
      const progressText = $("#progressText"),
        qProgress = $("#qProgress"),
        statusShort = $("#statusShort"),
        statusLabel = $("#statusLabel");
      const circleTimer = $("#circleTimer"),
        timeText = $("#timeText"),
        doneBox = $("#doneBox");
      const leaderList = $("#leaderList"),
        topBadge = $("#topBadge");
      const finalPage = document.getElementById("finalPage");
      const backToHomeBtn = document.getElementById("backToHomeBtn");

      /* ========== حالة محلية ========== */
      let playerId = null,
        playerName = "",
        localScore = 0,
        localIndex = 0,
        questionTimer = null,
        questionDeadline = null,
        started = false;

      /* ========== أصوات WebAudio (بدون روابط خارجية) ========== */
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      let ctx = new AudioCtx();
      let audioUnlocked = false;
      function unlockAudio() {
        if (audioUnlocked) return;
        ctx
          .resume()
          .then(() => (audioUnlocked = true))
          .catch(() => {});
      }
      document.addEventListener("click", unlockAudio, { once: true });
      const leaveBtn = document.getElementById("leaveBtn");

      if (leaveBtn) {
        leaveBtn.addEventListener("click", async () => {
          if (playerId) {
            await db.ref(`liveQuiz/players/${playerId}`).remove();
            playerId = null;
            playerName = "";
            // إرجاع المستخدم لواجهة الترحيب
            quizCard.classList.add("hidden");
            welcomeCard.classList.remove("hidden");

            // إيقاف جميع الأصوات
            stopAllSounds();
          }
        });
      }

      window.addEventListener("beforeunload", () => {
        if (playerId) {
          db.ref(`liveQuiz/players/${playerId}`).remove();
        }
      });

      function beep({ freq = 600, type = "sine", ms = 200, gain = 0.06 } = {}) {
        try {
          const osc = ctx.createOscillator();
          const g = ctx.createGain();
          osc.type = type;
          osc.frequency.value = freq;
          g.gain.value = gain;
          osc.connect(g);
          g.connect(ctx.destination);
          osc.start();
          setTimeout(() => {
            osc.stop();
          }, ms);
        } catch (e) {}
      }
      const sfx = {
        start: () => beep({ freq: 900, type: "triangle", ms: 200 }),
        correct: () => {
          beep({ freq: 880, type: "sine", ms: 140 });
          setTimeout(() => beep({ freq: 1200, type: "sine", ms: 180 }), 120);
        },
        wrong: () => beep({ freq: 220, type: "sawtooth", ms: 260 }),
        tick: () => beep({ freq: 520, type: "square", ms: 60, gain: 0.03 }),
        win: () => {
          [880, 990, 1180, 1320].forEach((f, i) =>
            setTimeout(() => beep({ freq: f, type: "sine", ms: 160 }), i * 140)
          );
        },
      };
      function stopAllSounds() {
        try {
          // لو في أي Audio بيتشغل، وقفه
          if (ctx && ctx.state !== "closed") {
            ctx.suspend(); // يوقف كل الأصوات بدون ما يقفل الـ context
          }
        } catch (e) {
          console.error("Error stopping sounds:", e);
        }
      }

      /* ========== انضمام ========== */

      const MAX_PLAYERS = 5; // الحد الأقصى للمتسابقين

      function showFullLobbyMessage() {
        const msg = document.getElementById("fullLobbyMsg");
        msg.style.display = "block";

        // إخفاء الرسالة تلقائياً بعد 5 ثواني
        const timeoutId = setTimeout(() => {
          msg.style.display = "none";
        }, 5000);

        // السماح للمستخدم بإغلاق الرسالة يدوياً
        const closeBtn = document.getElementById("closeLobbyMsg");
        closeBtn.onclick = () => {
          clearTimeout(timeoutId);
          msg.style.display = "none";
        };
      }
      let QUIZ_OPEN = true; // لو true المسابقة مفتوحة، لو false مقفولة

      joinBtn.addEventListener("click", async () => {
        unlockAudio();

        // التحقق هل المسابقة مفتوحة ولا مقفولة
        if (!QUIZ_OPEN) {
          alert("❌ المسابقة مقفولة حاليًا");
          return;
        }

        // جلب عدد المتسابقين الحاليين
        const snap = await playersRef.once("value");
        const currentPlayers = snap.val() || {};
        const numPlayers = Object.keys(currentPlayers).length;

        if (numPlayers >= MAX_PLAYERS) {
          showFullLobbyMessage(); // عرض الرسالة بدل alert
          return;
        }

        // ✅ التحقق من الاسم إجباري
        const name = (nameInput.value || "").trim();
        if (!name) {
          alert("⚠️ من فضلك أدخل اسمك أولاً");
          return;
        }

        playerName = name;
        const key = playersRef.push().key;
        playerId = key;

        await db.ref(`liveQuiz/players/${playerId}`).set({
          name: playerName,
          score: 0,
          currentQuestion: 0,
          finished: false,
          joinedAt: Date.now(),
        });

        db.ref(`liveQuiz/players/${playerId}`).onDisconnect().remove();
        welcomeCard.classList.add("hidden");

        const live = (await liveRef.once("value")).val() || {};
        if (live.status === "started") {
          started = true;
          startGame();
        }
      });

      /* ========== الترتيب المباشر + بدء تلقائي عند 2 ========== */
      playersRef.on("value", async (snap) => {
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([id, v]) => ({ id, ...v }));
        playersCount.innerText = arr.length;

        // شريط الانتظار
        const pct = Math.min(
          100,
          Math.round((arr.length / REQUIRED_PLAYERS) * 100)
        );
        waitingProgress.style.width = pct + "%";
        waitingText.innerText = `في انتظار اكتمال العدد — الآن ${arr.length} / ${REQUIRED_PLAYERS}`;

        // ترتيب مباشر
        renderLeaders(arr);

        // لو مفيش لاعبين → reset للحالة
        if (arr.length === 0) {
          await liveRef.set({ status: "waiting" });
          return;
        }

        // ابدأ المسابقة لما نوصل العدد المطلوب (لو مش بدأت)
        const live = (await liveRef.once("value")).val() || {};
        if (arr.length >= REQUIRED_PLAYERS && live.status === "waiting") {
          await liveRef.update({ status: "started", startedAt: Date.now() });
        }
      });

      /* ========== متابعة حالة الـ Live ========== */
      // متابعة حالة المسابقة لكل لاعب
      liveRef.on("value", (snap) => {
        const val = snap.val() || {};
        const st = val.status || "waiting";

        statusShort.innerText =
          st === "started" ? "بدأت" : st === "ended" ? "انتهت" : "في انتظار";
        statusLabel.innerText = statusShort.innerText;

        // إذا المسابقة بدأت ولم يبدأ اللاعب المحلي بعد
        if (st === "started" && !started && playerId) {
          started = true;
          startGame();
        }

        // إعلان الفائز عند نهاية المسابقة لكل اللاعبين
        if (st === "ended" && val.winnerName) {
          showWinner(val.winnerName, val.winnerScore);

          // تشغيل confetti و نغمة فوز مرة واحدة لكل لاعب
          if (!val.celebrated) {
            confetti({ particleCount: 250, spread: 80, origin: { y: 0.2 } });
            sfx.win();

            // علم قاعدة البيانات إنه تم الاحتفال
            liveRef.update({ celebrated: true }).catch(() => {});
          }
        }
      });

      /* ========== بدء الجولة (لكل عميل) ========== */
      function startGame() {
        // إعادة تهيئة محلية
        localScore = 0;
        localIndex = 0;
        quizCard.classList.remove("hidden");
        welcomeCard.classList.add("hidden");
        sfx.start();
        renderQuestion();
      }

      /* ========== المؤقت لكل سؤال ========== */
      function startQuestionTimer(totalSec = PER_QUESTION_SECONDS) {
        stopQuestionTimer();
        const endAt = Date.now() + totalSec * 1000;
        questionDeadline = endAt;

        questionTimer = setInterval(() => {
          const remain = Math.max(
            0,
            Math.ceil((questionDeadline - Date.now()) / 1000)
          );
          timeText.innerText = remain + " ث";
          // دائرة
          const elapsed =
            PER_QUESTION_SECONDS * 1000 -
            Math.max(0, questionDeadline - Date.now());
          const pct = Math.min(
            100,
            Math.round((elapsed / (PER_QUESTION_SECONDS * 1000)) * 100)
          );
          circleTimer.style.background = `conic-gradient(var(--brand) ${
            pct * 3.6
          }deg, #eee ${pct * 3.6}deg)`;
          circleTimer.innerText = remain;

          if (remain <= 5 && remain > 0) sfx.tick();

          if (remain <= 0) {
            stopQuestionTimer();
            // بدون إجابة → ينتقل تلقائيًا للسؤال التالي
            nextQuestion();
          }
        }, 200);
      }
      function stopQuestionTimer() {
        if (questionTimer) {
          clearInterval(questionTimer);
          questionTimer = null;
        }
      }

      /* ========== عرض سؤال/إجابات ========== */
      let optionLock = false;
      function renderQuestion() {
        feedback.innerText = "";
        doneBox.classList.add("hidden");

        if (localIndex >= QUESTIONS.length) {
          // خلّصنا
          finishLocal();
          return;
        }

        const q = QUESTIONS[localIndex];
        questionText.innerText = q.q;
        optionsWrap.innerHTML = "";
        optionLock = false;

        // تحديث شريط التقدم
        progressText.innerText = `سؤال ${localIndex + 1} / ${QUESTIONS.length}`;
        qProgress.style.width =
          Math.round((localIndex / QUESTIONS.length) * 100) + "%";

        // خيارات (shuffle بسيط)
        const opts = q.opts
          .map((o, i) => ({ o, i }))
          .sort(() => Math.random() - 0.5);
        opts.forEach(({ o, i }) => {
          const div = document.createElement("div");
          div.className = "option";
          div.innerText = o;
          div.onclick = async () => {
            if (optionLock) return;
            optionLock = true;

            if (i === q.a) {
              div.classList.add("correct");
              feedback.innerText = "إجابة صحيحة ✅";
              sfx.correct();
              await db
                .ref(`liveQuiz/players/${playerId}/score`)
                .transaction((s) => (s || 0) + 1);
            } else {
              div.classList.add("wrong");
              feedback.innerText = `خطأ ❌ الإجابة الصحيحة: ${q.opts[q.a]}`;
              sfx.wrong();
              // إبراز الصح
              Array.from(optionsWrap.children).forEach((c) => {
                if (c.innerText === q.opts[q.a]) c.classList.add("correct");
              });
            }

            // حدّث موضع السؤال في قاعدة البيانات (اختياري للعرض)
            await db
              .ref(`liveQuiz/players/${playerId}`)
              .update({ currentQuestion: localIndex + 1 });

            setTimeout(() => nextQuestion(), 900);
          };
          optionsWrap.appendChild(div);
        });

        // شغّل مؤقت السؤال
        startQuestionTimer(PER_QUESTION_SECONDS);
      }

      function nextQuestion() {
        stopQuestionTimer();
        localIndex++;
        renderQuestion();
      }

      async function finishLocal() {
        stopQuestionTimer();
        optionsWrap.innerHTML = "";
        feedback.innerText = "انتهيت — انتظر النتيجة النهائية";
        doneBox.classList.remove("hidden");

        // علّم نفسك منتهي
        if (playerId)
          await db
            .ref(`liveQuiz/players/${playerId}`)
            .update({ finished: true });

        // تحقق إن كان الجميع انتهى → انهي الجولة
        const snap = await playersRef.once("value");
        const data = snap.val() || {};
        const arr = Object.values(data);
        const allFinished = arr.length > 0 && arr.every((p) => p.finished);
        if (allFinished) {
          await liveRef.update({ status: "ended", endedAt: Date.now() });
          finalize();
        }
      }

      /* ========== الترتيب المباشر ========== */
      function renderLeaders(list) {
        const arr = list
          .slice()
          .sort((a, b) => (b.score || 0) - (a.score || 0));
        leaderList.innerHTML = "";
        arr.forEach((p, i) => {
          const li = document.createElement("li");
          li.className = "leader";
          if (i === 0) li.classList.add("rank1");
          if (i === 1) li.classList.add("rank2");
          if (i === 2) li.classList.add("rank3");

          const crown = i === 0 ? "👑" : i + 1;
          const name = (p.name || "لاعب").toString();
          const score = p.score || 0;
          const pct = Math.min(
            100,
            Math.round((score / Math.max(1, QUESTIONS.length)) * 100)
          );

          li.innerHTML = `
                <div class="crown">${crown}</div>
                <div>
                  <div>${escapeHtml(name)}</div>
                  <div class="bar"><i style="width:${pct}%"></i></div>
                </div>
                <div>${score} نقطة</div>
              `;
          leaderList.appendChild(li);
        });
        topBadge.innerText = arr.length
          ? `${arr[0].name || "لاعب"} (${arr[0].score || 0})`
          : "—";
      }

      function escapeHtml(s) {
        return (s || "").toString().replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      /* ========== إنهاء الجولة + احتفال ========== */
      async function finalize() {
        try {
          const snap = await playersRef.once("value");
          const data = snap.val() || {};
          const arr = Object.entries(data).map(([id, v]) => ({
            id,
            name: v.name || "لاعب",
            score: v.score || 0,
          }));

          if (!arr.length) return;

          // ترتيب اللاعبين حسب النقاط
          arr.sort((a, b) => b.score - a.score);

          const winner = arr[0];
          const winnerName = winner.name;
          const winnerScore = winner.score;

          // تحديث liveRef حتى كل اللاعبين يشوفوا الفائز
          await liveRef.update({
            winnerName,
            winnerScore,
            status: "ended",
            announced: false,
          });

          // تنظيف اللاعبين بعد فترة قصيرة وإعادة المسابقة
          setTimeout(async () => {
            await playersRef.remove();
            await liveRef.update({ status: "waiting" });
            welcomeCard.classList.remove("hidden");
            quizCard.classList.add("hidden");
            started = false;
            statusShort.innerText = "في انتظار";
            statusLabel.innerText = "في انتظار";
          }, 5000);
        } catch (e) {
          console.error("Error in finalize:", e);
        }
      }

      const winnerPopup = document.getElementById("winnerPopup");
      const winnerOverlay = document.getElementById("winnerOverlay");
      const winnerNameEl = document.getElementById("winnerName");
      const winnerScoreEl = document.getElementById("winnerScore");
      const closeWinnerBtn = document.getElementById("closeWinnerPopup");

      function showWinner(name, score) {
        winnerNameEl.innerText = name;
        winnerScoreEl.innerText = score + " نقطة";
        winnerOverlay.classList.add("show");
        winnerPopup.classList.add("show");
      }

      // لما المستخدم يضغط اغلاق أو على overlay
      function hideWinner() {
        // اخفاء البوكس والـ overlay
        winnerOverlay.classList.remove("show");
        winnerPopup.classList.remove("show");

        // عرض صفحة النهاية بعد تأخير قصير
        setTimeout(() => {
          finalPage.classList.remove("hidden"); // بدل add("show") استخدم remove("hidden")
          finalPage.classList.add("show"); // أو خليها add("show") لو عايز أنيميشن
        }, 300);
      }

      // زر الرجوع للشاشة الرئيسية
      backToHomeBtn.addEventListener("click", () => {
        // اخفاء صفحة النهاية
        finalPage.classList.remove("show");
        finalPage.classList.add("hidden");

        // ارجع للواجهة الرئيسية
        welcomeCard.classList.remove("hidden");
        quizCard.classList.add("hidden");
        started = false;
        statusShort.innerText = "في انتظار";
        statusLabel.innerText = "في انتظار";
      });

      // ربط الأحداث
      closeWinnerBtn.addEventListener("click", hideWinner);
      winnerOverlay.addEventListener("click", hideWinner);
      let contestTimer;

      function startContest() {
        // بداية المسابقة
        console.log("المسابقة بدأت!");

        // نشغل العداد الكلي (مثلاً 15 دقيقة = 900,000 ملي ثانية)
        contestTimer = setTimeout(() => {
          endContest();
        }, 15 * 60 * 1000);
      }

      function endContest() {
        console.log("انتهى وقت المسابقة!");
        // هنا تكتب الكود اللي يقفل المسابقة
        // مثلا: منع ارسال اجابات جديدة + اعلان النتيجة
        clearTimeout(contestTimer);
      }

      document.getElementById("openBtn").addEventListener("click", () => {
        QUIZ_OPEN = true;
        alert("✅ المسابقة اتفتحت");
      });

      document.getElementById("stopBtn").addEventListener("click", () => {
        QUIZ_OPEN = false;
        alert("⛔ المسابقة اتقفلت");
      });
    </script>
  </body>
</html>
