<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مسابقة أعضاء جروب المشتركين للتدريب</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Cairo&display=swap");

      body {
        font-family: "Cairo", sans-serif;
        background: linear-gradient(to bottom right, #ffecd2, #fcb69f);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }

      .container {
        background: #fff;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        width: 450px;
        text-align: center;
      }

      h1 {
        margin-bottom: 20px;
        color: #ff5722;
      }
      button {
        padding: 12px 25px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background: #ff5722;
        color: white;
        transition: 0.3s;
      }
      button:hover {
        background: #e64a19;
      }

      .option {
        display: block;
        margin: 12px 0;
        padding: 12px;
        border-radius: 8px;
        background: #f5f5f5;
        cursor: pointer;
        border: 2px solid transparent;
        transition: 0.3s;
      }
      .option:hover {
        background: #ffe0b2;
        border-color: #ff5722;
      }

      #timer {
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 18px;
        color: #ff5722;
      }
      #message {
        margin: 10px 0;
        font-weight: bold;
        font-size: 16px;
      }
      #leaderboard {
        margin-top: 20px;
        text-align: right;
      }
      #leaderboard h3 {
        margin-bottom: 10px;
      }
      #leaderboard ol {
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container" id="quizContainer">
      <h1>مسابقة أعضاء جروب المشتركين للتدريب</h1>
      <button id="participateBtn">المشاركة</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        onValue,
        query,
        orderByChild,
        limitToLast,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // ======= إعداد Firebase =======
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ======= أسئلة المسابقة =======
      const questions = [
        {
          question: "ما هي عاصمة مصر؟",
          options: ["القاهرة", "الإسكندرية", "الأقصر", "الجيزة"],
          answer: "القاهرة",
        },
        {
          question: "أكبر كوكب في النظام الشمسي هو؟",
          options: ["الأرض", "المشتري", "المريخ", "زحل"],
          answer: "المشتري",
        },
        {
          question: "ما هي لغة البرمجة الأكثر استخدامًا في الويب؟",
          options: ["Python", "JavaScript", "C++", "Java"],
          answer: "JavaScript",
        },
        {
          question: "ما هو الحيوان الأسرع في العالم؟",
          options: ["الفهد", "الأسد", "الظبي", "النمر"],
          answer: "الفهد",
        },
        {
          question: "كم عدد الكواكب في النظام الشمسي؟",
          options: ["7", "8", "9", "10"],
          answer: "8",
        },
      ];

      let currentIndex = 0;
      let score = 0;
      let timer;
      const timePerQuestion = 15;
      let playerName = "";
      let questionsShuffled = [];

      const container = document.getElementById("quizContainer");
      const participateBtn = document.getElementById("participateBtn");

      // ======= أصوات حماسية =======
      const correctSound = new Audio(
        "https://www.fesliyanstudios.com/play-mp3/387"
      );
      const wrongSound = new Audio(
        "https://www.fesliyanstudios.com/play-mp3/404"
      );
      const timeUpSound = new Audio(
        "https://www.fesliyanstudios.com/play-mp3/6606"
      );

      // ======= زر المشاركة =======
      participateBtn.addEventListener("click", () => {
        playerName = prompt("ادخل اسمك للمشاركة:") || "لاعب مجهول";
        startQuiz();
      });

      // ======= خلط الأسئلة =======
      function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
      }

      // ======= بدء المسابقة =======
      function startQuiz() {
        currentIndex = 0;
        score = 0;
        questionsShuffled = shuffle([...questions]);
        showQuestion();
      }

      // ======= عرض السؤال =======
      function showQuestion() {
        if (currentIndex >= questionsShuffled.length) {
          endQuiz();
          return;
        }

        const q = questionsShuffled[currentIndex];
        container.innerHTML = `
    <div id="timer">الوقت المتبقي: ${timePerQuestion}s</div>
    <h2>${q.question}</h2>
    <div id="message"></div>
    ${shuffle([...q.options])
      .map(
        (opt) =>
          `<div class="option" onclick="selectOption('${opt}')">${opt}</div>`
      )
      .join("")}
    <div id="leaderboard"><h3>Leaderboard:</h3><ol id="leaderboardList"></ol></div>
  `;

        updateLeaderboard();

        let timeLeft = timePerQuestion;
        timer = setInterval(() => {
          timeLeft--;
          document.getElementById(
            "timer"
          ).innerText = `الوقت المتبقي: ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(timer);
            timeUpSound.play();
            currentIndex++;
            showQuestion();
          }
        }, 1000);
      }

      // ======= اختيار الإجابة =======
      window.selectOption = function (selected) {
        clearInterval(timer);
        const q = questionsShuffled[currentIndex];
        const messageDiv = document.getElementById("message");
        if (selected === q.answer) {
          score++;
          messageDiv.innerText = "إجابة صحيحة! ✅";
          messageDiv.style.color = "green";
          correctSound.play();
        } else {
          messageDiv.innerText = `خطأ ❌ الإجابة الصحيحة: ${q.answer}`;
          messageDiv.style.color = "red";
          wrongSound.play();
        }
        currentIndex++;
        setTimeout(showQuestion, 1000);
      };

      // ======= إنهاء المسابقة وإرسال النتيجة =======
      function endQuiz() {
        push(ref(db, "leaderboard"), { name: playerName, score: score });
        container.innerHTML = `
    <h2>انتهت المسابقة!</h2>
    <div id="result">لقد حصلت على ${score} / ${questionsShuffled.length} نقاط</div>
    <div id="leaderboard"><h3>Leaderboard:</h3><ol id="leaderboardList"></ol></div>
    <button onclick="restart()">إعادة المسابقة</button>
  `;
        updateLeaderboard();
      }

      // ======= تحديث Leaderboard مباشر =======
      function updateLeaderboard() {
        const leaderboardList = document.getElementById("leaderboardList");
        if (!leaderboardList) return;

        const leaderboardRef = query(
          ref(db, "leaderboard"),
          orderByChild("score"),
          limitToLast(10)
        );
        onValue(leaderboardRef, (snapshot) => {
          const data = snapshot.val();
          if (!data) return;
          const sorted = Object.values(data).sort((a, b) => b.score - a.score);
          leaderboardList.innerHTML = sorted
            .map((item) => `<li>${item.name} - ${item.score}</li>`)
            .join("");
        });
      }

      // ======= إعادة المسابقة =======
      function restart() {
        location.reload();
      }
    </script>
  </body>
</html>
