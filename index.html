<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ø±ÙˆØ¨ - ÙƒØ§Ù…Ù„ (Admin + Live Quiz)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #ff5722;
        --bg1: #ffecd2;
        --bg2: #fcb69f;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Cairo", system-ui, Segoe UI, Arial, sans-serif;
        background: linear-gradient(135deg, var(--bg1), var(--bg2));
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .card {
        width: 100%;
        max-width: 1000px;
        background: #fff;
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 12px 34px rgba(0, 0, 0, 0.12);
      }
      h1 {
        margin: 0 0 6px;
        color: var(--brand);
        font-size: 22px;
      }
      p.muted {
        color: #666;
        margin: 6px 0;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type="text"],
      input[type="number"] {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-size: 15px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
      }
      .small {
        padding: 8px 10px;
        border-radius: 8px;
      }
      .pill {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        background: #fff;
        padding: 8px;
        border-radius: 999px;
        border: 1px solid #eee;
      }
      .two-col {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 14px;
        margin-top: 14px;
      }
      .board {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 10px;
      }
      .board h3 {
        margin: 0 0 8px;
      }
      .board ol {
        margin: 0;
        padding-left: 18px;
        max-height: 360px;
        overflow: auto;
      }
      .question-card {
        background: #fff;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .options {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }
      .option {
        background: #f7f7f7;
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid transparent;
        text-align: center;
        transition: all 0.15s;
        user-select: none;
      }
      .option:active {
        transform: scale(0.995);
      }
      .option:hover {
        background: #fff3e8;
        border-color: var(--brand);
      }
      #timer {
        font-weight: 800;
        color: var(--brand);
        margin-bottom: 8px;
      }
      #message {
        font-weight: 700;
        margin-top: 8px;
      }
      .center {
        text-align: center;
      }
      .admin-area {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .note {
        font-size: 13px;
        color: #666;
      }

      @media (max-width: 880px) {
        .two-col {
          grid-template-columns: 1fr 260px;
        }
      }
      @media (max-width: 640px) {
        .two-col {
          grid-template-columns: 1fr;
        }
        .board {
          order: 2;
        }
        .row {
          flex-direction: column;
          align-items: stretch;
        }
        input[type="text"] {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="card" id="app">
      <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</h1>
      <p class="muted">
        Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø£Ø¯Ù…ÙÙ† + Ø´Ø§Ø´Ø© Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ responsiveØŒ ØµÙˆØª ØªØ´Ø¬ÙŠØ¹ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©ØŒ
        ÙˆØ§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø¹Ù†Ø¯ refresh.
      </p>

      <!-- ADMIN CONTROLS -->
      <div class="admin-area">
        <label
          >ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (Ø¯Ù‚Ø§ÙŠÙ‚):
          <input id="timeInput" type="number" min="1" value="5"
        /></label>
        <label
          >Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„ÙˆØ¨ÙŠ:
          <input id="minPlayersInput" type="number" min="1" value="2"
        /></label>
        <button class="btn" id="saveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¢Ù†</button>
        <button class="btn small" id="forceEndBtn">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
        <button class="btn small" id="clearPlayersBtn">
          Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø§Ø®ØªØ¨Ø§Ø±ÙŠ)
        </button>
      </div>
      <div class="note">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…ÙÙ† Ù…Ø±Ø¦ÙŠØ© Ù„Ø£ÙŠ Ø´Ø®Øµ ÙŠÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¢Ù† â€” Ù„Ùˆ Ø¹Ø§ÙŠØ²Ø© ØªÙ…ÙŠÙ‘Ø²ÙŠ
        Ø§Ù„Ø£Ø¯Ù…ÙÙ†ØŒ Ù…Ù…ÙƒÙ† Ø£Ø¶ÙŠÙ Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.
      </div>

      <!-- LOBBY / PLAYER JOIN -->
      <div style="margin-top: 12px" class="row">
        <input id="playerName" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
        <button class="btn" id="joinBtn">Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
        <button class="btn small" id="toggleVoice">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª</button>
        <div style="margin-left: auto" class="pill">
          Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†: <b id="playersCount">0</b>
        </div>
        <div class="pill">Ø§Ù„Ø­Ø§Ù„Ø©: <b id="statusPill">waiting</b></div>
      </div>

      <div class="two-col">
        <!-- Quiz Area -->
        <div>
          <div class="question-card" id="quizCard">
            <div id="timer">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©...</div>
            <h2 id="questionText">Ø³Ø¤Ø§Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</h2>
            <div id="message"></div>
            <div class="options" id="options"></div>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="board">
          <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
          <ol id="leaderboardList"></ol>
        </div>
      </div>

      <div style="margin-top: 12px" class="board">
        <h3>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</h3>
        <ol id="playersList"></ol>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        onValue,
        onDisconnect,
        serverTimestamp,
        runTransaction,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // ===== Firebase config (Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ) =====
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ===== Settings refs =====
      const lobbyRef = ref(db, "liveQuiz");
      const playersRef = ref(db, "liveQuiz/players");
      const settingsRef = ref(db, "liveQuiz/settings");
      const statusRef = ref(db, "liveQuiz/status");

      // ===== Default client settings =====
      let PLAYER_ID = null;
      let PLAYER_NAME = "";
      let localScore = 0;
      let localQIndex = 0;
      let shuffledBank = [];
      let quizEndAt = null;
      let totalTimeSeconds = 300;
      let minPlayers = 2;
      let voiceOn = true;

      // ===== UX elements =====
      const $ = (s) => document.querySelector(s);
      const optionsEl = $("#options");
      const questionTextEl = $("#questionText");
      const timerEl = $("#timer");
      const messageEl = $("#message");

      // ===== Sounds and speech =====
      const sndCorrect = new Audio(
        "https://cdn.pixabay.com/download/audio/2021/08/04/audio_6a0b0f24c1.mp3?filename=success-fanfare-trumpets-6185.mp3"
      );
      const sndWrong = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_3f0a9a5e17.mp3?filename=wrong-buzzer-6266.mp3"
      );
      const sndTick = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_9c1d2b1a4d.mp3?filename=clock-tick-6272.mp3"
      );
      const sndTimeUp = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_1b5b8b5a3b.mp3?filename=bell-small-6282.mp3"
      );

      const unlockAudio = () => {
        [sndCorrect, sndWrong, sndTick, sndTimeUp].forEach((a) => {
          a.muted = false;
          a.play()
            .then(() => a.pause())
            .catch(() => {});
        });
        document.removeEventListener("click", unlockAudio);
      };
      document.addEventListener("click", unlockAudio);

      // ===== Question bank (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§) =====
      const QUESTIONS = [
        {
          q: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ",
          opts: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„Ø¬ÙŠØ²Ø©"],
          a: "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©",
        },
        {
          q: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠ Ù‡ÙˆØŸ",
          opts: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø²Ø­Ù„"],
          a: "Ø§Ù„Ù…Ø´ØªØ±ÙŠ",
        },
        {
          q: "Ù„ØºØ© Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø£Ø´Ù‡Ø± Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©ØŸ",
          opts: ["Python", "JavaScript", "C++", "Java"],
          a: "JavaScript",
        },
        {
          q: "Ø£Ø³Ø±Ø¹ Ø­ÙŠÙˆØ§Ù† Ø¨Ø±ÙŠØŸ",
          opts: ["Ø§Ù„ÙÙ‡Ø¯", "Ø§Ù„Ø£Ø³Ø¯", "Ø§Ù„Ø¸Ø¨ÙŠ", "Ø§Ù„Ù†Ù…Ø±"],
          a: "Ø§Ù„ÙÙ‡Ø¯",
        },
        {
          q: "ÙƒÙ… Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠØŸ",
          opts: ["7", "8", "9", "10"],
          a: "8",
        },
        // Ø²ÙŠØ¯ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø±Ø¨Ø·ÙŠÙ‡Ø§ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª
      ];

      // ===== Helpers =====
      function shuffle(arr) {
        return arr.slice().sort(() => Math.random() - 0.5);
      }
      function escapeHtml(s) {
        return (s || "")
          .toString()
          .replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
      }

      // ===== Admin actions =====
      $("#saveSettings").addEventListener("click", async () => {
        const minutes = parseInt($("#timeInput").value) || 5;
        minPlayers = parseInt($("#minPlayersInput").value) || 2;
        totalTimeSeconds = minutes * 60;
        await update(lobbyRef, {
          settings: { totalTime: totalTimeSeconds, minPlayers },
        });
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
      });

      $("#startBtn").addEventListener("click", async () => {
        // set settings if not set
        const settingsSnap = await new Promise((res) =>
          onValue(
            ref(db, "liveQuiz/settings"),
            (s) => {
              res(s.val());
            },
            { onlyOnce: true }
          )
        );
        if (!settingsSnap || !settingsSnap.totalTime) {
          totalTimeSeconds = (parseInt($("#timeInput").value) || 5) * 60;
          await update(lobbyRef, {
            settings: { totalTime: totalTimeSeconds, minPlayers },
          });
        }
        // force countdown -> started sequence
        await update(lobbyRef, {
          status: "countdown",
          lobbyCountdownStartsAt: serverTimestamp(),
        });
        alert("ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯. Ø³ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.");
      });

      $("#forceEndBtn").addEventListener("click", async () => {
        await update(lobbyRef, { status: "ended" });
        alert("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
      });
      $("#clearPlayersBtn").addEventListener("click", async () => {
        if (confirm("Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø§Ø®ØªØ¨Ø§Ø±ÙŠ)ØŸ")) await remove(playersRef);
      });

      // ===== Player join =====
      $("#joinBtn").addEventListener("click", async () => {
        PLAYER_NAME = (
          $("#playerName").value ||
          localStorage.getItem("savedName") ||
          "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„"
        ).trim();
        if (!PLAYER_NAME) PLAYER_NAME = "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";
        localStorage.setItem("savedName", PLAYER_NAME);
        // create player row
        const newKey = push(playersRef).key;
        PLAYER_ID = newKey;
        await set(ref(db, `liveQuiz/players/${PLAYER_ID}`), {
          name: PLAYER_NAME,
          score: 0,
          currentQuestion: 0,
          joinedAt: serverTimestamp(),
          lastSeen: serverTimestamp(),
        });
        onDisconnect(ref(db, `liveQuiz/players/${PLAYER_ID}`)).remove();
        $("#joinBtn").disabled = true;
        $("#joinBtn").textContent = "Ù…ØªØµÙ„";
      });

      // ===== Listen players list & auto-start countdown when min reached =====
      onValue(playersRef, (snap) => {
        const data = snap.val() || {};
        const arr = Object.values(data);
        $("#playersCount").textContent = arr.length;
        $("#playersList").innerHTML = arr
          .map((p) => `<li>${escapeHtml(p.name)}</li>`)
          .join("");

        // If enough players and current status is waiting, set to countdown via transaction to avoid race
        onValue(
          ref(db, "liveQuiz/status"),
          (s) => {
            const st = s.val() || "waiting";
            if (
              st === "waiting" &&
              arr.length >=
                ((document.getElementById("minPlayersInput") &&
                  parseInt(document.getElementById("minPlayersInput").value)) ||
                  minPlayers)
            ) {
              runTransaction(ref(db, "liveQuiz/status"), (cur) => {
                if (cur === "waiting" || cur === null) return "countdown";
                return cur;
              })
                .then((res) => {
                  if (res.committed && res.snapshot.val() === "countdown") {
                    update(lobbyRef, {
                      lobbyCountdownStartsAt: serverTimestamp(),
                    });
                  }
                })
                .catch(() => {});
            }
          },
          { onlyOnce: true }
        );
      });

      // ===== Listen lobby state =====
      onValue(lobbyRef, (snap) => {
        const data = snap.val() || {};
        const status = data.status || (data.settings ? "waiting" : "waiting");
        const startsAt = data.lobbyCountdownStartsAt;
        $("#statusPill").textContent = status;

        if (status === "countdown") startLobbyCountdown(startsAt);
        if (status === "started") {
          // set quiz end time
          const quizStartsAt = data.quizStartsAt || Date.now();
          const settings = data.settings || {};
          totalTimeSeconds = settings.totalTime || totalTimeSeconds;
          quizEndAt = quizStartsAt + totalTimeSeconds * 1000;
          enterQuizIfJoined();
        }
        if (status === "ended") {
          finishAllLocally();
        }
      });

      // ===== Lobby countdown (client-side display) =====
      let lobbyTicker = null;
      function startLobbyCountdown(startsAt) {
        clearInterval(lobbyTicker);
        lobbyTicker = setInterval(() => {
          const startMs =
            typeof startsAt === "number"
              ? startsAt
              : startsAt && startsAt[".sv"]
              ? Date.now()
              : Date.now();
          const endAt = startMs + (parseInt($("#timeInput").value) || 5) * 1000;
          // We use LOBBY_COUNTDOWN_SECONDS fixed 10s display to clients (short countdown before starting)
          const remain = Math.max(
            0,
            Math.floor((startMs + 10000 - Date.now()) / 1000)
          );
          $("#timer").textContent = `ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„: ${remain} Ø«Ø§Ù†ÙŠØ©`;
          if (remain <= 0) {
            clearInterval(lobbyTicker);
            runTransaction(ref(db, "liveQuiz/status"), (cur) => {
              if (cur === "countdown") return "started";
              return cur;
            })
              .then((res) => {
                if (res.committed) {
                  update(lobbyRef, {
                    quizStartsAt: serverTimestamp(),
                    status: "started",
                  });
                }
              })
              .catch(() => {});
          }
        }, 300);
      }

      // ===== Enter quiz screen if player joined =====
      function enterQuizIfJoined() {
        if (!PLAYER_ID) return; // not joined yet
        // load resume data if any
        onValue(
          ref(db, `liveQuiz/players/${PLAYER_ID}`),
          (snap) => {
            const data = snap.val();
            if (!data) return;
            localScore = data.score || 0;
            localQIndex = data.currentQuestion || 0;
          },
          { onlyOnce: true }
        ).then(() => {
          enterQuiz();
        });
      }

      // ===== Enter quiz UI =====
      let globalTimer = null;
      function enterQuiz() {
        shuffledBank = shuffle(QUESTIONS);
        // If player has progress (localQIndex) resume from there
        // show quiz UI
        document
          .querySelector("#quizCard")
          .scrollIntoView({ behavior: "smooth" });
        // start global timer
        startGlobalTimer();
        renderQuestion();
        // listen leaderboard updates
        onValue(playersRef, (snap) => {
          const data = snap.val() || {};
          const arr = Object.values(data).sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );
          $("#leaderboardList").innerHTML = arr
            .map((p) => `<li>${escapeHtml(p.name)} - ${p.score || 0}</li>`)
            .join("");
        });
      }

      function startGlobalTimer() {
        clearInterval(globalTimer);
        if (!quizEndAt) quizEndAt = Date.now() + totalTimeSeconds * 1000;
        globalTimer = setInterval(() => {
          const remain = Math.max(
            0,
            Math.floor((quizEndAt - Date.now()) / 1000)
          );
          $("#timer").textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: ${remain} Ø«Ø§Ù†ÙŠØ©`;
          if (remain <= 0) {
            clearInterval(globalTimer);
            finishAllLocally();
          }
        }, 500);
      }

      // ===== Rendering questions & answer flow =====
      let optionLock = false; // prevent double click spams
      function renderQuestion() {
        if (localQIndex >= shuffledBank.length) {
          finishAllLocally();
          return;
        }
        const q = shuffledBank[localQIndex];
        questionTextEl.textContent = q.q;
        messageEl.textContent = "";
        optionsEl.innerHTML = "";
        shuffle(q.opts).forEach((opt) => {
          const d = document.createElement("div");
          d.className = "option";
          d.textContent = opt;
          d.onclick = () => {
            if (optionLock) return;
            optionLock = true;
            setTimeout(() => (optionLock = false), 700);
            handleAnswer(opt === q.a);
          };
          optionsEl.appendChild(d);
        });
      }

      async function handleAnswer(isCorrect) {
        if (isCorrect) {
          localScore++;
          messageEl.textContent = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
          messageEl.style.color = "green";
          sndCorrect.play().catch(() => {});
        } else {
          messageEl.textContent = "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© âŒ";
          messageEl.style.color = "#d00";
          sndWrong.play().catch(() => {});
        }
        localQIndex++;
        // Debounced write: update player's score & currentQuestion once
        try {
          await update(ref(db, `liveQuiz/players/${PLAYER_ID}`), {
            score: localScore,
            currentQuestion: localQIndex,
            lastSeen: serverTimestamp(),
          });
        } catch (e) {}
        // render next if time remains
        setTimeout(() => {
          if (Date.now() < quizEndAt) renderQuestion();
          else finishAllLocally();
        }, 700);
      }

      // ===== Finish logic =====
      function finishAllLocally() {
        // show results locally
        clearInterval(globalTimer);
        // fetch final leaderboard once
        onValue(
          playersRef,
          (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );
            $("#leaderboardList").innerHTML = arr
              .map((p) => `<li>${escapeHtml(p.name)} - ${p.score || 0}</li>`)
              .join("");
            $("#playersList").innerHTML = arr
              .map((p) => `<li>${escapeHtml(p.name)} - ${p.score || 0}</li>`)
              .join("");
          },
          { onlyOnce: true }
        );
        $("#timer").textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©";
        questionTextEl.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸ‰";
        optionsEl.innerHTML = "";
        // announce winner via speech
        announceTop();
      }

      // ===== Announce top player (speech synthesis) =====
      let lastAnnounced = null;
      function announceTop() {
        if (!voiceOn) return;
        onValue(
          playersRef,
          (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );
            if (arr.length === 0) return;
            const top = arr[0];
            if (!top) return;
            if (top.name === lastAnnounced) return;
            lastAnnounced = top.name;
            const msg = `Ø¨Ø±Ø§ÙÙˆ ÙŠØ§ ${top.name}! Ø§Ù†Øª Ø§Ù„Ø§ÙˆÙ„ Ø¯Ù„ÙˆÙ‚ØªÙŠ`;
            const u = new SpeechSynthesisUtterance(msg);
            u.lang = "ar-EG";
            u.rate = 0.95;
            u.pitch = 1;
            try {
              window.speechSynthesis.cancel();
              window.speechSynthesis.speak(u);
            } catch (e) {}
          },
          { onlyOnce: true }
        );
      }

      // periodic cheer (only when leaderboard changes top)
      setInterval(() => {
        if (!voiceOn) return;
        announceTop();
      }, 30000);

      // toggle voice
      $("#toggleVoice").addEventListener("click", () => {
        voiceOn = !voiceOn;
        $("#toggleVoice").textContent = voiceOn ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª" : "ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª";
      });

      // Utils for testing
      window.forceStart = async () => {
        await update(lobbyRef, {
          status: "started",
          quizStartsAt: serverTimestamp(),
        });
      };
      window.forceEnd = async () => {
        await update(lobbyRef, { status: "ended" });
      };
    </script>
  </body>
</html>
