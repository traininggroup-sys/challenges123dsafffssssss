<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨ - Ù…Ø¨Ø§Ø´Ø± (Responsive + ØµÙˆØª)
    </title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #ff5722;
        --bg1: #ffecd2;
        --bg2: #fcb69f;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Cairo", system-ui, Segoe UI, Arial, sans-serif;
        background: linear-gradient(135deg, var(--bg1), var(--bg2));
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .card {
        width: 100%;
        max-width: 940px;
        background: #fff;
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      }
      h1 {
        margin: 0 0 8px;
        color: var(--brand);
        font-size: 22px;
      }
      p.muted {
        color: #666;
        margin: 6px 0;
      }

      .lobby-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type="text"] {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-size: 15px;
        width: 260px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.small {
        padding: 8px 10px;
        border-radius: 8px;
      }

      .pill {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        background: #fff;
        padding: 8px;
        border-radius: 999px;
        border: 1px solid #eee;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 14px;
        margin-top: 12px;
      }
      .board {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 10px;
      }
      .board h3 {
        margin: 0 0 8px;
      }
      .board ol {
        margin: 0;
        padding-left: 18px;
        max-height: 360px;
        overflow: auto;
      }

      .question-card {
        background: #fff;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .options {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }
      .option {
        background: #f7f7f7;
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.15s;
      }
      .option:hover {
        background: #fff3e8;
        border-color: var(--brand);
      }

      #timer {
        font-weight: 800;
        color: var(--brand);
        margin-bottom: 6px;
      }
      #message {
        font-weight: 700;
        margin-top: 8px;
      }

      .center {
        text-align: center;
      }

      /* responsive */
      @media (max-width: 880px) {
        .two-col {
          grid-template-columns: 1fr 260px;
        }
      }
      @media (max-width: 640px) {
        .two-col {
          grid-template-columns: 1fr;
        }
        .board {
          order: 2;
        }
        .lobby-row {
          flex-direction: column;
          align-items: stretch;
        }
        input[type="text"] {
          width: 100%;
        }
        .board ol {
          max-height: 220px;
        }
        h1 {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card" id="app">
      <!-- LOBBY -->
      <div id="screen-lobby">
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</h1>
        <p class="muted">
          Ø§Ø¶ØºØ·ÙŠ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§Ø¨Ù‚ÙŠ Ù…ØªØµÙ„Ø©. Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù‡ØªØ¨Ø¯Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù…Ø§ ÙŠÙˆØµÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
          Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯.
        </p>

        <div class="lobby-row">
          <input id="playerName" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
          <button id="joinBtn" class="btn">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
          <button id="muteVoice" class="btn small">Ø¥ÙŠÙ‚Ø§Ù/ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
        </div>

        <div
          style="
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
          "
        >
          <div class="pill">Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†: <b id="playersCount">0</b></div>
          <div class="pill">
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¨Ø¯Ø¡: <b id="minPlayersPill">--</b>
          </div>
          <div class="pill">ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: <b id="totalTimePill">--</b></div>
        </div>

        <div style="margin-top: 10px" class="center">
          <div id="lobbyStatus">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†...</div>
          <div
            id="lobbyCountdown"
            style="font-weight: 800; color: var(--brand); margin-top: 6px"
          ></div>
        </div>

        <div class="board" style="margin-top: 12px">
          <h3>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h3>
          <ol id="playersList"></ol>
        </div>
      </div>

      <!-- QUIZ -->
      <div id="screen-quiz" style="display: none">
        <div class="two-col">
          <div>
            <div class="question-card">
              <div id="timer">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: --</div>
              <h2 id="questionText">Ø³Ø¤Ø§Ù„</h2>
              <div id="message"></div>
              <div class="options" id="options"></div>
            </div>
          </div>
          <div class="board">
            <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
            <ol id="leaderboardList"></ol>
          </div>
        </div>
      </div>

      <!-- END -->
      <div id="screen-end" style="display: none">
        <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸ‰</h2>
        <p class="muted">Ù†ØªÙŠØ¬ØªÙƒ: <b id="finalScore">0</b></p>
        <div class="board">
          <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
          <ol id="finalBoard"></ol>
        </div>
        <div class="center" style="margin-top: 12px">
          <button class="btn" onclick="location.reload()">
            Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        onValue,
        onDisconnect,
        serverTimestamp,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // ===== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù„Ùˆ Ø§Ø®ØªÙ„ÙØª) =====
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) =====
      const MIN_PLAYERS = 2; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      const LOBBY_COUNTDOWN_SECONDS = 20; // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù„ÙˆØ¨ÙŠ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø­Ø¯
      const TOTAL_TIME = 300; // ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙƒÙ„ÙŠ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (Ù…Ø«Ù„Ø§Ù‹ 5 Ø¯Ù‚Ø§Ø¦Ù‚)

      document.getElementById("minPlayersPill").textContent = MIN_PLAYERS;
      document.getElementById("totalTimePill").textContent = `${Math.floor(
        TOTAL_TIME / 60
      )} Ø¯Ù‚Ø§Ø¦Ù‚`;

      // Ø£ØµÙˆØ§Øª Ø­Ø¯Ø«ÙŠØ© (Ø±ÙˆØ§Ø¨Ø· Ø¢Ù…Ù†Ø© Ù…Ù† pixabay)
      const sndCorrect = new Audio(
        "https://cdn.pixabay.com/download/audio/2021/08/04/audio_6a0b0f24c1.mp3?filename=success-fanfare-trumpets-6185.mp3"
      );
      const sndWrong = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_3f0a9a5e17.mp3?filename=wrong-buzzer-6266.mp3"
      );
      const sndTick = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_9c1d2b1a4d.mp3?filename=clock-tick-6272.mp3"
      );
      const sndTimeUp = new Audio(
        "https://cdn.pixabay.com/download/audio/2022/03/15/audio_1b5b8b5a3b.mp3?filename=bell-small-6282.mp3"
      );

      let voiceEnabled = true;
      document.getElementById("muteVoice").addEventListener("click", () => {
        voiceEnabled = !voiceEnabled;
        document.getElementById("muteVoice").textContent = voiceEnabled
          ? "Ø¥ÙŠÙ‚Ø§Ù/ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª"
          : "Ø§Ù„ØµÙˆØª Ù…ØªÙˆÙ‚Ù";
      });

      // Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙƒ Ù‚ÙŠØ¯ autoplay Ø¹Ø¨Ø± Ù†Ù‚Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const unlockAudio = () => {
        [sndCorrect, sndWrong, sndTick, sndTimeUp].forEach((a) => {
          a.muted = false;
          a.play()
            .then(() => a.pause())
            .catch(() => {});
        });
        document.removeEventListener("click", unlockAudio);
      };
      document.addEventListener("click", unlockAudio);

      // Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      const QUESTIONS = [
        {
          q: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ",
          opts: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„Ø¬ÙŠØ²Ø©"],
          a: "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©",
        },
        {
          q: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠ Ù‡ÙˆØŸ",
          opts: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø²Ø­Ù„"],
          a: "Ø§Ù„Ù…Ø´ØªØ±ÙŠ",
        },
        {
          q: "Ù„ØºØ© Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø£Ø´Ù‡Ø± Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©ØŸ",
          opts: ["Python", "JavaScript", "C++", "Java"],
          a: "JavaScript",
        },
        {
          q: "Ø£Ø³Ø±Ø¹ Ø­ÙŠÙˆØ§Ù† Ø¨Ø±ÙŠØŸ",
          opts: ["Ø§Ù„ÙÙ‡Ø¯", "Ø§Ù„Ø£Ø³Ø¯", "Ø§Ù„Ø¸Ø¨ÙŠ", "Ø§Ù„Ù†Ù…Ø±"],
          a: "Ø§Ù„ÙÙ‡Ø¯",
        },
        {
          q: "ÙƒÙ… Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠØŸ",
          opts: ["7", "8", "9", "10"],
          a: "8",
        },
      ];

      // Ø¹Ù†Ø§ØµØ± DOM
      const el = (s) => document.querySelector(s);
      const screenLobby = el("#screen-lobby");
      const screenQuiz = el("#screen-quiz");
      const screenEnd = el("#screen-end");

      // Ù…Ø±Ø§Ø¬Ø¹ Firebase
      const lobbyRef = ref(db, "liveQuiz");
      const playersRef = ref(db, "liveQuiz/players");
      const statusRef = ref(db, "liveQuiz/status");

      // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      let playerId = null,
        playerName = "",
        score = 0,
        qIndex = 0,
        shuffled = [],
        globalTimer = null,
        quizEndAt = null;

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
      onValue(playersRef, (snap) => {
        const data = snap.val() || {};
        const arr = Object.values(data);
        el("#playersCount").textContent = arr.length;
        el("#playersList").innerHTML = arr
          .map((p) => `<li>${escapeHtml(p.name || "Ù„Ø§Ø¹Ø¨")}</li>`)
          .join("");

        // Ù„Ùˆ Ø§Ø­Ù†Ø§ ÙÙŠ waiting ÙˆÙˆØµÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù„Ù„Ø­Ø¯ØŒ Ù†ÙØ¹Ù„ Ø­Ø§Ù„Ø© countdown Ø¨Ø¥Ø³ØªØ®Ø¯Ø§Ù… transaction
        onValue(
          statusRef,
          (sSnap) => {
            const st = sSnap.val() || "waiting";
            if (st === "waiting" && arr.length >= MIN_PLAYERS) {
              runTransaction(statusRef, (cur) => {
                if (cur === "waiting" || cur === null) return "countdown";
                return cur;
              })
                .then((res) => {
                  if (res.committed && res.snapshot.val() === "countdown") {
                    update(lobbyRef, {
                      lobbyCountdownStartsAt: serverTimestamp(),
                    });
                  }
                })
                .catch(() => {});
            }
          },
          { onlyOnce: true }
        );
      });

      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØ¨ÙŠ/Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
      onValue(lobbyRef, (snap) => {
        const data = snap.val() || {};
        const status = data.status || "waiting";
        const startsAt = data.lobbyCountdownStartsAt;
        const quizStartsAt = data.quizStartsAt;

        if (status === "waiting") {
          el("#lobbyStatus").textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†...";
          el("#lobbyCountdown").textContent = "";
        }
        if (status === "countdown") {
          el("#lobbyStatus").textContent = "ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„:";
          startLobbyCountdown(startsAt);
        }
        if (status === "started") {
          // Ù†Ø­Ø³Ø¨ ÙˆÙ‚Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ quizStartsAt
          const startMs = quizStartsAt
            ? typeof quizStartsAt === "number"
              ? quizStartsAt
              : Date.now()
            : Date.now();
          quizEndAt = startMs + TOTAL_TIME * 1000;
          startGlobalTimer();
          // ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠØ¸Ù‡Ø± Ù„Ù‡ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ùˆ Ù‡Ùˆ Ù…Ø³Ø¬Ù„
          if (playerId) {
            enterQuizScreen();
          }
        }
        if (status === "ended") {
          // Ø¥Ø¹Ù„Ø§Ù† Ù†Ù‡Ø§ÙŠØ©
          endScreen();
        }
      });

      // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù„ÙˆØ¨ÙŠ (Ø¹Ù…ÙŠÙ„ side countdown ÙÙ‚Ø·)
      let lobbyTicker = null;
      function startLobbyCountdown(startsAt) {
        if (!startsAt) return;
        clearInterval(lobbyTicker);
        lobbyTicker = setInterval(() => {
          const startMs = typeof startsAt === "number" ? startsAt : Date.now();
          const endAt = startMs + LOBBY_COUNTDOWN_SECONDS * 1000;
          const remain = Math.max(0, Math.floor((endAt - Date.now()) / 1000));
          el("#lobbyCountdown").textContent = remain + " Ø«Ø§Ù†ÙŠØ©";
          if (remain <= 0) {
            clearInterval(lobbyTicker);
            runTransaction(statusRef, (cur) => {
              if (cur === "countdown") return "started";
              return cur;
            })
              .then((res) => {
                if (res.committed) {
                  update(lobbyRef, { quizStartsAt: serverTimestamp() });
                }
              })
              .catch(() => {});
          }
        }, 300);
      }

      // Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
      el("#joinBtn").addEventListener("click", async () => {
        playerName = (el("#playerName").value || "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„").trim();
        if (!playerName) playerName = "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";
        const newKey = push(playersRef).key;
        playerId = newKey;
        await set(ref(db, `liveQuiz/players/${playerId}`), {
          name: playerName,
          score: 0,
          joinedAt: serverTimestamp(),
          lastSeen: serverTimestamp(),
        });
        onDisconnect(ref(db, `liveQuiz/players/${playerId}`)).remove();
        el("#joinBtn").disabled = true;
        el("#joinBtn").textContent = "Ø§Ù†Øª Ù…ØªØµÙ„";
        el("#lobbyStatus").textContent = "ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… âœ”ï¸";
      });

      // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
      function startGlobalTimer() {
        clearInterval(globalTimer);
        if (!quizEndAt) quizEndAt = Date.now() + TOTAL_TIME * 1000;
        globalTimer = setInterval(() => {
          const remain = Math.max(
            0,
            Math.floor((quizEndAt - Date.now()) / 1000)
          );
          el("#timer").textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: ${remain} Ø«Ø§Ù†ÙŠØ©`;
          if (remain <= 0) {
            clearInterval(globalTimer);
            if (playerId) finishQuizLocal();
          }
        }, 500);
      }

      // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¯Ø®Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
      function enterQuizScreen() {
        shuffled = shuffle(QUESTIONS);
        qIndex = 0;
        score = 0;
        screenLobby.style.display = "none";
        screenEnd.style.display = "none";
        screenQuiz.style.display = "block";
        renderQuestion();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±
        onValue(playersRef, (snap) => {
          const data = snap.val() || {};
          const arr = Object.values(data).sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );
          el("#leaderboardList").innerHTML = arr
            .map(
              (p) =>
                `<li>${escapeHtml(p.name || "Ù„Ø§Ø¹Ø¨")} - ${p.score || 0}</li>`
            )
            .join("");
        });
      }

      function renderQuestion() {
        if (qIndex >= shuffled.length) {
          // Ù„Ùˆ Ø®Ù„ØµØª Ø¨Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
          finishQuizLocal();
          return;
        }
        const q = shuffled[qIndex];
        el("#questionText").textContent = q.q;
        el("#message").textContent = "";
        const opts = shuffle(q.opts);
        const wrap = el("#options");
        wrap.innerHTML = "";
        opts.forEach((op) => {
          const d = document.createElement("div");
          d.className = "option";
          d.textContent = op;
          d.onclick = () => onAnswer(op === q.a);
          wrap.appendChild(d);
        });
      }

      function onAnswer(correct) {
        if (correct) {
          score++;
          el("#message").textContent = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
          el("#message").style.color = "green";
          sndCorrect.play().catch(() => {});
        } else {
          el("#message").textContent = "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© âŒ";
          el("#message").style.color = "#d00";
          sndWrong.play().catch(() => {});
        }
        // Ø­Ø¯Ø« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø³Ø­Ø§Ø¨Ø© â€” ÙŠØ¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· ØªØ¨Ù‚Ù‰ ØªØ±Ø§ÙƒÙ…ÙŠØ©
        if (playerId) {
          update(ref(db, `liveQuiz/players/${playerId}`), {
            score,
            lastSeen: serverTimestamp(),
          });
        }
        qIndex++;
        setTimeout(() => {
          if (Date.now() < quizEndAt) renderQuestion();
          else finishQuizLocal();
        }, 700);
      }

      function finishQuizLocal() {
        screenQuiz.style.display = "none";
        screenEnd.style.display = "block";
        el("#finalScore").textContent = `${score} / ${shuffled.length}`;
        // Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        onValue(
          playersRef,
          (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );
            el("#finalBoard").innerHTML = arr
              .map(
                (p) =>
                  `<li>${escapeHtml(p.name || "Ù„Ø§Ø¹Ø¨")} - ${p.score || 0}</li>`
              )
              .join("");
          },
          { onlyOnce: true }
        );
      }

      function endScreen() {
        screenLobby.style.display = "none";
        screenQuiz.style.display = "none";
        screenEnd.style.display = "block";
      }

      // ØªØ´Ø¬ÙŠØ¹ ØµÙˆØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµØ¯Ø± ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
      let lastTop = null;
      setInterval(() => {
        if (!voiceEnabled) return;
        onValue(
          playersRef,
          (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );
            if (arr.length === 0) return;
            const top = arr[0];
            if (!top) return;
            if (top.name === lastTop) return;
            lastTop = top.name; // ØªØ­Ø¯Ø« ÙÙ‚Ø· Ù„Ùˆ ØªØºÙŠØ± Ø§Ù„Ù…ØªØµØ¯Ø±
            const text = `Ø¨Ø±Ø§ÙÙˆ ÙŠØ§ ${top.name}! Ø¥Ù†Øª Ù…ØªØµØ¯Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠ`;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "ar-EG";
            u.rate = 0.95;
            u.pitch = 1;
            try {
              window.speechSynthesis.cancel();
              window.speechSynthesis.speak(u);
            } catch (e) {}
          },
          { onlyOnce: true }
        );
      }, 30000);

      // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
      function escapeHtml(s) {
        return (s || "")
          .toString()
          .replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
      }
      function shuffle(a) {
        return a.slice().sort(() => Math.random() - 0.5);
      }

      // Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù€ admin ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
      window.firebaseStart = async () => {
        await runTransaction(statusRef, (cur) => {
          if (cur === "waiting" || cur === null) return "countdown";
          return cur;
        });
        await update(lobbyRef, { lobbyCountdownStartsAt: serverTimestamp() });
      };
      window.firebaseForceStart = async () => {
        await set(statusRef, "started");
        await update(lobbyRef, { quizStartsAt: serverTimestamp() });
      };
      window.firebaseEnd = async () => {
        await set(statusRef, "ended");
      };
    </script>
  </body>
</html>
