<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨ - Ù…Ø¨Ø§Ø´Ø±</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #ff5722;
        --bg1: #ffecd2;
        --bg2: #fcb69f;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Cairo", system-ui, Segoe UI, Arial, sans-serif;
        background: linear-gradient(135deg, var(--bg1), var(--bg2));
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
      }
      .card {
        width: min(680px, 92vw);
        background: #fff;
        border-radius: 22px;
        padding: 24px 22px;
        box-shadow: 0 12px 34px rgba(0, 0, 0, 0.12);
      }
      h1 {
        margin: 0 0 14px;
        color: var(--brand);
        font-size: 28px;
      }
      .muted {
        color: #666;
      }
      .btn {
        display: inline-block;
        background: var(--brand);
        color: #fff;
        border: none;
        border-radius: 14px;
        padding: 12px 18px;
        font-size: 16px;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 6px 16px rgba(255, 87, 34, 0.35);
      }
      .btn:hover {
        transform: translateY(-1px);
        filter: brightness(0.95);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .field {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      input[type="text"] {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 15px;
        width: 240px;
      }

      .hr {
        height: 1px;
        background: #eee;
        margin: 16px 0;
      }
      .center {
        text-align: center;
      }

      .options {
        margin-top: 10px;
        display: grid;
        gap: 10px;
      }
      .option {
        border: 2px solid transparent;
        background: #f7f7f7;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: 0.15s;
      }
      .option:hover {
        border-color: var(--brand);
        background: #fff3e8;
      }

      #timer {
        font-weight: 700;
        color: var(--brand);
        margin: 8px 0 12px;
      }
      #message {
        font-weight: 700;
        margin: 8px 0 0;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 220px;
        gap: 14px;
      }
      .board {
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 10px;
      }
      .board h3 {
        margin: 0 0 8px;
        font-size: 16px;
      }
      .board ol {
        margin: 0;
        padding: 0 0 0 18px;
        max-height: 280px;
        overflow: auto;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 999px;
        padding: 6px 10px;
      }
      .pill b {
        color: var(--brand);
      }

      .countdown {
        font-size: 22px;
        font-weight: 800;
        color: var(--brand);
      }
    </style>
  </head>
  <body>
    <div class="card" id="app">
      <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© / Ø§Ù„Ù„ÙˆØ¨ÙŠ -->
      <div id="screen-lobby">
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</h1>
        <p class="muted">
          Ø§Ù†Ø¶Ù… Ø¯Ù„ÙˆÙ‚ØªÙŠ ÙˆØ§Ø³ØªØ¹Ø¯.. Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù‡ØªØ¨Ø¯Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù…Ø§ ÙŠÙˆØµÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
          Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ğŸ¯
        </p>
        <div class="row" style="margin: 10px 0 14px">
          <div class="field">
            <label for="name">Ø§Ø³Ù…Ùƒ:</label>
            <input id="playerName" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
          </div>
          <button class="btn" id="joinBtn">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
        </div>

        <div class="pill" style="margin: 8px 0">
          <span>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†: <b id="playersCount">0</b></span>
          <span style="width: 8px"></span>
          <span>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©: <b id="minPlayersPill">--</b></span>
        </div>

        <div id="lobbyStatus" class="center" style="margin: 10px 0 8px"></div>
        <div class="countdown center" id="lobbyCountdown"></div>

        <div class="board" style="margin-top: 12px">
          <h3>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h3>
          <ol id="playersList"></ol>
        </div>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© -->
      <div id="screen-quiz" style="display: none">
        <div class="two-col">
          <div>
            <div id="timer">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„: -- Ø«Ø§Ù†ÙŠØ©</div>
            <h2 id="questionText"></h2>
            <div id="message"></div>
            <div class="options" id="options"></div>
          </div>
          <div class="board">
            <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
            <ol id="leaderboardList"></ol>
          </div>
        </div>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© -->
      <div id="screen-end" style="display: none">
        <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸ‰</h2>
        <p class="muted">Ù†ØªÙŠØ¬ØªÙƒ: <b id="finalScore">0</b></p>
        <div class="board">
          <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
          <ol id="finalBoard"></ol>
        </div>
        <div class="center" style="margin-top: 12px">
          <button class="btn" onclick="location.reload()">
            Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        onValue,
        onDisconnect,
        serverTimestamp,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // ===== 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ) =====
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };
      const appFB = initializeApp(firebaseConfig);
      const db = getDatabase(appFB);

      // ===== 2) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (ØºÙŠØ±ÙŠÙ‡Ø§ Ø¨Ø±Ø§Ø­ØªÙƒ) =====
      const MIN_PLAYERS = 2; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯
      const LOBBY_COUNTDOWN_SECONDS = 20; // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù„ÙˆØ¨ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
      const TIME_PER_QUESTION = 15; // Ø«ÙˆØ§Ù†ÙŠ Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„

      document.getElementById("minPlayersPill").textContent = MIN_PLAYERS;

      // ===== 3) Ø£ØµÙˆØ§Øª Ù…Ø­Ø³Ù‘Ù†Ø© =====
      const sndCorrect = new Audio(
        "https://cdn.pixabay.com/audio/2022/03/15/audio_6f2aa2f2df.mp3"
      );
      const sndWrong = new Audio(
        "https://cdn.pixabay.com/audio/2022/03/15/audio_3f0a9a5e17.mp3"
      );
      const sndTick = new Audio(
        "https://cdn.pixabay.com/audio/2022/03/15/audio_9c1d2b1a4d.mp3"
      ); // ØªÙŠÙƒ Ø®ÙÙŠÙ
      const sndTimeUp = new Audio(
        "https://cdn.pixabay.com/audio/2022/03/15/audio_1b5b8b5a3b.mp3"
      );

      // Ù„Ù…Ù†Ø¹ Ø­Ø¸Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
      const unlockAudio = () => {
        [sndCorrect, sndWrong, sndTick, sndTimeUp].forEach((a) => {
          a.muted = false;
          a.play()
            .then(() => a.pause())
            .catch(() => {});
        });
        document.removeEventListener("click", unlockAudio);
      };
      document.addEventListener("click", unlockAudio);

      // ===== 4) Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© (Ù…Ø«Ø§Ù„) =====
      const QUESTIONS = [
        {
          q: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ",
          opts: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø§Ù„Ø¬ÙŠØ²Ø©"],
          a: "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©",
        },
        {
          q: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠ Ù‡ÙˆØŸ",
          opts: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø²Ø­Ù„"],
          a: "Ø§Ù„Ù…Ø´ØªØ±ÙŠ",
        },
        {
          q: "Ù„ØºØ© Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø£Ø´Ù‡Ø± Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©ØŸ",
          opts: ["Python", "JavaScript", "C++", "Java"],
          a: "JavaScript",
        },
        {
          q: "Ø£Ø³Ø±Ø¹ Ø­ÙŠÙˆØ§Ù† Ø¨Ø±ÙŠØŸ",
          opts: ["Ø§Ù„ÙÙ‡Ø¯", "Ø§Ù„Ø£Ø³Ø¯", "Ø§Ù„Ø¸Ø¨ÙŠ", "Ø§Ù„Ù†Ù…Ø±"],
          a: "Ø§Ù„ÙÙ‡Ø¯",
        },
        { q: "Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠØŸ", opts: ["7", "8", "9", "10"], a: "8" },
      ];

      // ===== 5) Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ =====
      let playerId = null;
      let playerName = "";
      let score = 0;
      let qIndex = 0;
      let currentTimer = null;
      let shuffled = [];

      const el = (sel) => document.querySelector(sel);
      const screenLobby = el("#screen-lobby");
      const screenQuiz = el("#screen-quiz");
      const screenEnd = el("#screen-end");

      // ===== 6) Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù„ÙˆØ¨ÙŠ ÙˆØ¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
      const statusRef = ref(db, "liveQuiz/status");
      const lobbyRef = ref(db, "liveQuiz");
      const playersRef = ref(db, "liveQuiz/players");

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
      onValue(playersRef, (snap) => {
        const data = snap.val() || {};
        const list = Object.values(data);
        el("#playersCount").textContent = list.length;
        el("#playersList").innerHTML = list
          .map((p) => `<li>${escapeHtml(p.name || "Ù„Ø§Ø¹Ø¨")}</li>`)
          .join("");

        // ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: Ù„Ùˆ Ø§Ù„Ø­Ø§Ù„Ø© waiting ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ØŒ ÙØ¹Ù‘Ù„ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        onValue(
          statusRef,
          (stSnap) => {
            const status = stSnap.val() || "waiting";
            if (status === "waiting" && list.length >= MIN_PLAYERS) {
              // Ø§Ø³ØªØ®Ø¯Ù… transaction Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø³Ø¨Ø§Ù‚Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ÙŠÙ†
              runTransaction(ref(db, "liveQuiz/status"), (curr) => {
                if (curr === "waiting" || curr === null) {
                  return "countdown";
                }
                return curr;
              }).then((res) => {
                if (res.committed && res.snapshot.val() === "countdown") {
                  // Ø®Ø²Ù†ÙŠ ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                  update(lobbyRef, {
                    lobbyCountdownStartsAt: serverTimestamp(),
                  });
                }
              });
            }
          },
          { onlyOnce: true }
        );
      });

      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
      onValue(lobbyRef, (snap) => {
        const data = snap.val() || {};
        const status = data.status || "waiting";
        const startsAt = data.lobbyCountdownStartsAt;

        if (status === "waiting") {
          showLobbyMsg("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ùˆ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯â€¦");
          el("#lobbyCountdown").textContent = "";
        }
        if (status === "countdown") {
          showLobbyMsg("ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„:");
          startLobbyCountdown(startsAt);
        }
        if (status === "started") {
          startQuiz();
        }
        if (status === "ended") {
          showEnd();
        }
      });

      // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ø¹Ù„Ù‰ Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
      let lobbyTicker = null;
      function startLobbyCountdown(startsAt) {
        if (!startsAt) {
          return;
        }
        clearInterval(lobbyTicker);
        lobbyTicker = setInterval(() => {
          const startMs =
            typeof startsAt === "number"
              ? startsAt
              : startsAt[".sv"]
              ? Date.now()
              : startsAt;
          const endAt = startMs + LOBBY_COUNTDOWN_SECONDS * 1000;
          const remain = Math.max(0, Math.floor((endAt - Date.now()) / 1000));
          el("#lobbyCountdown").textContent = remain + " Ø«Ø§Ù†ÙŠØ©";
          if (remain <= 0) {
            clearInterval(lobbyTicker);
            // Ø±ÙØ¹ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ started (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            runTransaction(statusRef, (curr) => {
              if (curr === "countdown") {
                return "started";
              }
              return curr;
            }).then((res) => {
              if (res.committed && res.snapshot.val() === "started") {
                update(lobbyRef, { quizStartsAt: serverTimestamp() });
              }
            });
          }
        }, 200);
      }

      function showLobbyMsg(msg) {
        el("#lobbyStatus").textContent = msg;
      }

      // ===== 7) Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… =====
      el("#joinBtn").addEventListener("click", async () => {
        const nameInput = el("#playerName");
        playerName = (nameInput.value || "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„").trim();
        if (!playerName) {
          playerName = "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";
        }

        // Ø³Ø¬Ù‘Ù„ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨
        const newKey = push(playersRef).key;
        playerId = newKey;
        await set(ref(db, `liveQuiz/players/${playerId}`), {
          name: playerName,
          score: 0,
          joinedAt: serverTimestamp(),
          lastSeen: serverTimestamp(),
        });
        onDisconnect(ref(db, `liveQuiz/players/${playerId}`)).remove();

        el("#joinBtn").disabled = true;
        showLobbyMsg("ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… âœ”ï¸ â€” Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©â€¦");
      });

      // ===== 8) Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø§Ù„Ù„Ø§Ø¹Ø¨ =====
      function startQuiz() {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ù„ÙŠ
        score = 0;
        qIndex = 0;
        shuffled = shuffle(QUESTIONS);
        screenLobby.style.display = "none";
        screenEnd.style.display = "none";
        screenQuiz.style.display = "block";
        nextQuestion();
        // Ø§Ø³ØªÙ…Ø¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø·ÙˆØ§Ù„ Ø§Ù„ÙˆÙ‚Øª
        onValue(playersRef, (snap) => {
          const data = snap.val() || {};
          const arr = Object.values(data).sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );
          el("#leaderboardList").innerHTML = arr
            .map(
              (p) =>
                `<li>${escapeHtml(p.name || "Ù„Ø§Ø¹Ø¨")} - ${p.score || 0}</li>`
            )
            .join("");
        });
      }

      function shuffle(arr) {
        return arr.slice().sort(() => Math.random() - 0.5);
      }

      function nextQuestion() {
        if (qIndex >= shuffled.length) {
          return finishQuiz();
        }
        const q = shuffled[qIndex];
        el("#questionText").textContent = q.q;
        el("#message").textContent = "";
        const opts = shuffle(q.opts);
        const wrap = el("#options");
        wrap.innerHTML = "";
        opts.forEach((op) => {
          const div = document.createElement("div");
          div.className = "option";
          div.textContent = op;
          div.onclick = () => selectAnswer(op === q.a);
          wrap.appendChild(div);
        });

        startQuestionTimer(() => {
          // Ù„Ù…Ø§ ÙŠØ®Ù„Øµ Ø§Ù„ÙˆÙ‚Øª
          sndTimeUp.play().catch(() => {});
          selectAnswer(false, true); // ØªØ¹ØªØ¨Ø±Ù‡Ø§ ØºÙ„Ø·
        });
      }

      function startQuestionTimer(onElapsed) {
        clearInterval(currentTimer);
        let remain = TIME_PER_QUESTION;
        el("#timer").textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„: ${remain} Ø«Ø§Ù†ÙŠØ©`;
        currentTimer = setInterval(() => {
          remain--;
          if (remain < 0) remain = 0;
          el("#timer").textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„: ${remain} Ø«Ø§Ù†ÙŠØ©`;
          sndTick
            .play()
            .then(() => {
              sndTick.pause();
              sndTick.currentTime = 0;
            })
            .catch(() => {});
          if (remain <= 0) {
            clearInterval(currentTimer);
            onElapsed && onElapsed();
          }
        }, 1000);
      }

      function selectAnswer(correct, timeUp = false) {
        clearInterval(currentTimer);
        if (correct) {
          score++;
          el("#message").textContent = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
          el("#message").style.color = "green";
          sndCorrect.play().catch(() => {});
        } else {
          el("#message").textContent = timeUp
            ? "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª â°"
            : "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© âŒ";
          el("#message").style.color = "#d00";
          sndWrong.play().catch(() => {});
        }
        // Ø­Ø¯Ù‘Ø« Ù†ØªÙŠØ¬ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        if (playerId) {
          update(ref(db, `liveQuiz/players/${playerId}`), {
            score,
            lastSeen: serverTimestamp(),
          });
        }
        qIndex++;
        setTimeout(nextQuestion, 900);
      }

      function finishQuiz() {
        screenQuiz.style.display = "none";
        screenEnd.style.display = "block";
        el("#finalScore").textContent = `${score} / ${shuffled.length}`;
        // Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        onValue(
          playersRef,
          (snap) => {
            const data = snap.val() || {};
            const arr = Object.values(data).sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );
            el("#finalBoard").innerHTML = arr
              .map(
                (p) =>
                  `<li>${escapeHtml(p.name || "Ù„Ø§Ø¹Ø¨")} - ${p.score || 0}</li>`
              )
              .join("");
          },
          { onlyOnce: true }
        );

        // Ù„Ùˆ Ø£Ø±Ø¯ØªÙ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙÙŠ
      }

      function showEnd() {
        // Ø§Ø³ØªÙØ¯Ø¹ÙŠØª Ø¹Ù†Ø¯Ù…Ø§ admin/Ø§Ù„ØªØ²Ø§Ù…Ù† Ø£Ù†Ù‡Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        if (screenQuiz.style.display !== "none") {
          finishQuiz();
        } else {
          screenLobby.style.display = "none";
          screenEnd.style.display = "block";
        }
      }

      // ===== Ø£Ø¯ÙˆØ§Øª =====
      function escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      // ===== (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø²Ø± Ø¥Ø¯Ø§Ø±ÙŠ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ =====
      // Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø§ÙƒØªØ¨ÙŠ ÙÙŠ ÙƒÙˆÙ†Ø³ÙˆÙ„ Ø§Ù„Ù…ØªØµÙØ­:
      //   firebaseStart()
      // ÙˆÙ„Ù„Ø¥Ù†Ù‡Ø§Ø¡:
      //   firebaseEnd()
      window.firebaseStart = async () => {
        await set(statusRef, "countdown");
        await update(lobbyRef, { lobbyCountdownStartsAt: serverTimestamp() });
      };
      window.firebaseEnd = async () => {
        await set(statusRef, "ended");
      };
    </script>
  </body>
</html>
