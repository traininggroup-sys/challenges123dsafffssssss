<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
      :root {
        --brand: #ff5722;
        --brand2: #ff8a50;
        --card: #fff;
        --muted: #67748e;
        --ok: #1faa59;
        --bad: #e53935;
        --bg1: #071426;
        --bg2: #0b2b46;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Cairo", sans-serif;
        color: #0d1b2a;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, var(--bg1), var(--bg2));
        padding: 18px;
      }
      .app {
        width: 100%;
        max-width: 1150px;
        overflow: hidden;
        border-radius: 16px;
        background: linear-gradient(180deg, #fff, #fafafa);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 20px;
        color: #fff;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }
      header h1 {
        margin: 0;
        font-size: 18px;
      }
      header .sub {
        opacity: 0.95;
        font-size: 13px;
      }

      main {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 16px;
        padding: 18px;
      }
      @media (max-width: 980px) {
        main {
          grid-template-columns: 1fr;
        }
        .aside {
          order: 2;
        }
      }

      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      }
      .welcome {
        display: grid;
        gap: 12px;
        place-items: center;
        padding: 28px;
      }
      .input {
        width: 100%;
        max-width: 320px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #eee;
        outline: none;
        font-size: 16px;
      }
      .btn {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
        transition: 0.15s transform, 0.15s box-shadow;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.1);
      }
      .meta {
        color: var(--muted);
        font-size: 13px;
      }

      .question {
        font-size: 20px;
        margin: 10px 0 6px;
      }
      .options {
        display: grid;
        gap: 10px;
      }
      .option {
        background: #f6f8fa;
        padding: 12px;
        border-radius: 12px;
        text-align: center;
        font-weight: 800;
        border: 2px solid transparent;
        cursor: pointer;
        transition: 0.16s;
      }
      .option:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      }
      .option.correct {
        background: #e8f8ef;
        border-color: var(--ok);
      }
      .option.wrong {
        background: #ffecec;
        border-color: var(--bad);
      }

      /* Ø§Ù„Ø£Ø³Ø§Ø³ */
      #question {
        font-size: 1.5rem;
        margin-bottom: 15px;
        text-align: center;
        line-height: 1.6;
      }

      .option-btn {
        display: block;
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        font-size: 1rem;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s;
      }

      /* Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
      @media (max-width: 600px) {
        #question {
          font-size: 1.2rem; /* Ø®Ø· Ø£ØµØºØ± Ø´ÙˆÙŠØ© Ø¹Ù„Ø´Ø§Ù† ÙŠØ¯Ø®Ù„ */
          padding: 0 10px;
        }

        .option-btn {
          font-size: 0.95rem;
          padding: 10px;
        }
      }

      .progress {
        height: 10px;
        background: #eee;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }

      .timerWrap {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .circle {
        width: 74px;
        height: 74px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-weight: 900;
        color: var(--brand);
        background: conic-gradient(var(--brand) 0deg, #eee 0deg);
      }
      @media (max-width: 600px) {
        .circle {
          width: 60px;
          height: 60px;
          font-size: 14px;
        }
        .options {
          gap: 6px;
        }
      }

      .leaders {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .leader {
        background: linear-gradient(180deg, #fff, #fafafa);
        border-radius: 12px;
        padding: 10px;
        display: grid;
        grid-template-columns: 32px 1fr auto;
        gap: 10px;
        align-items: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        font-weight: 800;
      }
      .leader .bar {
        height: 8px;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 6px;
      }
      .leader .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
      }
      .crown {
        font-size: 18px;
      }
      .rank1 {
        background: linear-gradient(90deg, #ffd700, #ffcf5b);
      }
      .rank2 {
        background: linear-gradient(90deg, #c0c0c0, #e6e6e6);
      }
      .rank3 {
        background: linear-gradient(90deg, #cd7f32, #e0a67a);
      }

      .center {
        text-align: center;
      }
      .hidden {
        display: none;
      }
      footer {
        text-align: center;
        padding: 14px;
        font-size: 13px;
        color: #fff;
        background: linear-gradient(90deg, var(--brand), var(--brand2));
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      #winnerPopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: #fff;
        padding: 28px 36px;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 9999;
        transition: transform 0.3s ease;
      }
      #winnerPopup.show {
        transform: translate(-50%, -50%) scale(1);
      }
      #winnerPopup h2 {
        font-size: 24px;
        margin: 0 0 12px;
        color: var(--brand);
      }
      #winnerPopup p {
        font-size: 18px;
        margin: 0;
        font-weight: 700;
      }
      #winnerOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 9998;
      }
      #winnerOverlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      #winnerPopup button {
        margin-top: 18px;
        padding: 10px 20px;
        border: none;
        background: var(--brand);
        color: #fff;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
      }
      #winnerPopup button:hover {
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="app" role="application">
      <header>
        <div>
          <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</h1>
          <div class="sub" id="topicLabel">Ø§Ù„Ù…Ø­ÙˆØ±: Ø¹Ø§Ù…</div>
        </div>
        <div class="sub">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="statusShort">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±</span></div>
      </header>

      <main>
        <section>
          <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
          <div id="welcomeCard" class="card welcome">
            <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</h2>
            <p class="meta">
              Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø¶ØºØ· Ù…Ø´Ø§Ø±ÙƒØ©. ØªØ¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ø¯Ø¯ 2
              Ù…ØªØ³Ø§Ø¨Ù‚ Ù„Ù„ØªØ¬Ø±Ø¨Ø©.
            </p>
            <input
              id="nameInput"
              class="input"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯)"
            />
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 8px;
              "
            >
              <button id="joinBtn" class="btn">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
            </div>
            <div class="meta" style="margin-top: 8px">
              Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†: <b id="playersCount">0</b>
            </div>

            <div id="waitingBox" class="card" style="margin-top: 10px">
              <div class="meta" id="waitingText">
                ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ â€” Ø§Ù„Ø¢Ù† 0 / 2
              </div>
              <div class="progress" style="margin-top: 8px">
                <i id="waitingProgress"></i>
              </div>
            </div>
          </div>

          <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© -->
          <div id="quizCard" class="card hidden">
            <div class="row">
              <div style="flex: 1">
                <div class="meta" id="progressText">Ø³Ø¤Ø§Ù„ 0 / 0</div>
                <div id="questionText" class="question">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
                <div class="progress" style="margin-top: 8px">
                  <i id="qProgress"></i>
                </div>
              </div>
              <div class="timerWrap">
                <div class="circle" id="circleTimer">--</div>
                <div style="text-align: right">
                  <div class="meta">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„</div>
                  <div
                    id="timeText"
                    style="font-weight: 900; color: var(--brand)"
                  >
                    --
                  </div>
                </div>
              </div>
            </div>

            <div id="options" class="options" style="margin-top: 12px"></div>
            <div
              id="feedback"
              class="meta"
              style="margin-top: 8px; min-height: 20px"
            ></div>

            <div id="doneBox" class="card hidden" style="margin-top: 12px">
              <div class="center">
                <strong>âœ… Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ.</strong>
                <div class="meta" style="margin-top: 6px">
                  Ø§Ù†ØªØ¸Ø± Ø²Ù…Ù„Ø§Ø¦Ùƒ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.
                </div>
              </div>
            </div>

            <!-- Ø²Ø± Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ -->
            <div style="margin-top: 12px; text-align: center">
              <button id="leaveBtn" class="btn" style="background: crimson">
                Ø§Ù†Ø³Ø­Ø§Ø¨
              </button>
            </div>
          </div>
        </section>

        <!-- Ø¬Ø§Ù†Ø¨: ØªØ±ØªÙŠØ¨ Ù…Ø¨Ø§Ø´Ø± -->
        <aside class="aside">
          <div class="card">
            <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
            <ol id="leaderList" class="leaders" style="margin-top: 10px"></ol>
            <div class="meta" style="margin-top: 8px">
              ÙŠØ´Ù…Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
            </div>
          </div>

          <div class="card" style="margin-top: 12px">
            <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
            <div class="meta">Ø§Ù„Ø­Ø§Ù„Ø©: <b id="statusLabel">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±</b></div>
            <div style="margin-top: 6px" class="meta">
              Ø§Ù„Ù…ØªØµØ¯Ø±: <b id="topBadge">â€”</b>
            </div>
          </div>
        </aside>
      </main>
      <div id="winnerOverlay"></div>
      <div id="winnerPopup">
        <h2>ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ!</h2>
        <p id="winnerName">â€”</p>
        <p id="winnerScore">â€” Ù†Ù‚Ø§Ø·</p>
        <button id="closeWinnerPopup">Ø§ØºÙ„Ø§Ù‚</button>
      </div>
      <button
        id="newGameBtn"
        class="btn hidden"
        style="margin: 10px auto; display: block"
      >
        Ø§Ø¨Ø¯Ø£ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
      </button>

      <footer>Â© Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ù„ØªØ¯Ø±ÙŠØ¨</footer>
    </div>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      /* ========== Firebase ========== */
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.appspot.com",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const liveRef = db.ref("liveQuiz");
      const playersRef = db.ref("liveQuiz/players");

      /* ========== Ø£Ø³Ø¦Ù„Ø© (Ù…Ø«Ø§Ù„) ========== */
      const QUESTIONS = [
        {
          q: "Ø§Ù„Ø±ÙØ¹ ÙÙŠ Ø§Ù„Ø£ÙØ¹Ø§Ù„ ÙŠÙ†ÙØ±Ø¯ Ø¹Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù€ .............",
          opts: ["Ø§Ù„ÙˆØ§Ùˆ", "Ø§Ù„Ø£Ù„Ù", "Ø«Ø¨ÙˆØª Ø§Ù„Ù†ÙˆÙ†"],
          a: 2,
        },
        {
          q: "Ø±Ø£ÙŠØªÙ ................. Ø§Ù„Ø£Ø·ÙØ§Ù„",
          opts: ["Ù‡Ø¤Ù„Ø§Ø¡Ù", "Ù‡Ø¤Ù„Ø§Ø¡Ù", "Ù‡Ø¤Ù„Ø§Ø¡Ù"],
          a: 1,
        },
        {
          q: "ØµØ¯ÙŠÙ‚ÙŠ ÙŠØªØ­Ø¯Ø« Ø¨Ù€ ...........",
          opts: ["Ø£Ù„Ø§Ø´Ø§Ø±Ø©", "Ø§Ù„Ø¥Ø´Ø§Ø±Ø©", "Ø¥Ù„Ø¥Ø´Ø§Ø±Ø©"],
          a: 1,
        },
      ];

      const REQUIRED_PLAYERS = 2;
      const PER_QUESTION_SECONDS = 15;

      /* ========== Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© ========== */
      const $ = (s) => document.querySelector(s);
      const welcomeCard = $("#welcomeCard"),
        joinBtn = $("#joinBtn"),
        nameInput = $("#nameInput"),
        playersCount = $("#playersCount");
      const waitingBox = $("#waitingBox"),
        waitingText = $("#waitingText"),
        waitingProgress = $("#waitingProgress");
      const quizCard = $("#quizCard"),
        questionText = $("#questionText"),
        optionsWrap = $("#options"),
        feedback = $("#feedback");
      const progressText = $("#progressText"),
        qProgress = $("#qProgress"),
        statusShort = $("#statusShort"),
        statusLabel = $("#statusLabel");
      const circleTimer = $("#circleTimer"),
        timeText = $("#timeText"),
        doneBox = $("#doneBox");
      const leaderList = $("#leaderList"),
        topBadge = $("#topBadge");
      const newGameBtn = $("#newGameBtn");

      let playerId = null,
        playerName = "",
        localScore = 0,
        localIndex = 0,
        questionTimer = null,
        questionDeadline = null,
        started = false;

      /* ========== WebAudio ========== */
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      let ctx = new AudioCtx();
      let audioUnlocked = false;
      function unlockAudio() {
        if (audioUnlocked) return;
        ctx
          .resume()
          .then(() => (audioUnlocked = true))
          .catch(() => {});
      }
      document.addEventListener("click", unlockAudio, { once: true });

      /* ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£ØµÙˆØ§Øª ========== */
      function beep({ freq = 600, type = "sine", ms = 200, gain = 0.06 } = {}) {
        try {
          const osc = ctx.createOscillator();
          const g = ctx.createGain();
          osc.type = type;
          osc.frequency.value = freq;
          g.gain.value = gain;
          osc.connect(g);
          g.connect(ctx.destination);
          osc.start();
          setTimeout(() => osc.stop(), ms);
        } catch (e) {}
      }
      const sfx = {
        start: () => beep({ freq: 900, type: "triangle", ms: 200 }),
        correct: () => {
          beep({ freq: 880, type: "sine", ms: 140 });
          setTimeout(() => beep({ freq: 1200, type: "sine", ms: 180 }), 120);
        },
        wrong: () => beep({ freq: 220, type: "sawtooth", ms: 260 }),
        tick: () => beep({ freq: 520, type: "square", ms: 60, gain: 0.03 }),
        win: () => {
          [880, 990, 1180, 1320].forEach((f, i) =>
            setTimeout(() => beep({ freq: f, type: "sine", ms: 160 }), i * 140)
          );
        },
      };
      function stopAllSounds() {
        try {
          if (ctx && ctx.state !== "closed") ctx.suspend();
        } catch (e) {}
      }

      /* ========== Ø§Ù†Ø¶Ù…Ø§Ù… ========== */
      joinBtn.addEventListener("click", async () => {
        unlockAudio();
        const name =
          (nameInput.value || "").trim() ||
          "Ù„Ø§Ø¹Ø¨_" + Math.floor(Math.random() * 900 + 100);
        playerName = name;
        const key = playersRef.push().key;
        playerId = key;
        await db
          .ref(`liveQuiz/players/${playerId}`)
          .set({
            name: playerName,
            score: 0,
            currentQuestion: 0,
            finished: false,
            joinedAt: Date.now(),
          });
        db.ref(`liveQuiz/players/${playerId}`).onDisconnect().remove();
        welcomeCard.classList.add("hidden");
        const live = (await liveRef.once("value")).val() || {};
        if (live.status === "started") {
          started = true;
          startGame();
        }
      });

      /* ========== Ø¨Ø¯Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ========== */
      playersRef.on("value", async (snap) => {
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([id, v]) => ({ id, ...v }));
        playersCount.innerText = arr.length;
        const pct = Math.min(
          100,
          Math.round((arr.length / REQUIRED_PLAYERS) * 100)
        );
        waitingProgress.style.width = pct + "%";
        waitingText.innerText = `ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ â€” Ø§Ù„Ø¢Ù† ${arr.length} / ${REQUIRED_PLAYERS}`;
        renderLeaders(arr);
        const live = (await liveRef.once("value")).val() || {};
        if (arr.length >= REQUIRED_PLAYERS && live.status === "waiting")
          await liveRef.update({ status: "started", startedAt: Date.now() });
        if (playerId && !started && arr.length >= REQUIRED_PLAYERS) {
          started = true;
          startGame();
        }
      });

      /* ========== Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ========== */
      liveRef.on("value", (snap) => {
        const val = snap.val() || {};
        const st = val.status || "waiting";
        statusShort.innerText =
          st === "started" ? "Ø¨Ø¯Ø£Øª" : st === "ended" ? "Ø§Ù†ØªÙ‡Øª" : "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±";
        statusLabel.innerText = statusShort.innerText;
        if (st === "started" && !started && playerId) {
          started = true;
          startGame();
        }
        if (st === "ended" && !val.announced) {
          showWinner(val.winnerName || "Ù„Ø§Ø¹Ø¨", val.winnerScore || 0);
          liveRef.update({ announced: true });
          sfx.win();
          newGameBtn.classList.remove("hidden");
        }
      });

      /* ========== Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ========== */
      function startGame() {
        localScore = 0;
        localIndex = 0;
        quizCard.classList.remove("hidden");
        welcomeCard.classList.add("hidden");
        sfx.start();
        renderQuestion();
      }

      /* ========== Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ ========== */
      function startQuestionTimer(totalSec = PER_QUESTION_SECONDS) {
        stopQuestionTimer();
        questionDeadline = Date.now() + totalSec * 1000;
        questionTimer = setInterval(() => {
          const remain = Math.max(
            0,
            Math.ceil((questionDeadline - Date.now()) / 1000)
          );
          timeText.innerText = remain + " Ø«";
          const elapsed =
            PER_QUESTION_SECONDS * 1000 -
            Math.max(0, questionDeadline - Date.now());
          const pct = Math.min(
            100,
            Math.round((elapsed / (PER_QUESTION_SECONDS * 1000)) * 100)
          );
          circleTimer.style.background = `conic-gradient(var(--brand) ${
            pct * 3.6
          }deg,#eee ${pct * 3.6}deg)`;
          circleTimer.innerText = remain;
          if (remain <= 5 && remain > 0) sfx.tick();
          if (remain <= 0) {
            stopQuestionTimer();
            nextQuestion();
          }
        }, 200);
      }
      function stopQuestionTimer() {
        if (questionTimer) {
          clearInterval(questionTimer);
          questionTimer = null;
        }
      }

      /* ========== Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„/Ø¥Ø¬Ø§Ø¨Ø§Øª ========== */
      let optionLock = false;
      function renderQuestion() {
        feedback.innerText = "";
        doneBox.classList.add("hidden");
        if (localIndex >= QUESTIONS.length) {
          finishLocal();
          return;
        }
        const q = QUESTIONS[localIndex];
        questionText.innerText = q.q;
        optionsWrap.innerHTML = "";
        optionLock = false;
        progressText.innerText = `Ø³Ø¤Ø§Ù„ ${localIndex + 1} / ${QUESTIONS.length}`;
        qProgress.style.width =
          Math.round((localIndex / QUESTIONS.length) * 100) + "%";
        const opts = q.opts
          .map((o, i) => ({ o, i }))
          .sort(() => Math.random() - 0.5);
        opts.forEach(({ o, i }) => {
          const div = document.createElement("div");
          div.className = "option";
          div.innerText = o;
          div.onclick = async () => {
            if (optionLock) return;
            optionLock = true;
            if (i === q.a) {
              div.classList.add("correct");
              feedback.innerText = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
              sfx.correct();
              await db
                .ref(`liveQuiz/players/${playerId}/score`)
                .transaction((s) => (s || 0) + 1);
            } else {
              div.classList.add("wrong");
              feedback.innerText = `Ø®Ø·Ø£ âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.opts[q.a]}`;
              sfx.wrong();
              Array.from(optionsWrap.children).forEach((c) => {
                if (c.innerText === q.opts[q.a]) c.classList.add("correct");
              });
            }
            await db
              .ref(`liveQuiz/players/${playerId}`)
              .update({ currentQuestion: localIndex + 1 });
            setTimeout(() => nextQuestion(), 900);
          };
          optionsWrap.appendChild(div);
        });
        startQuestionTimer(PER_QUESTION_SECONDS);
      }
      function nextQuestion() {
        stopQuestionTimer();
        localIndex++;
        renderQuestion();
      }

      /* ========== Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ========== */
      async function finishLocal() {
        stopQuestionTimer();
        optionsWrap.innerHTML = "";
        feedback.innerText = "Ø§Ù†ØªÙ‡ÙŠØª â€” Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©";
        doneBox.classList.remove("hidden");
        if (playerId)
          await db
            .ref(`liveQuiz/players/${playerId}`)
            .update({ finished: true });
        const snap = await playersRef.once("value");
        const data = snap.val() || {};
        const arr = Object.values(data);
        if (arr.length > 0 && arr.every((p) => p.finished)) {
          await liveRef.update({ status: "ended", endedAt: Date.now() });
          finalize();
        }
      }

      /* ========== ØªØ±ØªÙŠØ¨ Ù…Ø¨Ø§Ø´Ø± ========== */
      function renderLeaders(list) {
        const arr = list
          .slice()
          .sort((a, b) => (b.score || 0) - (a.score || 0));
        leaderList.innerHTML = "";
        let lastScore = null,
          rank = 0,
          sameRankCount = 0;
        arr.forEach((p, i) => {
          const li = document.createElement("li");
          li.className = "leader";
          if (p.score !== lastScore) {
            rank = rank + 1 + sameRankCount;
            sameRankCount = 0;
          } else sameRankCount++;
          lastScore = p.score;
          if (rank === 1) li.classList.add("rank1");
          if (rank === 2) li.classList.add("rank2");
          if (rank === 3) li.classList.add("rank3");
          const crown = rank === 1 ? "ğŸ‘‘" : rank;
          const name = (p.name || "Ù„Ø§Ø¹Ø¨").toString();
          const score = p.score || 0;
          const pct = Math.min(
            100,
            Math.round((score / Math.max(1, QUESTIONS.length)) * 100)
          );
          li.innerHTML = `<div class="crown">${crown}</div><div><div>${escapeHtml(
            name
          )}</div><div class="bar"><i style="width:${pct}%"></i></div></div><div>${score} Ù†Ù‚Ø·Ø©</div>`;
          leaderList.appendChild(li);
        });
        const highestScore = arr.length ? arr[0].score : 0;
        const winners = arr.filter((p) => p.score === highestScore);
        topBadge.innerText =
          winners.map((p) => p.name || "Ù„Ø§Ø¹Ø¨").join(" Ùˆ ") +
          ` (${highestScore})`;
      }

      /* ========== popup Ø§Ù„ÙØ§Ø¦Ø² ========== */
      const winnerPopup = $("#winnerPopup");
      const winnerOverlay = $("#winnerOverlay");
      const winnerNameEl = $("#winnerName");
      const winnerScoreEl = $("#winnerScore");
      const closeWinnerBtn = $("#closeWinnerPopup");
      function showWinner(name, score) {
        winnerNameEl.innerText = name || "Ù„Ø§Ø¹Ø¨";
        winnerScoreEl.innerText = (score != null ? score : 0) + " Ù†Ù‚Ø·Ø©";
        winnerOverlay.classList.add("show");
        winnerPopup.classList.add("show");
      }
      function hideWinner() {
        winnerOverlay.classList.remove("show");
        winnerPopup.classList.remove("show");
      }
      closeWinnerBtn.addEventListener("click", hideWinner);
      winnerOverlay.addEventListener("click", hideWinner);

      /* ========== Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù„Ø¹Ø¨Ø© ========== */
      function resetGame() {
        hideWinner();
        started = false;
        playerId = null;
        playerName = "";
        localScore = 0;
        localIndex = 0;
        liveRef.set({
          status: "waiting",
          winnerName: "",
          winnerScore: 0,
          announced: false,
        });
        welcomeCard.classList.remove("hidden");
        quizCard.classList.add("hidden");
        waitingProgress.style.width = "0%";
        waitingText.innerText = `ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ â€” Ø§Ù„Ø¢Ù† 0 / ${REQUIRED_PLAYERS}`;
        leaderList.innerHTML = "";
        topBadge.innerText = "";
        newGameBtn.classList.add("hidden");
      }
      newGameBtn.addEventListener("click", resetGame);

      /* ========== Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© + Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø² ========== */
      async function finalize() {
        try {
          const snap = await playersRef.once("value");
          const data = snap.val() || {};
          const arr = Object.entries(data).map(([id, v]) => ({
            id,
            name: v.name && v.name.trim() !== "" ? v.name : "Ù„Ø§Ø¹Ø¨",
            score: v.score || 0,
          }));
          if (!arr.length) return;
          arr.sort((a, b) => b.score - a.score);
          const highestScore = arr[0].score;
          const winners = arr.filter((p) => p.score === highestScore);
          const winnerNames = winners.map((p) => p.name).join(" Ùˆ ");
          showWinner(winnerNames, highestScore);
          confetti({ particleCount: 250, spread: 80, origin: { y: 0.2 } });
          sfx.win();
          newGameBtn.classList.remove("hidden");
        } catch (e) {
          console.error("Error in finalize:", e);
        }
      }
    </script>
  </body>
</html>
