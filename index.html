<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>مسابقة أعضاء جروب المشتركين للتدريب</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background: #f8f9fa;
        margin: 0;
        text-align: center;
      }
      #container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      #quizScreen,
      #waitingScreen,
      #resultScreen,
      #adminPanel {
        display: none;
      }
      .leaderboard {
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      @media (max-width: 600px) {
        body {
          font-size: 14px;
        }
        button {
          width: 100%;
        }
      }
      #winnerAnimation {
        font-size: 24px;
        font-weight: bold;
        color: #28a745;
        animation: pop 1s infinite alternate;
      }
      @keyframes pop {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.2);
        }
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>مسابقة أعضاء جروب المشتركين للتدريب</h1>
      <div id="joinScreen">
        <p>اكتب اسمك للانضمام:</p>
        <input type="text" id="playerName" placeholder="مثال: محمد" />
        <button id="joinBtn">المشاركة</button>
        <br /><br />
        <button id="adminBtn">🔑 دخول الأدمن</button>
      </div>

      <div id="waitingScreen">
        <h2>بانتظار اكتمال اللاعبين...</h2>
        <p>المطلوب: <span id="requiredPlayersDisplay">5</span></p>
        <p>المتصلين الآن: <span id="currentPlayersCount">0</span></p>
      </div>

      <div id="quizScreen">
        <h2 id="questionText"></h2>
        <div id="answers"></div>
        <p>الزمن المتبقي: <span id="timer">--</span> ثانية</p>
      </div>

      <div id="resultScreen">
        <h2>انتهت المسابقة 🎉</h2>
        <div id="winnerAnimation"></div>
        <div class="leaderboard" id="leaderboard"></div>
      </div>

      <!-- لوحة الأدمن -->
      <div id="adminPanel">
        <h2>لوحة التحكم</h2>
        <label>عدد المشاركين المطلوب:</label>
        <input type="number" id="requiredPlayersInput" min="2" value="5" />
        <button id="saveRequiredPlayers">حفظ</button>
        <button onclick="closeAdmin()">إغلاق</button>
      </div>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        onValue,
        update,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // ✅ Config بتاعك
      const firebaseConfig = {
        apiKey: "AIzaSyDOQ1wpof7OhyRRCD_0Of0RY0jggnHmSJ4",
        authDomain: "test-competion.firebaseapp.com",
        databaseURL: "https://test-competion-default-rtdb.firebaseio.com",
        projectId: "test-competion",
        storageBucket: "test-competion.firebasestorage.app",
        messagingSenderId: "605584028373",
        appId: "1:605584028373:web:9cfc40fad5bf6356dbe85c",
        measurementId: "G-7WEQBFVEJW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let playerName = "";
      let currentQuestion = 0;
      let score = 0;
      let REQUIRED_PLAYERS = 5;
      let timerInterval;

      const questions = [
        {
          q: "ما هي عاصمة مصر؟",
          a: ["القاهرة", "الإسكندرية", "أسوان"],
          correct: 0,
        },
        { q: "2 + 2 = ?", a: ["3", "4", "5"], correct: 1 },
        { q: "ما هو لون البحر؟", a: ["أحمر", "أزرق", "أصفر"], correct: 1 },
      ];

      // ✅ انضمام لاعب
      document.getElementById("joinBtn").onclick = () => {
        playerName = document.getElementById("playerName").value.trim();
        if (!playerName) return alert("اكتب اسمك الأول");

        set(ref(db, "players/" + playerName), { score: 0, finished: false });
        document.getElementById("joinScreen").style.display = "none";
        document.getElementById("waitingScreen").style.display = "block";
      };

      // ✅ متابعة العدد المطلوب من الأدمن
      const settingsRef = ref(db, "settings/requiredPlayers");
      onValue(settingsRef, (snap) => {
        if (snap.exists()) {
          REQUIRED_PLAYERS = snap.val();
          document.getElementById("requiredPlayersDisplay").innerText =
            REQUIRED_PLAYERS;
        }
      });

      // ✅ متابعة اللاعبين وعددهم
      const playersRef = ref(db, "players");
      onValue(playersRef, (snap) => {
        const players = snap.val() || {};
        const count = Object.keys(players).length;
        document.getElementById("currentPlayersCount").innerText = count;

        if (count >= REQUIRED_PLAYERS) {
          startCompetition();
        }

        // ✅ لو كلهم خلصوا → انتهت المسابقة
        const allFinished =
          Object.values(players).length > 0 &&
          Object.values(players).every((p) => p.finished);
        if (allFinished) {
          endCompetition(players);
        }
      });

      function startCompetition() {
        document.getElementById("waitingScreen").style.display = "none";
        document.getElementById("quizScreen").style.display = "block";
        loadQuestion();
      }

      function loadQuestion() {
        if (currentQuestion >= questions.length) {
          // خلصت
          update(ref(db, "players/" + playerName), { score, finished: true });
          document.getElementById("quizScreen").style.display = "none";
          document.getElementById("waitingScreen").style.display = "block";
          document.getElementById("waitingScreen").innerHTML =
            "<h2>لقد انتهيت ✅ برجاء انتظار باقي زملائك...</h2>";
          return;
        }
        const q = questions[currentQuestion];
        document.getElementById("questionText").innerText = q.q;
        const ansDiv = document.getElementById("answers");
        ansDiv.innerHTML = "";
        q.a.forEach((ans, i) => {
          const btn = document.createElement("button");
          btn.innerText = ans;
          btn.onclick = () => {
            if (i === q.correct) score++;
            currentQuestion++;
            loadQuestion();
          };
          ansDiv.appendChild(btn);
        });

        // مؤقت 20 ثانية لكل سؤال
        let time = 20;
        document.getElementById("timer").innerText = time;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          time--;
          document.getElementById("timer").innerText = time;
          if (time <= 0) {
            clearInterval(timerInterval);
            currentQuestion++;
            loadQuestion();
          }
        }, 1000);
      }

      function endCompetition(players) {
        document.getElementById("waitingScreen").style.display = "none";
        document.getElementById("quizScreen").style.display = "none";
        document.getElementById("resultScreen").style.display = "block";

        // ترتيب
        const sorted = Object.entries(players).sort(
          (a, b) => b[1].score - a[1].score
        );
        const winner = sorted[0];
        document.getElementById(
          "winnerAnimation"
        ).innerText = `🎉 الفائز: ${winner[0]} بدرجة ${winner[1].score}`;

        let html = "<h3>الترتيب النهائي:</h3>";
        sorted.forEach(([name, data], i) => {
          html += `<p>${i + 1}- ${name} : ${data.score}</p>`;
        });
        document.getElementById("leaderboard").innerHTML = html;

        // مؤثر صوتي تشجيعي
        const audio = new Audio(
          "https://www.myinstants.com/media/sounds/applause.mp3"
        );
        audio.play();
      }

      // ✅ لوحة الأدمن
      document.getElementById("adminBtn").onclick = () => {
        const pass = prompt("ادخل كلمة سر الأدمن:");
        if (pass === "admin123") {
          document.getElementById("adminPanel").style.display = "block";
        } else alert("كلمة السر خاطئة!");
      };

      document.getElementById("saveRequiredPlayers").onclick = () => {
        const val = parseInt(
          document.getElementById("requiredPlayersInput").value,
          10
        );
        if (val > 1) set(settingsRef, val);
      };

      window.closeAdmin = () => {
        document.getElementById("adminPanel").style.display = "none";
      };
    </script>
  </body>
</html>
