<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>مسابقة أعضاء جروب المشتركين للتدريب</title>
    <style>
      body {
        font-family: "Cairo", sans-serif;
        direction: rtl;
        text-align: center;
      }
      .hidden {
        display: none;
      }
      .card {
        padding: 20px;
        margin: 20px auto;
        border: 1px solid #ccc;
        border-radius: 10px;
        max-width: 400px;
      }
      .progress-bar {
        width: 100%;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
        height: 20px;
        margin: 10px 0;
      }
      .progress {
        height: 100%;
        width: 0%;
        background: #4caf50;
        transition: width 0.3s;
      }
      button {
        padding: 10px 20px;
        border: none;
        background: #2196f3;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      #options button {
        display: block;
        width: 100%;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div id="welcomeCard" class="card">
      <h2>أهلاً بك في المسابقة</h2>
      <input id="nameInput" placeholder="اكتب اسمك هنا" />
      <button id="joinBtn">انضم الآن</button>
      <p>عدد المتسابقين الحالي: <span id="playersCount">0</span></p>
      <div class="progress-bar">
        <div id="waitingProgress" class="progress"></div>
      </div>
      <p id="waitingText">في انتظار اكتمال العدد...</p>
    </div>

    <div id="quizCard" class="card hidden">
      <h3 id="questionText">السؤال هنا</h3>
      <div id="options"></div>
      <p id="feedback"></p>
      <p id="progressText"></p>
      <div class="progress-bar">
        <div id="qProgress" class="progress"></div>
      </div>
      <p>الوقت المتبقي: <span id="timeText"></span> ثانية</p>
    </div>

    <div id="doneBox" class="card hidden">
      <h3>انتهت المسابقة!</h3>
      <p id="leaderList"></p>
      <p id="topBadge"></p>
      <button id="newGameBtn" class="hidden">ابدأ لعبة جديدة</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        // ضع إعدادات Firebase الخاصة بك هنا
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      /* ===================== المتغيرات ===================== */
      const REQUIRED_PLAYERS = 2;
      const PER_QUESTION_SECONDS = 15;

      let playerId = null,
        playerName = "",
        localScore = 0,
        localIndex = 0,
        questionTimer = null,
        started = false;

      const welcomeCard = document.querySelector("#welcomeCard"),
        joinBtn = document.querySelector("#joinBtn"),
        nameInput = document.querySelector("#nameInput"),
        playersCount = document.querySelector("#playersCount"),
        waitingProgress = document.querySelector("#waitingProgress"),
        waitingText = document.querySelector("#waitingText"),
        quizCard = document.querySelector("#quizCard"),
        questionText = document.querySelector("#questionText"),
        optionsWrap = document.querySelector("#options"),
        feedback = document.querySelector("#feedback"),
        progressText = document.querySelector("#progressText"),
        qProgress = document.querySelector("#qProgress"),
        timeText = document.querySelector("#timeText"),
        doneBox = document.querySelector("#doneBox"),
        leaderList = document.querySelector("#leaderList"),
        topBadge = document.querySelector("#topBadge"),
        newGameBtn = document.querySelector("#newGameBtn");

      const liveRef = db.ref("liveQuiz");
      const playersRef = db.ref("liveQuiz/players");

      /* ===================== انضمام ===================== */
      joinBtn.addEventListener("click", async () => {
        const name =
          (nameInput.value || "").trim() ||
          "لاعب_" + Math.floor(Math.random() * 900 + 100);
        playerName = name;
        const key = playersRef.push().key;
        playerId = key;

        await playersRef.child(playerId).set({
          name: playerName,
          score: 0,
          currentQuestion: 0,
          finished: false,
          joinedAt: Date.now(),
        });

        playersRef.child(playerId).onDisconnect().remove();
        welcomeCard.classList.add("hidden");
      });

      /* ===================== متابعة حالة اللاعبين ===================== */
      playersRef.on("value", async (snap) => {
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([id, v]) => ({ id, ...v }));
        playersCount.innerText = arr.length;

        const pct = Math.min(
          100,
          Math.round((arr.length / REQUIRED_PLAYERS) * 100)
        );
        waitingProgress.style.width = pct + "%";
        waitingText.innerText = `في انتظار اكتمال العدد — الآن ${arr.length} / ${REQUIRED_PLAYERS}`;

        renderLeaders(arr);

        // إذا وصل العدد المطلوب و المسابقة ما بدأتش
        const live = (await liveRef.once("value")).val() || {};
        if (arr.length >= REQUIRED_PLAYERS && live.status !== "started") {
          await liveRef.update({ status: "started", startedAt: Date.now() });
        }
      });

      /* ===================== متابعة حالة المسابقة ===================== */
      liveRef.on("value", (snap) => {
        const val = snap.val() || {};
        const st = val.status || "waiting";

        if (st === "started" && !started && playerId) {
          started = true;
          startGame();
        }

        if (st === "ended" && !val.announced) {
          showWinner(val.winnerName || "لاعب", val.winnerScore || 0);
          liveRef.update({ announced: true });
          newGameBtn.classList.remove("hidden");
        }
      });

      /* ===================== بدء اللعبة ===================== */
      function startGame() {
        localScore = 0;
        localIndex = 0;
        quizCard.classList.remove("hidden");
        welcomeCard.classList.add("hidden");
        renderQuestion();
      }

      /* ===================== وظائف أسئلة تجريبية ===================== */
      const questions = [
        {
          q: "ما هو لون السماء؟",
          options: ["أزرق", "أحمر", "أخضر", "أسود"],
          answer: 0,
        },
        { q: "كم عدد أيام الأسبوع؟", options: ["5", "6", "7", "8"], answer: 2 },
      ];

      function renderQuestion() {
        if (localIndex >= questions.length) {
          finishLocal();
          return;
        }
        const q = questions[localIndex];
        questionText.innerText = q.q;
        optionsWrap.innerHTML = "";
        feedback.innerText = "";
        q.options.forEach((opt, i) => {
          const btn = document.createElement("button");
          btn.innerText = opt;
          btn.onclick = () => selectAnswer(i);
          optionsWrap.appendChild(btn);
        });
        progressText.innerText = `السؤال ${localIndex + 1} / ${
          questions.length
        }`;
        qProgress.style.width = (localIndex / questions.length) * 100 + "%";
        startTimer(PER_QUESTION_SECONDS);
      }

      function selectAnswer(i) {
        const correct = questions[localIndex].answer;
        if (i === correct) localScore++;
        localIndex++;
        renderQuestion();
      }

      function startTimer(seconds) {
        let remaining = seconds;
        timeText.innerText = remaining;
        clearInterval(questionTimer);
        questionTimer = setInterval(() => {
          remaining--;
          timeText.innerText = remaining;
          if (remaining <= 0) {
            clearInterval(questionTimer);
            localIndex++;
            renderQuestion();
          }
        }, 1000);
      }

      function finishLocal() {
        quizCard.classList.add("hidden");
        doneBox.classList.remove("hidden");
        playersRef
          .child(playerId)
          .update({ score: localScore, finished: true });
      }

      function renderLeaders(arr) {
        const sorted = arr.sort((a, b) => b.score - a.score);
        leaderList.innerHTML = sorted
          .map((p) => `${p.name}: ${p.score}`)
          .join("<br>");
      }

      function showWinner(name, score) {
        topBadge.innerText = `الفائز: ${name} — النقاط: ${score}`;
      }

      /* ===================== لعبة جديدة ===================== */
      newGameBtn.addEventListener("click", async () => {
        await liveRef.set({ status: "waiting", announced: false });
        await playersRef.remove();
        location.reload();
      });
    </script>
  </body>
</html>
